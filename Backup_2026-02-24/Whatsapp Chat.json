{
  "updatedAt": "2026-02-20T14:23:49.759Z",
  "createdAt": "2025-11-13T11:34:53.834Z",
  "id": "V1GolwUDxcGbl6aY",
  "name": "Whatsapp Chat",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "a2ef0698-a3a2-4cca-954a-43a6ab0d7162",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        5872,
        -1488
      ],
      "id": "b40b9b51-7521-4d2b-826b-8874d1e730de",
      "name": "Webhook",
      "webhookId": "a2ef0698-a3a2-4cca-954a-43a6ab0d7162"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $json.body.To }}"
            },
            {
              "name": "ContentSid",
              "value": "HX67dec374c3290ba042afc2e69e75f8c1"
            },
            {
              "name": "ContentVariables",
              "value": "={\"1\":\"{{ $json.body.ProfileName }}\"}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6320,
        -1360
      ],
      "id": "827f7c7e-60cd-4b31-b7c8-79b92825bfd7",
      "name": "Send Initial Template",
      "credentials": {
        "httpBasicAuth": {
          "id": "WsQzmrY4u3R3NvDi",
          "name": "Twillio cred 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c285b704-a505-4d8a-a018-83f7cc0070f0",
              "leftValue": "={{ $json.body.MessageType }}",
              "rightValue": "interactive",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6096,
        -1488
      ],
      "id": "1047b585-12d9-4f4d-94a6-fcea6537f400",
      "name": "Check if Template"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1401568257,
          "mode": "list",
          "cachedResultName": "demo sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6752,
        -2096
      ],
      "id": "94d72d0f-a105-4cad-8bdb-05f815312402",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://content.twilio.com/v1/Content",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"friendly_name\": \"baby_product_template\",\n  \"language\": \"en\",\n  \"types\": {\n    \"twilio/list-picker\": {\n      \"body\": \"Choose a product to view the details\",\n      \"button\": \"Select Product\",\n      \"items\": {{$node[\"mapping_item\"].json[\"items_stringified\"]}}\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7200,
        -2096
      ],
      "id": "355d4ec5-ffca-45bb-984a-b54b02327e38",
      "name": "Create List picker template OG",
      "credentials": {
        "httpHeaderAuth": {
          "id": "XbgCnjmIOf3tN8o7",
          "name": "Twillio cred 2"
        },
        "httpBasicAuth": {
          "id": "r3Hp5Vy6qya7XL5n",
          "name": "Twillio Credential"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Convert Excel rows → PROPER JSON array ready for Twilio\nconst MAX_ITEMS = 10;\n  const TITLE_MAX = 24;\nconst DESC_MAX = 72;\n\nconst rows = $input.all().map(i => i.json);\n\nfunction trunc(s,n){ \n  if (!s) return \"\"; \n  s = String(s); \n  return s.length<=n ? s : s.slice(0,n-1)+\"…\"; \n}\n\n// Order by in-stock first\nconst inStock = rows.filter(r => (r.availability || '').toLowerCase() === 'in stock');\nconst others   = rows.filter(r => !inStock.includes(r));\nconst ordered  = inStock.concat(others).slice(0, MAX_ITEMS);\n\n// Build Twilio List Picker items\nconst listItems = ordered.map(p => {\n  const id = String(p.id);\n  const title = trunc(p.title, TITLE_MAX);\n  const description = trunc(p.description ?? `₹${p.price} • ${p.availability}`, DESC_MAX);\n  return {\n    item: title,\n    description: description,\n    id: id\n  };\n});\n\n// Return BOTH versions:\n// 1. Normal JSON array\n// 2. Stringified JSON array (for display)\nreturn [{\n  json: {\n    items: listItems,\n    items_stringified: JSON.stringify(listItems, null, 2)\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6976,
        -2096
      ],
      "id": "2a670e03-2f63-416f-a240-6772e5987ca4",
      "name": "mapping_item"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.ButtonPayload }}",
                    "rightValue": "browse_product",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a7c6ca04-7747-406d-ab76-cd29c0e07c09"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Browse Product"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9ce7a61-a4ac-410d-a657-cc2043987041",
                    "leftValue": "={{ $json.body.ButtonPayload }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirm Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fa8a5bb5-2908-4bee-b7f7-b7d6cd329182",
                    "leftValue": "={{ $json.body.ButtonPayload }}",
                    "rightValue": "ask_faqs",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask FAQs"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ac966a0-815a-4c1b-9c9c-2af2834b903f",
                    "leftValue": "={{ $json.body.ButtonPayload }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a082f7c7-a09f-4524-8298-89fadaaf58c6",
                    "leftValue": "={{ $json.body.Body }}",
                    "rightValue": "_",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "No of Quantity"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "623c6501-41f9-456d-864f-72f89f0ec8a6",
                    "leftValue": "={{ $json.body.MessageType }}",
                    "rightValue": "interactive",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask Quantity"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        6320,
        -1680
      ],
      "id": "07b0d4a1-0940-4d90-9e55-0903d622edab",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $node['Webhook'].json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $node['Webhook'].json.body.To }}"
            },
            {
              "name": "ContentSid",
              "value": "={{ $json.sid }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7424,
        -2096
      ],
      "id": "0900b854-6c30-4ae3-82db-7ab40be0f30c",
      "name": "Send Template",
      "credentials": {
        "httpBasicAuth": {
          "id": "WsQzmrY4u3R3NvDi",
          "name": "Twillio cred 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://content.twilio.com/v1/Content",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"friendly_name\": \"baby_product_template\",\n  \"language\": \"en\",\n  \"types\": {\n    \"twilio/list-picker\": {\n      \"body\": \"{{ $json.body }}\",\n      \"button\": \"{{ $json.button }}\",\n      \"items\": {{$node[\"list_quantity\"].json[\"items_stringified\"]}}\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6768,
        -1136
      ],
      "id": "c2908f8e-371a-49a0-8708-f5f024e3d9a1",
      "name": "Create List Quantity picker ",
      "credentials": {
        "httpHeaderAuth": {
          "id": "XbgCnjmIOf3tN8o7",
          "name": "Twillio cred 2"
        },
        "httpBasicAuth": {
          "id": "r3Hp5Vy6qya7XL5n",
          "name": "Twillio Credential"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $node['Webhook'].json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $node['Webhook'].json.body.To }}"
            },
            {
              "name": "ContentSid",
              "value": "={{ $json.sid }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6992,
        -1136
      ],
      "id": "799a7aba-091a-4d48-963c-c0dc1d2e539f",
      "name": "Send Quantity Template",
      "credentials": {
        "httpBasicAuth": {
          "id": "WsQzmrY4u3R3NvDi",
          "name": "Twillio cred 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Function node: Quantity List Builder\n// Input: previous node is your Twilio webhook (so product selection data is in $json)\n// Output: { body, button, items_stringified }\n\n// --- Config\nconst MAX_Q = 10;\nconst BUTTON_TEXT = 'Select Qty';     // <=20 chars\nconst BODY_PREFIX = 'You selected';   // used to build the message\n\n// --- Helpers\nfunction trunc(s, n=60){ if (s===undefined||s===null) return ''; s=String(s); return s.length<=n? s : s.slice(0,n-1)+'…'; }\n\n// --- Extract product identifier from common Twilio webhook fields\n// Try a few common locations: (adjust if your webhook stores elsewhere)\n\n// Common Twilio places seen in screenshots: payload.Body, payload.ListTitle, payload.body.ListTitle, payload.body.Body\nlet productIdentifier = $input.first().json.body.Body;\nlet productTitle = $input.first().json.body.ListTitle;\n\n\n// --- Build items array (1..MAX_Q). Use small 'item' titles and descriptions\nconst items = [];\nfor (let q = 1; q <= MAX_Q; q++) {\n  const idObj = `${q}_${productIdentifier}`;\n  items.push({\n    item: String(q),                    // label shown to the user\n    description: q === 1 ? '1 unit' : `${q} units`,\n    // id is a safe encoded JSON string (decode on webhook parse)\n    id: idObj\n  });\n}\n\n// Build output fields\nconst body = `${BODY_PREFIX} '${trunc(productTitle, 36)}'. How many units do you want?`;\nconst button = BUTTON_TEXT;\nconst items_stringified = JSON.stringify(items); // stringified JSON array as requested\n\nreturn [{\n  json: {\n    body,\n    button,\n    items_stringified\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6544,
        -1136
      ],
      "id": "65d80e60-876b-482a-ae6d-26cf9ad8bb46",
      "name": "list_quantity"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a0ea277a-b6fc-4818-8787-bae7b6768ddc",
              "name": "item_id",
              "value": "={{ $json.body.ListId.split('_')[1] }}",
              "type": "string"
            },
            {
              "id": "d331bf07-e522-4f03-8752-f7b332b1f648",
              "name": "quantity",
              "value": "={{ $json.body.ListTitle }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6544,
        -1328
      ],
      "id": "821ae4ab-89a3-40a7-a39f-6cc8cb2a923a",
      "name": "Get Item ID"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1401568257,
          "mode": "list",
          "cachedResultName": "demo sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "id",
              "lookupValue": "={{ $json.item_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6768,
        -1328
      ],
      "id": "456f52c3-22f4-4350-84a9-fb7381c49bcf",
      "name": "Get row(s) in sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://content.twilio.com/v1/Content",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"friendly_name\": \"confirm_order\",\n  \"language\": \"en\",\n  \"types\": {\n    \"twilio/quick-reply\": {\n      \"body\": \"Confirm your order: \\n • Product: {{ $json.title }} \\n • Quantity: {{ $('Get Item ID').item.json.quantity }}\",\n      \"actions\": [\n        {\n          \"title\": \"Confirm\",\n          \"id\": \"confirm_{{ $('Get Item ID').item.json.item_id }}_{{ $('Get Item ID').item.json.quantity }}\"\n        },\n        {\n          \"title\": \"Cancel\",\n          \"id\": \"cancel\"\n        }\n      ]\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6992,
        -1328
      ],
      "id": "9d5a9e93-da3c-444f-9688-d3f2f5d11d30",
      "name": "Confirmation Template",
      "credentials": {
        "httpBasicAuth": {
          "id": "r3Hp5Vy6qya7XL5n",
          "name": "Twillio Credential"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $node['Webhook'].json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $node['Webhook'].json.body.To }}"
            },
            {
              "name": "ContentSid",
              "value": "={{ $json.sid }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7216,
        -1328
      ],
      "id": "b794c898-6ebd-4a3b-bbe0-0fc81e1d7b15",
      "name": "Send Confirm Template",
      "credentials": {
        "httpBasicAuth": {
          "id": "WsQzmrY4u3R3NvDi",
          "name": "Twillio cred 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $('Webhook').item.json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $('Webhook').item.json.body.To }}"
            },
            {
              "name": "ContentSid",
              "value": "HX67dec374c3290ba042afc2e69e75f8c1"
            },
            {
              "name": "ContentVariables",
              "value": "={\"1\":\"{{ $('Webhook').item.json.body.ProfileName }}\"}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6768,
        -1520
      ],
      "id": "e4636f0d-3d9b-45f6-97b3-aea38371dda5",
      "name": "Send Initial Template1",
      "credentials": {
        "httpBasicAuth": {
          "id": "WsQzmrY4u3R3NvDi",
          "name": "Twillio cred 2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $('Check if Template').item.json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $('Check if Template').item.json.body.To }}"
            },
            {
              "name": "Body",
              "value": "=Your Order Has Been Cancel\nIf you want inital menu, type \"Menu\""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6544,
        -1520
      ],
      "id": "24d8d59c-5d24-4a4f-b3bf-29b9d67d305d",
      "name": "Send Normal Message",
      "credentials": {
        "httpBasicAuth": {
          "id": "r3Hp5Vy6qya7XL5n",
          "name": "Twillio Credential"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00a9c062-dd4a-46e1-aca8-543cae3c6dca",
              "name": "item_id",
              "value": "={{ $json.body.ButtonPayload.split(\"_\")[1] }}",
              "type": "string"
            },
            {
              "id": "951c7c53-da08-4ec7-84f0-4bbc5433d52a",
              "name": "quantity",
              "value": "={{ $json.body.ButtonPayload.split(\"_\")[2] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6544,
        -1904
      ],
      "id": "802434ea-635f-4c2c-9ed7-fbc60ff18135",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1401568257,
          "mode": "list",
          "cachedResultName": "demo sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "id",
              "lookupValue": "={{ $json.item_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6768,
        -1904
      ],
      "id": "831d592b-01b4-4ded-b349-7730aa3973f2",
      "name": "Get row(s) in sheet2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 38109468,
          "mode": "list",
          "cachedResultName": "Order List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Phone Number": "={{ $('Webhook').item.json.body.WaId }}",
            "User": "={{ $('Webhook').item.json.body.ProfileName }}",
            "Item_id": "={{ $('Edit Fields').item.json.item_id }}",
            "Item": "={{ $json.title }}",
            "Quantity": "={{ $('Edit Fields').item.json.quantity }}",
            "Date": "={{ $now.setZone('Asia/Kolkata').format('yyyy-MM-dd T') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "User",
              "displayName": "User",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Item_id",
              "displayName": "Item_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Item",
              "displayName": "Item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6992,
        -1904
      ],
      "id": "e63b5675-06e4-4c4e-a8e7-67c5190725cd",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $('Check if Template').item.json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $('Check if Template').item.json.body.To }}"
            },
            {
              "name": "Body",
              "value": "=Your Order Has Been Added in our Database\nIf you want inital menu, type \"Menu\""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7216,
        -1904
      ],
      "id": "85025d4d-0fe9-4a5e-b47d-41f4020ac3d2",
      "name": "Send Normal Message1",
      "credentials": {
        "httpBasicAuth": {
          "id": "r3Hp5Vy6qya7XL5n",
          "name": "Twillio Credential"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "To",
              "value": "={{ $('Check if Template').item.json.body.From }}"
            },
            {
              "name": "From",
              "value": "={{ $('Check if Template').item.json.body.To }}"
            },
            {
              "name": "Body",
              "value": "=This Feature is under Development\nIf you want inital menu, type \"Menu\""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6544,
        -1712
      ],
      "id": "05d90907-b4dd-42b2-b517-7ba9771f87f4",
      "name": "Send Normal Message2",
      "credentials": {
        "httpBasicAuth": {
          "id": "r3Hp5Vy6qya7XL5n",
          "name": "Twillio Credential"
        }
      }
    },
    {
      "parameters": {
        "multipleMethods": true,
        "path": "butruu_bot",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3152,
        -1968
      ],
      "id": "3b0080ac-4b54-41c0-9f56-b71be5213c58",
      "name": "Whatsapp Bot Webhook",
      "webhookId": "2b7f85b2-f581-46d9-8d22-172f7a9933c0"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query[\"hub.challenge\"] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -2272,
        -2064
      ],
      "id": "cbef7959-d640-4f0e-9853-d51daa0d3ae9",
      "name": "Verify Webhook"
    },
    {
      "parameters": {
        "content": "# Twillio Connection",
        "height": 1552,
        "width": 1760
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5984,
        -2288
      ],
      "id": "87410b3c-eef4-46ce-8088-a9442cac5d53",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "51696ba9-54b9-4f8c-bd0c-4e11fcb50d45",
              "leftValue": "={{ $json.query['hub.mode'] }}",
              "rightValue": "subscribe",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "4b041959-0ee0-4db3-8465-d08554bdec80",
              "leftValue": "={{ $json.query['hub.verify_token'] }}",
              "rightValue": "hello",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2496,
        -2064
      ],
      "id": "25f8644c-99d4-4c89-b1c2-5f640181f41c",
      "name": "Check webhook configure parameter"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "24009ed9-9dd8-4b22-9e15-ef5b4e0b1587",
              "name": "msg_from",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.metadata.display_phone_number }}",
              "type": "string"
            },
            {
              "id": "2977f9b0-5df4-4d94-93a7-308724b31769",
              "name": "msg",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "14d7554a-9415-4478-b26c-59d88b63d498",
              "name": "user_name",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "d6ec1f78-0ce8-492a-bba7-bf520f8f56c8",
              "name": "msg_to",
              "value": "={{ $json.msg_to }}",
              "type": "string"
            },
            {
              "id": "cac33ed1-69cc-4bb8-8b25-9990d994e1af",
              "name": "msg_id",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1600,
        -704
      ],
      "id": "a09b5fad-edb8-44f0-b4f7-b9fb39ead618",
      "name": "Set Variable"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "897fa65a-47b7-4e25-b472-6f72bfc1d1c5",
              "leftValue": "={{ $(\"Whatsapp Bot Webhook\").item.json.body.entry[0].changes[0].value.statuses[0].status }}",
              "rightValue": "read",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2464,
        -1872
      ],
      "id": "854c4a0b-00d9-4bb9-a993-70a2e14f295b",
      "name": "Filter"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9ce7a61-a4ac-410d-a657-cc2043987041",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirm Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fe1e27ee-c64f-4431-95f9-bc69d2b64f40",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "order_status",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Order Status"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fa8a5bb5-2908-4bee-b7f7-b7d6cd329182",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "ask_faq",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask FAQs"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ac966a0-815a-4c1b-9c9c-2af2834b903f",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "browse_product",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a7c6ca04-7747-406d-ab76-cd29c0e07c09"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Browse Product"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1c46b4c8-8a38-4b12-aad3-eb424595cb3d",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "use_saved_details",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Send Catalog"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "53b11d5b-9b88-4786-881a-a58d9fa4b1c9",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "update_user_info",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Update Usere Info"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f2f08703-c48e-4238-8f86-1a605c976230",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "main_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Main Menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ff0b86f4-3c80-4bb6-a6dd-fb6e5241516b",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "share_feedback",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Share Feedback"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -608,
        -2064
      ],
      "id": "c70792a6-7041-4dea-ae7c-48c3f761d8b8",
      "name": "Switch1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].interactive.type }}",
                    "rightValue": "button_reply",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "66f96ae4-4402-4323-8b49-2f569e97fbf3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Button Reply"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ee46d084-6457-4ed6-a176-6069f41e401b",
                    "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].interactive.type }}",
                    "rightValue": "nfm_reply",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Flow Submit"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1232,
        -1856
      ],
      "id": "624d36cc-c55c-42fe-8460-17b6d6d18a4b",
      "name": "Interative Type Route"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2059797163,
          "mode": "list",
          "cachedResultName": "Worksheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=2059797163"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1168,
        -1264
      ],
      "id": "dc6a9564-09b1-4a65-92e8-54638755f599",
      "name": "Get row(s) in sheet3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1824,
        -3872
      ],
      "id": "3920186d-98df-4c94-a70d-2dfe84046c18",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $json.phone_number_id }}/business_compliance_info",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"entity_name\": \"Lakshit Ukani\",\n  \"entity_type\": \"SOLE_PROPRIETORSHIP\",\n  \"entity_registration_number\": \"AEEUU5907L\",\n  \"business_address\": {\n    \"street\": \"Mira road\",\n    \"city\": \"Thane\",\n    \"state\": \"Maharashtra\",\n    \"postal_code\": \"401107\",\n    \"country\": \"IN\"\n  },\n  \"customer_care_details\": {\n    \"email\": \"laksh77@gmail.com\",\n    \"mobile_number\": \"+918163328947\"\n  },\n  \"grievance_officer_details\": {\n    \"name\": \"Lakshit Ukani\",\n    \"email\": \"laksh77@gmail.com\",\n    \"mobile_number\": \"+918122228947\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1392,
        -3536
      ],
      "id": "ebd5a909-1e79-4d65-95c7-7c065ef022ed",
      "name": "Compliance Info Post",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v24.0/{{ $('Edit Fields3').item.json.phone_number_id }}/business_compliance_info",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1168,
        -3536
      ],
      "id": "bdcdd0f1-89d7-4ce2-96c6-4d5eb050b0d7",
      "name": "Compliance Info Get",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "interactive",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38c2ee1e-5380-4c4c-906a-765cd35fff09"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Interactive"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7bb670b9-8110-4d70-a382-9581cd025551",
                    "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "order",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "73114ba1-f1c6-4eb8-8f92-f9abf6d6cb29",
                    "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1456,
        -1168
      ],
      "id": "90f57056-7240-4358-97bb-98ea291c9819",
      "name": "Message Type Routing"
    },
    {
      "parameters": {
        "content": "# Compliance Check for India",
        "height": 304,
        "width": 944
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1872,
        -3664
      ],
      "id": "f223e2b6-f285-458b-a300-a473b5a6840e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2059797163,
          "mode": "list",
          "cachedResultName": "Worksheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=2059797163"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1008,
        -1152
      ],
      "id": "9e36b115-9bd8-40d0-8800-a546b2f7d9e1",
      "name": "Get Stock data",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Input 1 = WhatsApp webhook\n// Input 2 = Excel data\n\n// FIX 1: unwrap Excel rows from .all() → each item is { json: { ... } }\nconst excelData = $('Get Stock data').all().map(item => item.json);\n\n// Extract all product_items from WhatsApp order\nconst productItems = $('Whatsapp Bot Webhook').first().json.body.entry[0].changes[0].value.messages[0].order.product_items\n\n// Collect errors\nlet errors = [];\n\n// Collect success\nlet successLines = [];\n\n// NEW: collect selected item details\nlet selectedData = [];\n\nfor (const item of productItems) {\n  const selectedId = String(item.product_retailer_id).trim();\n  const selectedQty = Number(item.quantity);\n\n  // FIX 2: normalize Excel IDs to string\n  const match = excelData.find(p => String(p.id).trim() === selectedId);\n\n  if (!match) {\n    errors.push(`Product with ID ${selectedId} not found.`);\n    continue;\n  }\n\n  const available = Number(match.item_available);\n  const title = String(match.title)\n\n  // Store selected item info\n  selectedData.push({\n    product_id: selectedId,\n    quantity: selectedQty,\n    title: title\n  });\n\n  if (available < selectedQty) {\n    errors.push(\n      `Only ${available} item(s) of \"${match.title}\" are available, but you selected ${selectedQty}.`\n    );\n  } else {\n    // Build success line\n    successLines.push(`✅ ${match.title} — Qty: ${selectedQty}`);\n  }\n}\n\n// FINAL DECISION\nif (errors.length === 0) {\n\n  const successMessage = \n`Hey! 😊\nI checked the items you added to your cart.\n\n🛒 Here’s what you selected:\n${successLines.join('\\n')}\n\n🎉 Good news! Everything is in stock and ready to go.\nPlease confirm your order to continue.`;\n  return [\n    {\n      json: {\n        success: true,\n        message: successMessage\n      }\n    }\n  ];\n} else {\n  return [\n    {\n      json: {\n        success: false,\n        message: errors.join(\" | \")\n      }\n    }\n  ];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -784,
        -1152
      ],
      "id": "fadea261-f7b7-4a7a-a9a0-9945c48c2d3b",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bd52bbe8-7f92-4efe-8416-0d8d14246800",
              "name": "=msg_to_send",
              "value": "=Thanks for your order! 😄\nI checked the availability and here’s an update:\n\nSome items are currently not available in the quantity you selected:\n\n👉 {{$json.message.replace(/\\|/g, \"\\n👉 \")}}\n\nYou can update the quantities and let me know — I’ll place the order immediately for you!;",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -336,
        -1248
      ],
      "id": "a21bd904-3062-4a8e-b076-5459573efcab",
      "name": "Error message"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "018b7715-2bfd-48f9-b1da-63fb9b6209f0",
              "name": "msg_to_send_2",
              "value": "=Hey! 😊\nI checked the items you added to your cart.\n\n🛒 Here’s what you selected:\n\n🎉 Good news: Everything you selected is in stock and ready to go!\nPlease confirm your order to continue.",
              "type": "string"
            },
            {
              "id": "f595e15d-51a7-4e1d-9c28-d7b0f7475428",
              "name": "msg_to_send",
              "value": "={{ $('Code in JavaScript').item.json.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -336,
        -1056
      ],
      "id": "858526bc-1fd7-4fa8-9060-8f0736341436",
      "name": "Succes Msg"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -112,
        -1248
      ],
      "id": "709cbadb-6a1f-445e-9e57-dfb1d78e99fc",
      "name": "Send msg",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
              "name": "catalog_id",
              "value": "={{ $json.catalog_id }}",
              "type": "string"
            },
            {
              "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
              "name": "msg_to",
              "value": "={{ $json.msg_to }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1232,
        -1152
      ],
      "id": "19db4f36-eb24-4f79-8088-75ca4359b201",
      "name": "Set Variable2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Succes Msg').item.json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields1').item.json.unique_id_of_order }}_confirm\",\n            \"title\": \"Confirm\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields1').item.json.unique_id_of_order }}_cancel\",\n            \"title\": \"Cancel\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1024,
        -1056
      ],
      "id": "f866cafb-23fd-4de5-adaf-7767a791dc7e",
      "name": "HTTP Request2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "htaS8wafCR4Eh7v5",
          "mode": "list",
          "cachedResultName": "Alister Order Stage",
          "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "phone_no": "={{ $('Edit Fields1').item.json.user_phone_no }}",
            "unique_order_id": "={{ $('Edit Fields1').item.json.unique_id_of_order }}",
            "user_name": "={{ $('Edit Fields1').item.json.user_name }}",
            "product_id": "={{ $json.product_retailer_id }}",
            "product_quantity": "={{ $json.quantity }}",
            "product_title": "={{ $json.title }}",
            "sale_price": "={{ $json.sale_price }}",
            "no_of_pack": "={{ $json.no_of_pack }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "unique_order_id",
              "displayName": "unique_order_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "user_name",
              "displayName": "user_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "phone_no",
              "displayName": "phone_no",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_id",
              "displayName": "product_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_title",
              "displayName": "product_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_quantity",
              "displayName": "product_quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "sale_price",
              "displayName": "sale_price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "no_of_pack",
              "displayName": "no_of_pack",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        560,
        -1056
      ],
      "id": "d9d4a636-5253-4e91-a6c5-5d58c5f78603",
      "name": "Insert row"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c618dbc9-40d0-4cd6-b164-60a462ceb16e",
              "name": "user_selected_product",
              "value": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].order.product_items }}",
              "type": "array"
            },
            {
              "id": "41163f52-519c-4a26-8f60-c5cbb759a21c",
              "name": "unique_id_of_order",
              "value": "={{ 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 10000) }}",
              "type": "string"
            },
            {
              "id": "21053b3f-1909-4bb3-9888-561355df41bc",
              "name": "user_name",
              "value": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "36d108e7-b62c-4145-822c-640f588557a9",
              "name": "user_phone_no",
              "value": "={{ $node['Add this Variable'].json.msg_to }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -112,
        -1056
      ],
      "id": "ce22c39a-584d-4009-9823-9e2c90b73042",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "fieldToSplitOut": "user_selected_product",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        112,
        -1056
      ],
      "id": "55feeac7-55bd-42e7-b37b-e644d5f82de8",
      "name": "Split Out"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b414d52e-386d-4c0e-8eac-d0aeb8135ad6",
              "name": "order_id",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id.split(\"_\")[0] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -160,
        -2352
      ],
      "id": "77391d16-7abe-44e2-861f-3b1245a6b7ca",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 38109468,
          "mode": "list",
          "cachedResultName": "Order List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Phone Number": "={{ $json.phone_no }}",
            "User": "={{ $json.user_name }}",
            "Item_id": "={{ $json.product_id }}",
            "Item": "={{ $json.product_title }}",
            "Quantity": "={{ $json.product_quantity }}",
            "Date": "={{ $now.setZone('Asia/Kolkata').format('yyyy-MM-dd T') }}",
            "Status": "Order Placed",
            "Order ID": "={{ $('Edit Fields2').item.json.order_id }}",
            "Sale Price": "={{ $json.sale_price }}",
            "No of Pack": "={{ $json.no_of_pack }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Order ID",
              "displayName": "Order ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "User",
              "displayName": "User",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Item_id",
              "displayName": "Item_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Item",
              "displayName": "Item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Sale Price",
              "displayName": "Sale Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "No of Pack",
              "displayName": "No of Pack",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        288,
        -2352
      ],
      "id": "37935ec5-dd12-4f55-a396-fb06e19f56b8",
      "name": "Append row in sheet2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "htaS8wafCR4Eh7v5",
          "mode": "list",
          "cachedResultName": "Alister Order Stage",
          "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "unique_order_id",
              "keyValue": "={{ $('Edit Fields2').item.json.order_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        64,
        -2352
      ],
      "id": "da314ca5-c1d0-4d96-847d-2c08dc5135b6",
      "name": "Get row(s)"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        784,
        -1056
      ],
      "id": "740ad203-809c-4465-819f-3c7acd6e5423",
      "name": "Limit"
    },
    {
      "parameters": {
        "jsCode": "// Load data from nodes\nconst product_data = $(\"Get Stock data\").all().map(item => item.json);\nconst user_selected_data = $(\"Split Out\").all().map(item => item.json);\n\n// Final output list\nlet matched = [];\n\n// Loop through user-selected items\nfor (const userItem of user_selected_data) {\n  \n  const selectedId = String(userItem.product_retailer_id).trim();\n  const salePrice = String(userItem.item_price).trim();\n\n  // Find matching product from stock data\n  const stockItem = product_data.find(\n    p => String(p.id).trim() === selectedId\n  );\n\n  // If matched → append combined data\n  if (stockItem) {\n    matched.push({\n      product_retailer_id: selectedId,\n      sale_price: salePrice,\n      title: stockItem.title,\n      quantity: userItem.quantity,\n      no_of_pack: stockItem.custom_label_0\n      \n    });\n  }\n}\n\n// Return result\nreturn matched.map(m => ({ json: m }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -1056
      ],
      "id": "23c6658a-0f49-44a5-818c-4f68d23f4dc6",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        512,
        -2352
      ],
      "id": "e019d711-350a-4ef3-9289-777833978fea",
      "name": "Limit1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Your Order Has Been Cancel \\nIf you want inital menu, type 'Menu' or 'Hello'\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -1872
      ],
      "id": "fce3578c-ad98-453a-9724-bffc0d0a557a",
      "name": "Cancel Msg",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Hi 😊\\n\\nYou can ask me anything about Butruu—orders, delivery, payments, diaper sizes, or anything else you’d like to know.\\n\\nJust type your question in your own words, and I’ll help you right away. 💚\\n\\nIf you want to see the menu again, simply type *Hello*\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -2016
      ],
      "id": "8634bc0f-b143-483a-b612-3006fb7e0c7e",
      "name": "FAQ msg",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "content": "# Official Meta Connection via Catalog & Template (New Way)",
        "height": 3376,
        "width": 5584
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1584,
        -6816
      ],
      "id": "04990b98-2e8f-4b62-96e5-079c07492537",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 38109468,
          "mode": "list",
          "cachedResultName": "Order List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Phone Number",
              "lookupValue": "={{ $json.msg_to }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -160,
        -2160
      ],
      "id": "f4d4b147-8b53-4546-b541-a65c87900240",
      "name": "Get row(s) in sheet4",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Load orders\nconst order_list = $(\"Get row(s) in sheet4\").all().map(item => item.json);\n\nif (!order_list.length) {\n  return [{ json: { message: \"You have no orders at the moment.\" } }];\n}\n\n// Sort latest first\norder_list.sort((a, b) => new Date(b.Date) - new Date(a.Date));\n\n// Group by Order ID\nconst grouped = {};\n\nfor (const row of order_list) {\n  const orderId = row[\"Order ID\"];\n\n  if (!grouped[orderId]) {\n    grouped[orderId] = {\n      items: [],\n      status: row.Status,\n      orderDate: row[\"Date\"] ? row[\"Date\"].split(\" \")[0] : \"\",\n    };\n  }\n\n  grouped[orderId].items.push({\n    name: row.Item,\n    quantity: Number(row.Quantity || 1),\n    salePrice: row[\"Sale Price\"],\n    pack: row[\"No of Pack\"],\n  });\n}\n\n// Convert grouped orders to array\nconst orders = Object.entries(grouped);\n\n// Max safe limit (interactive = 1024)\nconst MAX_LENGTH = 950;\n\nlet messages = [];\nlet currentMessage = \"📦 *Your Order Summary*\\n\\n\";\n\nfor (const [orderId, data] of orders) {\n\n  let orderBlock = \"\";\n\n  const totalQty = data.items.reduce((sum, i) => sum + i.quantity, 0);\n\n  orderBlock += `🧾 *Order ID:* ${orderId}\\n`;\n\n  if (data.orderDate) {\n    orderBlock += `📅 *Order Date:* ${data.orderDate}\\n`;\n  }\n\n  orderBlock += `📌 *Status:* ${data.status}\\n`;\n  orderBlock += `📦 *Total Items:* ${totalQty}\\n\\n`;\n  orderBlock += `🛍️ *Items:*\\n`;\n\n  for (const item of data.items) {\n    orderBlock += `• ${item.name}\\n`;\n    orderBlock += `   Qty: ${item.quantity}\\n`;\n  }\n\n  orderBlock += \"\\n----------------------\\n\\n\";\n\n  // If adding this order exceeds limit → push previous message\n  if ((currentMessage + orderBlock).length > MAX_LENGTH) {\n    messages.push(currentMessage.trim());\n    currentMessage = orderBlock;\n  } else {\n    currentMessage += orderBlock;\n  }\n}\n\n// Push last message\nif (currentMessage.trim()) {\n  messages.push(currentMessage.trim());\n}\n\n// Return multiple messages\nreturn messages.map(m => ({ json: { message: m } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -2016
      ],
      "id": "a805b8ff-a0ef-4152-8786-a58c63dde7e6",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v24.0/924412964080974/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\":\"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\":\"918655991300\",\n  \"type\":\"interactive\",\n  \"interactive\":{\n    \"type\":\"product\",\n    \"body\": {\n      \"text\":\"Check this item\" \n    },\n    \"footer\": { \n      \"text\":\"Tap to view details\" \n    },\n    \"action\": {\n      \"catalog_id\":\"896416602722897\",\n      \"product_retailer_id\":\"1\"\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        256,
        -4160
      ],
      "id": "e6602605-cca6-44ec-bbff-213ef4033fb6",
      "name": "HTTP Request5",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
              "name": "catalog_id",
              "value": "896416602722897",
              "type": "string"
            },
            {
              "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
              "name": "msg_to",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "bafa1b69-5374-4c42-ac6c-766dab6487e3",
              "name": "phone_number_id",
              "value": "924412964080974",
              "type": "string"
            },
            {
              "id": "fcf32a01-362e-4a7a-a8ad-c2c06acc3195",
              "name": "encrypted_flow_data",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.encrypted_flow_data }}",
              "type": "string"
            },
            {
              "id": "22509540-7420-4a86-92a0-7e0d570c98ec",
              "name": "encrypted_aes_key",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.encrypted_aes_key }}",
              "type": "string"
            },
            {
              "id": "df098d39-9d22-4b90-b8b3-f4ba31b9f16d",
              "name": "initial_vector",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.initial_vector }}",
              "type": "string"
            },
            {
              "id": "1792b3b5-c8aa-4e9e-9277-30ad112ebc11",
              "name": "app_version",
              "value": "v24.0",
              "type": "string"
            },
            {
              "id": "dbf1e8d3-cdbe-4d1d-816c-5aa67612809c",
              "name": "user_flow_id",
              "value": "1447104173423173",
              "type": "string"
            },
            {
              "id": "d215db8e-5748-4cd0-ad3b-b99bfbf2bf06",
              "name": "user_name",
              "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "523f73ad-025d-4305-94e4-b9c75b5ad209",
              "name": "user_feedback_flow_id",
              "value": "1142271577874941",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2272,
        -1872
      ],
      "id": "79a6392e-4a87-4d62-8c0c-fd61ce3b9768",
      "name": "Add this Variable"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "528835a6-bfc1-4ef6-88da-fab4dfda48df",
              "name": "phone_number_id",
              "value": "924412964080974",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1616,
        -3536
      ],
      "id": "993077bb-206f-4ef4-84c6-01aea9c78488",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"butruu_catalog\",\n    \"language\": {\n      \"code\": \"en\"\n    },\n    \"components\": [\n        {\n          \"type\": \"button\",\n          \"sub_type\": \"mpm\",\n          \"index\": 0,\n          \"parameters\": [\n            {\n              \"type\": \"action\",\n              \"action\": {\n                \"sections\": [\n        {\n          \"title\": \"Pack of 30\",\n          \"product_items\": [\n{\"product_retailer_id\":\"1\"},\n{\"product_retailer_id\":\"2\"}\n]\n        },\n        {\n          \"title\": \"Pack of 140\",\n          \"product_items\": [\n{\"product_retailer_id\":\"3\"},{\"product_retailer_id\":\"4\"},{\"product_retailer_id\":\"5\"}]\n        }\n      ]\n              }\n            }\n          ]\n        }\n    ]\n  }\n}\n    ",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        576,
        -3840
      ],
      "id": "29d1501e-0dcf-4e7b-bf08-27fbad6c6ae3",
      "name": "Send Multi Product Marketing template",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to || $node['Decryption'].json.decryptedBody.flow_token}}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"product_list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"Baby Care Products\"\n    },\n    \"body\": {\n      \"text\": \"Check out our premium baby care collection\"\n    },\n    \"footer\": {\n      \"text\": \"Best prices guaranteed\"\n    },\n    \"action\": {\n      \"catalog_id\": \"{{ $items('Add this Variable')[0].json.catalog_id}}\",\n      \"sections\": {{ $json.items_stringified }}\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1632,
        -1264
      ],
      "id": "8d83513c-7426-407f-b09a-588a87c4b334",
      "name": "Send Multi Product Category",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "multipleMethods": true,
        "path": "whatsapp_alisterrrrrrr",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        5744,
        672
      ],
      "id": "2fa0eaf2-712c-4ae1-bb2d-944c002b3c13",
      "name": "Whatsapp Bot Webhook1",
      "webhookId": "2b7f85b2-f581-46d9-8d22-172f7a9933c0"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query[\"hub.challenge\"] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        6192,
        576
      ],
      "id": "94e5d9ab-e888-4758-b8e5-b8aa833f906a",
      "name": "Verify Webhook1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "51696ba9-54b9-4f8c-bd0c-4e11fcb50d45",
              "leftValue": "={{ $json.query['hub.mode'] }}",
              "rightValue": "subscribe",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "4b041959-0ee0-4db3-8465-d08554bdec80",
              "leftValue": "={{ $json.query['hub.verify_token'] }}",
              "rightValue": "hello",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        5968,
        576
      ],
      "id": "85040eec-b93d-42f8-82e4-9995050473d8",
      "name": "Check webhook configure parameter1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "24009ed9-9dd8-4b22-9e15-ef5b4e0b1587",
              "name": "msg_from",
              "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.metadata.display_phone_number }}",
              "type": "string"
            },
            {
              "id": "2977f9b0-5df4-4d94-93a7-308724b31769",
              "name": "msg",
              "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "14d7554a-9415-4478-b26c-59d88b63d498",
              "name": "user_name",
              "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6640,
        960
      ],
      "id": "490dd59d-d5bd-4905-95d1-3bc09a25977b",
      "name": "Set Variable1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable1').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi {{ $json.user_name }} 👋 \\nWelcome to Butruu! You can:\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"order_status\",\n            \"title\": \"Order Status\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ask_faq\",\n            \"title\": \"Ask FAQs\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6864,
        960
      ],
      "id": "afd28b81-4996-4866-9131-da021402b2b3",
      "name": "HTTP Request1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "897fa65a-47b7-4e25-b472-6f72bfc1d1c5",
              "leftValue": "={{ $json.body.entry[0].changes[0].value.statuses[0].status }}",
              "rightValue": "read",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        5968,
        768
      ],
      "id": "dfec6345-2475-4be5-b79b-2d3c8428c4a9",
      "name": "Filter1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9ce7a61-a4ac-410d-a657-cc2043987041",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "confirm",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirm Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fe1e27ee-c64f-4431-95f9-bc69d2b64f40",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "order_status",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fa8a5bb5-2908-4bee-b7f7-b7d6cd329182",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "ask_faq",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ask FAQs"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1ac966a0-815a-4c1b-9c9c-2af2834b903f",
                    "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                    "rightValue": "browse_product",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a7c6ca04-7747-406d-ab76-cd29c0e07c09"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Browse Product"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        6864,
        144
      ],
      "id": "b312638a-bd9a-48b9-8d50-85f10828b34c",
      "name": "Switch2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].interactive.type }}",
                    "rightValue": "button_reply",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "66f96ae4-4402-4323-8b49-2f569e97fbf3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Button Reply"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        6640,
        192
      ],
      "id": "406c1fdf-7a51-446f-bf28-9049e6affc14",
      "name": "Interative Type Route1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1401568257,
          "mode": "list",
          "cachedResultName": "demo sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        7984,
        592
      ],
      "id": "b5162c71-4811-4483-ae89-4ed084bbba9a",
      "name": "Get row(s) in sheet5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Convert Excel rows → PROPER JSON array ready for Twilio\nconst MAX_ITEMS = 10;\n  const TITLE_MAX = 24;\nconst DESC_MAX = 72;\n\nconst rows = $input.all().map(i => i.json);\n\nfunction trunc(s,n){ \n  if (!s) return \"\"; \n  s = String(s); \n  return s.length<=n ? s : s.slice(0,n-1)+\"…\"; \n}\n\n// Order by in-stock first\nconst inStock = rows.filter(r => (r.availability || '').toLowerCase() === 'in stock');\nconst others   = rows.filter(r => !inStock.includes(r));\nconst ordered  = inStock.concat(others).slice(0, MAX_ITEMS);\n\n// Build Twilio List Picker items\nconst listItems = ordered.map(p => {\n  const id = String(p.id);\n  const title = trunc(p.title, TITLE_MAX);\n  const description = trunc(p.description ?? `₹${p.price} • ${p.availability}`, DESC_MAX);\n  return {\n    product_retailer_id: id\n  };\n});\n\n// Return BOTH versions:\n// 1. Normal JSON array\n// 2. Stringified JSON array (for display)\nreturn [{\n  json: {\n    items: listItems,\n    items_stringified: JSON.stringify(listItems, null, 2)\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8208,
        592
      ],
      "id": "7b08f0a2-bab9-4d36-b86e-e3518fbaf2b9",
      "name": "mapping_item2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"product_list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"Baby Care Products\"\n    },\n    \"body\": {\n      \"text\": \"Check out our premium baby care collection\"\n    },\n    \"footer\": {\n      \"text\": \"Best prices guaranteed\"\n    },\n    \"action\": {\n      \"catalog_id\": \"896416602722897\",\n      \"sections\": [\n        {\n          \"title\": \"Diapers & Care\",\n          \"product_items\": \n            {{ JSON.stringify($json.items) }}\n        }\n      ]\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8464,
        416
      ],
      "id": "b80e2a90-6478-4a99-a3a2-25040c00cb95",
      "name": "Send Multi Product Template1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "interactive",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38c2ee1e-5380-4c4c-906a-765cd35fff09"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Interactive"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7bb670b9-8110-4d70-a382-9581cd025551",
                    "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "order",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Order"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "73114ba1-f1c6-4eb8-8f92-f9abf6d6cb29",
                    "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        6416,
        752
      ],
      "id": "99c059f8-ce93-4c48-a20b-278e4babce38",
      "name": "Message Type Routing1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1401568257,
          "mode": "list",
          "cachedResultName": "demo sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6864,
        768
      ],
      "id": "516498e5-933f-4d28-9860-a3bfeef23aff",
      "name": "Get Stock data1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Input 1 = WhatsApp webhook\n// Input 2 = Excel data\n\n// FIX 1: unwrap Excel rows from .all() → each item is { json: { ... } }\nconst excelData = $('Get Stock data1').all().map(item => item.json);\n\n// Extract all product_items from WhatsApp order\nconst productItems = $('Whatsapp Bot Webhook1').first().json.body.entry[0].changes[0].value.messages[0].order.product_items\n\n// Collect errors\nlet errors = [];\n\nfor (const item of productItems) {\n  const selectedId = String(item.product_retailer_id).trim();\n  const selectedQty = Number(item.quantity);\n\n  // FIX 2: normalize Excel IDs to string\n  const match = excelData.find(p => String(p.id).trim() === selectedId);\n\n  if (!match) {\n    errors.push(`Product with ID ${selectedId} not found.`);\n    continue;\n  }\n\n  const available = Number(match.item_available);\n\n  if (available < selectedQty) {\n    errors.push(\n      `Only ${available} item(s) of \"${match.title}\" are available, but you selected ${selectedQty}.`\n    );\n  }\n}\n\n// FINAL DECISION\nif (errors.length === 0) {\n  return [\n    {\n      json: {\n        success: true,\n        message: \"Stock available for all selected items.\"\n      }\n    }\n  ];\n} else {\n  return [\n    {\n      json: {\n        success: false,\n        message: errors.join(\" | \")\n      }\n    }\n  ];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7088,
        768
      ],
      "id": "c94ba703-e35e-4d2a-a4b9-1f140cf6d3ba",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bd52bbe8-7f92-4efe-8416-0d8d14246800",
              "name": "=msg_to_send",
              "value": "=Thanks for your order! 😄\nI checked the availability and here’s an update:\n\nSome items are currently not available in the quantity you selected:\n\n👉 {{$json.message.replace(/\\|/g, \"\\n👉 \")}}\n\nYou can update the quantities and let me know — I’ll place the order immediately for you!;",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7536,
        672
      ],
      "id": "deac5331-cc15-4c70-a8fd-926d5fab34cb",
      "name": "Error message1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "018b7715-2bfd-48f9-b1da-63fb9b6209f0",
              "name": "msg_to_send",
              "value": "=Hey! 😊\nI checked the items you added to your cart.\n\nGood news: Everything you selected is in stock and ready to go!\nPlease confirm your order to continue.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7536,
        864
      ],
      "id": "1ed42db6-549e-4285-980b-4c815ff57299",
      "name": "Succes Msg1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable1'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7760,
        672
      ],
      "id": "af578f79-b7e7-4468-a7e8-772a110c3920",
      "name": "Send msg3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
              "name": "catalog_id",
              "value": "896416602722897",
              "type": "string"
            },
            {
              "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
              "name": "msg_to",
              "value": "={{ $json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6640,
        768
      ],
      "id": "ca094899-ebe2-4a2c-9dd4-1d5472f4c25c",
      "name": "Set Variable3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Succes Msg1').item.json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields4').item.json.unique_id_of_order }}_confirm\",\n            \"title\": \"Confirm\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields4').item.json.unique_id_of_order }}_cancel\",\n            \"title\": \"Cancel\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8880,
        864
      ],
      "id": "d75fb3bb-5163-45dc-80a6-5421a65dcbd8",
      "name": "HTTP Request3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "htaS8wafCR4Eh7v5",
          "mode": "list",
          "cachedResultName": "Alister Order Stage",
          "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "phone_no": "={{ $('Edit Fields4').item.json.user_phone_no }}",
            "unique_order_id": "={{ $('Edit Fields4').item.json.unique_id_of_order }}",
            "user_name": "={{ $('Edit Fields4').item.json.user_name }}",
            "product_id": "={{ $json.product_retailer_id }}",
            "product_quantity": "={{ $json.quantity }}",
            "product_title": "={{ $json.title }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "unique_order_id",
              "displayName": "unique_order_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "user_name",
              "displayName": "user_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "phone_no",
              "displayName": "phone_no",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_id",
              "displayName": "product_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_title",
              "displayName": "product_title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_quantity",
              "displayName": "product_quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        8432,
        864
      ],
      "id": "c116f334-9091-4ea5-a660-637961138917",
      "name": "Insert row1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c618dbc9-40d0-4cd6-b164-60a462ceb16e",
              "name": "user_selected_product",
              "value": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].order.product_items }}",
              "type": "array"
            },
            {
              "id": "41163f52-519c-4a26-8f60-c5cbb759a21c",
              "name": "unique_id_of_order",
              "value": "={{ 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 10000) }}",
              "type": "string"
            },
            {
              "id": "21053b3f-1909-4bb3-9888-561355df41bc",
              "name": "user_name",
              "value": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "36d108e7-b62c-4145-822c-640f588557a9",
              "name": "user_phone_no",
              "value": "={{ $node['Add this Variable1'].json.msg_to }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7760,
        864
      ],
      "id": "6682081e-274f-457a-9744-f869834b2bec",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "fieldToSplitOut": "user_selected_product",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        7984,
        864
      ],
      "id": "4ef84c57-31c7-409f-ae95-bac288089fd2",
      "name": "Split Out1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b414d52e-386d-4c0e-8eac-d0aeb8135ad6",
              "name": "order_id",
              "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id.split(\"_\")[0] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7088,
        -192
      ],
      "id": "2a594e44-4762-450f-8fe5-c334b2b46c8e",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 38109468,
          "mode": "list",
          "cachedResultName": "Order List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Phone Number": "={{ $json.phone_no }}",
            "User": "={{ $json.user_name }}",
            "Item_id": "={{ $json.product_id }}",
            "Item": "={{ $json.product_title }}",
            "Quantity": "={{ $json.product_quantity }}",
            "Date": "={{ $now.setZone('Asia/Kolkata').format('yyyy-MM-dd T') }}",
            "Status": "Order Placed",
            "Order ID": "={{ $('Edit Fields5').item.json.order_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Order ID",
              "displayName": "Order ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "User",
              "displayName": "User",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Item_id",
              "displayName": "Item_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Item",
              "displayName": "Item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        7536,
        -192
      ],
      "id": "e31cc4fe-af7e-4315-b5f9-0ce73a0f325e",
      "name": "Append row in sheet3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "htaS8wafCR4Eh7v5",
          "mode": "list",
          "cachedResultName": "Alister Order Stage",
          "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "unique_order_id",
              "keyValue": "={{ $('Edit Fields5').item.json.order_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        7312,
        -192
      ],
      "id": "5f591512-f83e-458f-aa38-490a592efd42",
      "name": "Get row(s)1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "263eb8a1-0b0b-4e98-bede-2ca52dc566ed",
              "leftValue": "={{ $json.success }}",
              "rightValue": "false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7312,
        768
      ],
      "id": "c6c05ead-10e0-4432-93e3-936ee1414947",
      "name": "If Stock is available1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        8656,
        864
      ],
      "id": "7defc8a5-18e5-4d8f-b1cc-0035e56dd45e",
      "name": "Limit2"
    },
    {
      "parameters": {
        "jsCode": "// Load data from nodes\nconst product_data = $(\"Get Stock data1\").all().map(item => item.json);\nconst user_selected_data = $(\"Split Out1\").all().map(item => item.json);\n\n// Final output list\nlet matched = [];\n\n// Loop through user-selected items\nfor (const userItem of user_selected_data) {\n  \n  const selectedId = String(userItem.product_retailer_id).trim();\n\n  // Find matching product from stock data\n  const stockItem = product_data.find(\n    p => String(p.id).trim() === selectedId\n  );\n\n  // If matched → append combined data\n  if (stockItem) {\n    matched.push({\n      product_retailer_id: selectedId,\n      title: stockItem.title,\n      quantity: userItem.quantity\n    });\n  }\n}\n\n// Return result\nreturn matched.map(m => ({ json: m }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8208,
        864
      ],
      "id": "ab108230-0356-433b-80fd-6a92614d77df",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Your Order has been placed and we will deliver soon\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7984,
        -192
      ],
      "id": "83515499-766c-4aff-8657-9f4c45ae2ccb",
      "name": "Send msg4",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        7760,
        -192
      ],
      "id": "514bc4e1-74f1-4a7c-a3ac-5303e10bf704",
      "name": "Limit3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Your Order Has Been Cancel \\nIf you want inital menu, type 'Menu' or 'Hello'\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7088,
        384
      ],
      "id": "793f5989-1690-41b7-81fb-266a75be34d4",
      "name": "Cancel Msg1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"This Feature is under Development \\nIf you want inital menu, type 'Menu' or 'Hello'\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7088,
        192
      ],
      "id": "35d388c9-9397-42ad-9ee2-cf4a5f46fd7b",
      "name": "FAQ msg1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "content": "# Official Meta Connection via Catalog & Template (Old Way)",
        "height": 1392,
        "width": 3520
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5568,
        -224
      ],
      "id": "9f0894db-6b28-473f-bac2-b6d0c38058c9",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 38109468,
          "mode": "list",
          "cachedResultName": "Order List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Phone Number",
              "lookupValue": "={{ $json.msg_to }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        7088,
        0
      ],
      "id": "b39aa828-1740-432e-b093-4d42abde15ee",
      "name": "Get row(s) in sheet6",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Load orders from sheet4\nconst order_list = $(\"Get row(s) in sheet6\").all().map(item => item.json);\n\n// If empty\nif (!order_list.length) {\n  return [{ json: { message: \"You have no orders at the moment.\" } }];\n}\n\n// Group by Order ID\nconst grouped = {};\n\nfor (const row of order_list) {\n  const orderId = row[\"Order ID\"];\n\n  if (!grouped[orderId]) {\n    grouped[orderId] = {\n      items: [],\n      status: row.Status,\n    };\n  }\n\n  grouped[orderId].items.push({\n    item: row.Item,\n    quantity: row.Quantity,\n  });\n}\n\n// Build the message\nlet msg = \"📦 *Your Order Summary*\\n\\nHere’s a quick overview of all your recent orders:\\n\\n\";\n\nfor (const [orderId, data] of Object.entries(grouped)) {\n  const totalQty = data.items.reduce((sum, i) => sum + Number(i.quantity), 0);\n\n  msg += `🧾 *Order ID:* ${orderId}\\n`;\n  msg += `📦 *Total Items:* ${totalQty}\\n`;\n  msg += `📌 *Status:* ${data.status}\\n`;\n  msg += `🛍️ *Items:*\\n`;\n\n  for (const item of data.items) {\n    msg += `   • ${item.item} ×${item.quantity}\\n`;\n  }\n\n  msg += `\\n`;\n}\n\n// msg += \"💬 If you'd like to *track*, *change*, or *cancel* any order, just reply with the Order ID (e.g., *ORD-1764326177122-8178*).\";\n\n// Return final message\nreturn [{ json: { message: msg } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7312,
        0
      ],
      "id": "a25040dc-0e22-4fe3-baa4-f504f44cd36a",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": {{ JSON.stringify($json.message) }}\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7536,
        0
      ],
      "id": "9c8c3bcc-f3c3-45a9-8018-cb60f2eff792",
      "name": "Send msg5",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
              "name": "catalog_id",
              "value": "896416602722897",
              "type": "string"
            },
            {
              "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
              "name": "msg_to",
              "value": "={{ $json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "bafa1b69-5374-4c42-ac6c-766dab6487e3",
              "name": "phone_number_id",
              "value": "924412964080974",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6192,
        768
      ],
      "id": "7e683a33-542f-4d66-854e-a0247fab40af",
      "name": "Add this Variable1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"product_list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"Baby Care Products\"\n    },\n    \"body\": {\n      \"text\": \"Check out our premium baby care collection\"\n    },\n    \"footer\": {\n      \"text\": \"Best prices guaranteed\"\n    },\n    \"action\": {\n      \"catalog_id\": \"896416602722897\",\n      \"sections\": [\n        {\n          \"title\": \"Pack of 30\",\n          \"product_items\": [\n{\"product_retailer_id\":\"1\"},\n{\"product_retailer_id\":\"2\"},\n{\"product_retailer_id\":\"6\"},\n{\"product_retailer_id\":\"7\"},\n{\"product_retailer_id\":\"8\"},\n{\"product_retailer_id\":\"9\"}\n]\n        },\n        {\n          \"title\": \"Pack of 140\",\n          \"product_items\": [\n{\"product_retailer_id\":\"3\"},{\"product_retailer_id\":\"4\"},{\"product_retailer_id\":\"5\"}]\n        }\n      ]\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8448,
        592
      ],
      "id": "8d1f7cd2-536f-4595-a009-667c1e49fc4e",
      "name": "Send Multi Product Category1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Read all incoming rows\nconst rows = $input.all().map(i => i.json);\n\n// Utility: normalize category title\nfunction normalizeCategory(cat) {\n  if (!cat) return \"Unknown Pack\";\n  return cat\n    .toLowerCase()\n    .replace(/\\bpack\\b/, \"Pack\")\n    .replace(/\\bof\\b/, \"of\")\n    .replace(/\\s+/g, \" \")\n    .replace(/^./, c => c.toUpperCase());\n}\n\n// Group by category\nconst grouped = {};\n\nfor (const row of rows) {\n  const category = normalizeCategory(row.custom_label_0);\n  const id = row.id;\n\n  if (!category || !id) continue;\n\n  if (!grouped[category]) {\n    grouped[category] = {\n      title: category,\n      product_items: []\n    };\n  }\n\n  grouped[category].product_items.push({\n    product_retailer_id: String(id)\n  });\n}\n\n// Convert grouped object → array\nconst result = Object.values(grouped);\n\n// Return both raw & stringified output\nreturn [\n  {\n    json: {\n      items: result,\n      items_stringified: JSON.stringify(result, null, 2)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1376,
        -1264
      ],
      "id": "7ae0093b-8aac-4ff6-b0e5-5df529d08be7",
      "name": "Code in JavaScript6"
    },
    {
      "parameters": {
        "content": "## Due to payment this Marketing template for catalog is not working, otherwise price strike could have worked here ",
        "height": 384,
        "width": 560
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        384,
        -3984
      ],
      "id": "50bcde49-c97e-44f7-bf62-3774d627ff75",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8adf164e-e24e-4693-ad9c-540031adbc66",
              "name": "phone_number_id",
              "value": "=924412964080974",
              "type": "string"
            },
            {
              "id": "e90a0536-0be2-43e2-9580-4fd111f19d57",
              "name": "passphrase",
              "value": "=lakshit",
              "type": "string"
            },
            {
              "id": "678e1e3f-c93a-4339-bd3a-77f3b6a2f832",
              "name": "WABA_id",
              "value": "=1513036893303968",
              "type": "string"
            },
            {
              "id": "1dfdb50b-aae0-4614-9923-d73c50aa9cc9",
              "name": "app_version",
              "value": "v24.0",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1536,
        -3872
      ],
      "id": "38042ab4-07e5-4650-95d1-5260dff19649",
      "name": "set_variable"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "V6ljo9LKuMy4j8CI",
          "mode": "list",
          "cachedResultName": "Meta Sign in Keys",
          "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/V6ljo9LKuMy4j8CI"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "2"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "publicKey": "={{ $('Code in JavaScript7').item.json.publicKey }}",
            "privateKey": "={{ $('Code in JavaScript7').item.json.privateKey }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "publicKey",
              "displayName": "publicKey",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "privateKey",
              "displayName": "privateKey",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -864,
        -3872
      ],
      "id": "301b4410-5e01-4fd5-8868-843cf131cccf",
      "name": "Set Public & Private Key"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/{{ $('set_variable').item.json.app_version }}/{{ $('set_variable').item.json.phone_number_id }}/whatsapp_business_encryption",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "business_public_key",
              "value": "={{ $json.publicKey }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1088,
        -3872
      ],
      "id": "dbbdbf22-0386-49a4-af5e-28face5cadb7",
      "name": "Send Normal Message3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - RSA Key Pair Generator for WhatsApp Flows (CORRECT)\nconst crypto = require('crypto');\n\n// Generate RSA key pair (UNENCRYPTED)\nconst keyPair = crypto.generateKeyPairSync(\"rsa\", {\n  modulusLength: 2048,\n  publicKeyEncoding: {\n    type: \"spki\",\n    format: \"pem\",\n  },\n  privateKeyEncoding: {\n    type: \"pkcs8\",\n    format: \"pem\"\n  },\n});\n\nreturn {\n  json: {\n    success: true,\n    message: \"Unencrypted RSA key pair generated for WhatsApp Flows\",\n    privateKey: keyPair.privateKey,\n    publicKey: keyPair.publicKey,\n    instructions: {\n      step1: \"Store PRIVATE_KEY securely (ENV / Secrets)\",\n      step2: \"Upload PUBLIC_KEY to Meta WhatsApp Flow Encryption\",\n      step3: \"Do NOT add passphrase or cipher\",\n    }\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        -3872
      ],
      "id": "7a841f33-8011-4b27-b39f-38fc4f71930f",
      "name": "Code in JavaScript7"
    },
    {
      "parameters": {
        "content": "## Generate Private and Pubic Key and Register Sign Up Public Key",
        "height": 240,
        "width": 1200
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1872,
        -3952
      ],
      "id": "ba3bbddf-b4da-4297-a5b0-9923b0ffa5c2",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require(\"crypto\");\n\n// ============================\n// INPUTS\n// ============================\n\n// Private key stored in previous node / credentials / set node\nconst PRIVATE_KEY = $input.first().json.privateKey\n  .replace(/\\\\n/g, \"\\n\")\n  .trim();\n\n// Encrypted payload from Meta\nconst encrypted_aes_key = $('Add this Variable').first().json.encrypted_aes_key;\nconst encrypted_flow_data = $('Add this Variable').first().json.encrypted_flow_data;\nconst initial_vector = $('Add this Variable').first().json.initial_vector;\n\n// ============================\n// 1. DECRYPT AES KEY (RSA)\n// ============================\nconst aesKeyBuffer = crypto.privateDecrypt(\n  {\n    key: crypto.createPrivateKey(PRIVATE_KEY),\n    padding: crypto.constants.RSA_PKCS1_OAEP_PADDING,\n    oaepHash: \"sha256\",\n  },\n  Buffer.from(encrypted_aes_key, \"base64\")\n);\n\n// ============================\n// 2. DECRYPT FLOW DATA (AES-128-GCM)\n// ============================\nconst flowDataBuffer = Buffer.from(encrypted_flow_data, \"base64\");\nconst ivBuffer = Buffer.from(initial_vector, \"base64\");\n\nconst TAG_LENGTH = 16;\nconst encryptedBody = flowDataBuffer.subarray(0, -TAG_LENGTH);\nconst authTag = flowDataBuffer.subarray(-TAG_LENGTH);\n\nconst decipher = crypto.createDecipheriv(\n  \"aes-128-gcm\",\n  aesKeyBuffer,\n  ivBuffer\n);\ndecipher.setAuthTag(authTag);\n\nconst decryptedBody = JSON.parse(\n  Buffer.concat([\n    decipher.update(encryptedBody),\n    decipher.final(),\n  ]).toString(\"utf-8\")\n);\n\n// ============================\n// OUTPUT FOR NEXT NODES\n// ============================\nreturn [\n  {\n    json: {\n      decryptedBody,      // Plain WhatsApp Flow JSON\n      aesKeyBuffer,       // Needed for encryption\n      ivBuffer,           // Needed for encryption\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        -2768
      ],
      "id": "e0dd6ba0-87bd-425c-a38b-02fc42da91c6",
      "name": "Decryption"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "V6ljo9LKuMy4j8CI",
          "mode": "list",
          "cachedResultName": "Meta Sign in Keys",
          "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/V6ljo9LKuMy4j8CI"
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -1488,
        -2768
      ],
      "id": "ed2e0fce-1ca1-44be-ad83-a28651639494",
      "name": "Get Private Key"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require(\"crypto\");\n\n// ============================\n// 1. RESPONSE PAYLOAD\n// ============================\nconst responsePayload = $input.first().json.response_to_send;\n\n// ============================\n// 2. REBUILD BUFFERS (IMPORTANT)\n// ============================\nconst aesKeyBuffer = Buffer.from($('Decryption').first().json.aesKeyBuffer.data);\nconst ivBuffer = Buffer.from($('Decryption').first().json.ivBuffer.data);\n\n// ============================\n// 3. FLIP IV (MANDATORY)\n// ============================\nconst flippedIV = Buffer.from(ivBuffer.map(b => ~b));\n\n// ============================\n// 4. ENCRYPT RESPONSE\n// ============================\nconst cipher = crypto.createCipheriv(\n  \"aes-128-gcm\",\n  aesKeyBuffer,\n  flippedIV\n);\n\nconst encryptedResponse = Buffer.concat([\n  cipher.update(JSON.stringify(responsePayload), \"utf-8\"),\n  cipher.final(),\n  cipher.getAuthTag(),\n]);\n\n// ============================\n// 5. RETURN BASE64 STRING\n// ============================\nreturn [\n  {\n    json: {\n      response: encryptedResponse.toString(\"base64\"),\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        -2848
      ],
      "id": "0011a01a-09f4-49dd-9070-9bf14abae1fb",
      "name": "Encryption"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.response }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1328,
        -2848
      ],
      "id": "2ee9bf4b-2dff-4bd0-a242-6d7d1de1db5b",
      "name": "Response to Meta"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.decryptedBody.screen }}",
                    "rightValue": "USER_INFO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4e16a13c-f435-459e-b8b8-76626417efc6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "User Info"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "9bb75abd-d2ed-4f8f-a87d-8a8a01b235ea",
                    "leftValue": "={{ $json.decryptedBody.screen }}",
                    "rightValue": "ADDRESS",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Address"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -896,
        -2736
      ],
      "id": "96a54364-7187-4b22-bc9e-04849bd85d38",
      "name": "Screen Routing"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.decryptedBody.action }}",
                    "rightValue": "ping",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f3c1114e-81b5-41c3-a80c-a986bf16c144"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Health Check"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "375b85ac-66d3-4e85-bf8d-acb7541d24b8",
                    "leftValue": "={{ $json.decryptedBody.action }}",
                    "rightValue": "INIT",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "INIT"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "a006f352-419c-41df-8b88-7e88c975f284",
                    "leftValue": "={{ $json.decryptedBody.action }}",
                    "rightValue": "submit",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Submit"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "726f66a0-2a40-4614-bafe-9d8fe8241388",
                    "leftValue": "={{ $json.decryptedBody.action }}",
                    "rightValue": "data_exchange",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Data Exchange"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -1088,
        -2816
      ],
      "id": "206576c4-86a7-44b7-b274-8c368ce7cc16",
      "name": "Switch3"
    },
    {
      "parameters": {
        "jsCode": "// Pincode coming from Decryption node\nconst targetPincode = String($(\"Decryption\").item.json.decryptedBody.data.pincode);\n\n// All rows coming from Google Sheets node\nconst sheetItems = items;\n\n// Check if pincode exists in Google Sheet data\nconst exists = sheetItems.some(item => {\n  return String(item.json.pincode) === targetPincode;\n});\n\n// Return true / false\nreturn [\n  {\n    json: {\n      pincode: targetPincode,\n      exists: exists\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        -2752
      ],
      "id": "2ebcc4ae-4b98-4d12-945d-ec10e92b8838",
      "name": "Check Pincode"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 836450484,
          "mode": "list",
          "cachedResultName": "Pincode List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=836450484"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -656,
        -2752
      ],
      "id": "7b8e1ad0-1af9-46b5-ba74-0bd50a3966c9",
      "name": "Get Servicable Pincode",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "8cdaaee7-bbcc-4cb6-97ab-78b44d35a5c2",
              "leftValue": "={{ $json.exists }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -304,
        -2752
      ],
      "id": "3fd6e732-67be-4fef-8f22-dfc6903a1533",
      "name": "Pincode Routing"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
              "name": "response_to_send",
              "value": "={\n  \"screen\": \"ADDRESS\",\n  \"data\": {}\n}\n",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        560,
        -2768
      ],
      "id": "247c205d-fb96-4fb4-8ba1-694ab5279e16",
      "name": "Address Screen"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
              "name": "response_to_send",
              "value": "={\n  \"screen\": \"NOT_DELIVERABLE\",\n  \"data\": {}\n}\n",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        -2640
      ],
      "id": "a2ed1348-3d75-4b26-a461-48dc16510ae8",
      "name": "Not deliverable Screen"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1124433720,
          "mode": "list",
          "cachedResultName": "User Info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Phone Number": "={{ $node['Decryption'].json.decryptedBody.flow_token }}",
            "Name from API": "=",
            "User Entered Name": "={{ $node['Decryption'].json.decryptedBody.data.name }}",
            "Pincode": "={{ $node['Decryption'].json.decryptedBody.data.pincode }}"
          },
          "matchingColumns": [
            "Phone Number"
          ],
          "schema": [
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name from API",
              "displayName": "Name from API",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "User Entered Name",
              "displayName": "User Entered Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Pincode",
              "displayName": "Pincode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address Line 1",
              "displayName": "Address Line 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Address Line 2",
              "displayName": "Address Line 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "City ",
              "displayName": "City ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "State",
              "displayName": "State",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -112,
        -2784
      ],
      "id": "cbac414e-80ae-4e30-aa63-8750a4adce53",
      "name": "Add User Info",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1124433720,
          "mode": "list",
          "cachedResultName": "User Info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Phone Number": "={{ $node['Decryption'].json.decryptedBody.flow_token }}",
            "Address Line 1": "={{ $json.decryptedBody.data.line1 }}",
            "Address Line 2": "={{ $json.decryptedBody.data.line2 }}",
            "City ": "={{ $json.decryptedBody.data.city }}",
            "State": "={{ $json.decryptedBody.data.state }}"
          },
          "matchingColumns": [
            "Phone Number"
          ],
          "schema": [
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name from API",
              "displayName": "Name from API",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "User Entered Name",
              "displayName": "User Entered Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pincode",
              "displayName": "Pincode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Address Line 1",
              "displayName": "Address Line 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Address Line 2",
              "displayName": "Address Line 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "City ",
              "displayName": "City ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "State",
              "displayName": "State",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -64,
        -2512
      ],
      "id": "f705fbb9-2d70-4626-9bc5-58440e01d78e",
      "name": "Add User Info1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
              "name": "response_to_send",
              "value": "={\n  data: {\n    status: \"active\",\n  },\n}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        -3216
      ],
      "id": "56521ad5-5062-48e8-b8fd-5faaba2db2e0",
      "name": "Health Check"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
              "name": "response_to_send",
              "value": "={\n  \"screen\": \"USER_INFO\",\n  \"data\": {}\n}\n",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        -3024
      ],
      "id": "c9838b86-fec5-4581-abfb-ec343376f893",
      "name": "Init Screen &data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f8925f46-cb8a-4c44-bb2b-edfd2e69269b",
              "leftValue": "={{ $json.encrypted_flow_data }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "5e773f01-2501-43ab-b7a1-372349187f29",
              "leftValue": "={{ $json.encrypted_aes_key }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "b8351a34-36d5-4c95-9006-6f7f59910193",
              "leftValue": "={{ $json.initial_vector }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2064,
        -1872
      ],
      "id": "a7322999-7a22-4232-8d81-b752f00e3c06",
      "name": "Is Flow Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/{{ $('Add this Variable').item.json.app_version }}/{{ $('Add this Variable').item.json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient_type\": \"individual\",\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"flow\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.postimg.cc/c44WrvSB/Whats-App-Image-2026-01-18-at-19-52-45.jpg\"\n      }\n    },\n    \"body\": {\n      \"text\": \"We help parents get safe and comfortable diapers delivered to their doorstep.\\n\\nBefore you browse products, we just need your name and PIN code to check delivery availability in your area. It’ll only take a moment 😊\\n\"\n    },\n    \"footer\": {\n      \"text\": \"🔒 Your details are safe and used only for delivery\"\n    },\n    \"action\": {\n      \"name\": \"flow\",\n      \"parameters\": {\n        \"flow_message_version\": \"3\",\n        \"flow_id\": \"{{ $('Add this Variable').item.json.user_flow_id }}\",\n        \"flow_cta\": \"Get Started\",\n        \"flow_token\": \"{{ $('Add this Variable').item.json.msg_to }}\"\n      }\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        592,
        -1776
      ],
      "id": "919a372f-5a15-4777-b298-bb0648838261",
      "name": "Send User Info Flow",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1124433720,
          "mode": "list",
          "cachedResultName": "User Info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Phone Number",
              "lookupValue": "={{ $json.msg_to }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        48,
        -1600
      ],
      "id": "daae6355-88db-4e15-9d84-53996ef0198a",
      "name": "Fetch User Info",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "ecf1c08a-71e3-4540-9acf-acf52dc5c5a8",
              "leftValue": "={{ $(\"Fetch User Info\").item.json.keys() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        256,
        -1600
      ],
      "id": "b7c3a9f0-f1c4-477e-9e09-045547f0431b",
      "name": "Is User First Time"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi {{ $('Add this Variable').item.json.user_name }} 👋 \\nWelcome to Butruu! You can:\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"order_status\",\n            \"title\": \"Order Status\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ask_faq\",\n            \"title\": \"Ask FAQs\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -320,
        -832
      ],
      "id": "f78086e0-6261-45f0-a49d-108cd49c024e",
      "name": "Initial Btn Msg",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Here’s the delivery information we have saved for you:\\n\\n👤 *Name:* {{ $json['User Entered Name'] }}\\n📍 *PIN Code:* {{ $json.Pincode }}\\n🏠 *Delivery Address:*\\n  - *Line 1:* {{ $json['Address Line 1'] }}\\n  - *Line 2:* {{ $json['Address Line 2'] }}\\n  - *City:* {{ $json['City '] }}\\n  - *State:* {{ $json.State }}\\n\\nIf everything looks correct, you can continue and browse products.\\nIf you’d like to change anything, you can update it now.\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"update_user_info\",\n            \"title\": \"Update Address\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"use_saved_details\",\n            \"title\": \"Continue\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        592,
        -1568
      ],
      "id": "3fc8fa4e-7335-484f-97a0-dc3b4e059da4",
      "name": "Ask User to Update Info",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/{{ $('Switch1').item.json.app_version }}/{{ $('Switch1').item.json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient_type\": \"individual\",\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $(\"Switch1\").item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"flow\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.postimg.cc/c44WrvSB/Whats-App-Image-2026-01-18-at-19-52-45.jpg\"\n      }\n    },\n    \"body\": {\n      \"text\": \"No problem at all 👍\\n\\nYou can update your delivery details below to make sure everything is correct.\\n\\nPlease review and edit your name, PIN code, or address as needed.\"\n    },\n    \"footer\": {\n      \"text\": \"🔒 Your details are safe and used only for delivery\"\n    },\n    \"action\": {\n      \"name\": \"flow\",\n      \"parameters\": {\n        \"flow_message_version\": \"3\",\n        \"flow_id\": \"{{ $(\"Switch1\").item.json.user_flow_id }}\",\n        \"flow_cta\": \"Update Details\",\n        \"flow_token\": \"{{ $(\"Switch1\").item.json.msg_to }}\",\n        \"flow_action_payload\": {\n            \"screen\": \"USER_INFO\",\n            \"data\": {\n                \"name\": \"{{ $json['User Entered Name'] }}\",\n                \"pincode\": \"{{ $json.Pincode }}\"\n            }\n        }\n      }\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        48,
        -1408
      ],
      "id": "8aaa8bbc-d559-45e6-98d9-35c46f917f31",
      "name": "Update User Info",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1124433720,
          "mode": "list",
          "cachedResultName": "User Info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Phone Number",
              "lookupValue": "={{ $json.msg_to }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -128,
        -1408
      ],
      "id": "85c6352a-9013-4620-8b37-e5ed148c7631",
      "name": "Fetch User Info1",
      "alwaysOutputData": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b8083ca9-23de-45ca-8615-2b331277a312",
              "name": "response_to_send",
              "value": "={{ $json.response_to_send }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        992,
        -2848
      ],
      "id": "e74a8b21-b313-4d16-9d9c-99629524ae44",
      "name": "Common Meta vari"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "263eb8a1-0b0b-4e98-bede-2ca52dc566ed",
              "leftValue": "={{ $json.success }}",
              "rightValue": "false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -560,
        -1152
      ],
      "id": "4939cfcd-6a1c-4eef-98c8-bf30a5a1cf64",
      "name": "If Stock is not available"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1124433720,
          "mode": "list",
          "cachedResultName": "User Info",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Phone Number",
              "lookupValue": "={{ $json['Phone Number'] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        48,
        -2784
      ],
      "id": "d6c5c5d0-1dd4-4310-8339-7d7f3aabbc51",
      "name": "Get address data",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "4aaba323-7670-4dfc-968c-d964e5e1696b",
              "leftValue": "={{ String($json['Address Line 1']) }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        256,
        -2784
      ],
      "id": "25130f94-3b82-4363-a79e-ac26a5d1afc4",
      "name": "Is address added"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
              "name": "response_to_send",
              "value": "={\n  \"screen\": \"ADDRESS\",\n  \"data\": {\n    \"line1\": \"{{ $json['Address Line 1'] }}\",\n    \"line2\": \"{{ $json['Address Line 2'] }}\",\n    \"city\": \"{{ $json['City '] }}\",\n    \"state\": \"{{ $json.State }}\"\n  }\n}\n",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        560,
        -2912
      ],
      "id": "e057a3ce-bea2-4eda-9cb0-3d853265826b",
      "name": "Address with Payload"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
              "name": "response_to_send",
              "value": "={\n  \"screen\": \"THANK_YOU\",\n  \"data\": {\n    \"message\": \"Address Added\"\n  }\n}\n",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        -2496
      ],
      "id": "fb519084-ce8c-4e79-bb70-03c7aed0a98e",
      "name": "Thank you Screen"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "a2b0f34c-009c-46d7-9957-a0d79ad21b5d",
              "leftValue": "={{ $('Parse Flow Response').item.json.status }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.3,
      "position": [
        -624,
        -1392
      ],
      "id": "ae20ebae-5a4c-4175-b7b7-bcad1556f165",
      "name": "Filter2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.msg }}",
        "options": {
          "systemMessage": "=## Role:\n- You are an intent-classification AI used inside a WhatsApp automation system powered by the Meta WhatsApp Cloud API.\n- Your primary responsibility is to analyze the user’s incoming message and classify it into exactly one of the following two categories:\n\n## Allowed Categories (STRICT)\n- GREETING\n- FAQ\n\nNo other category is allowed.\nDo not invent or infer extra intent types.\n\n#🧠 Classification Rules\n\n## 1️⃣ GREETING\nClassify the message as GREETING if ANY of the following conditions are true:\n- The user sends a greeting or salutation, including but not limited to:\n  - “hi”, “hello”, “hey”, “hii”, “hiii”\n  - “good morning”, “good evening”, “gm”, “gn”\n  - “namaste”, “hola”, “yo”, “sup”\n\n- The user is asking for the menu, even indirectly:\n  - “menu”\n  - “show menu”\n  - “options”\n  - “list”\n\n- The user sends a very short or vague message that is conversational but not a question:\n  - “hi there”\n  - “anyone?”\n  - “help”\n\n- The user makes spelling mistakes or informal variants related to greetings or menu:\n  - “menue”\n  - \"manu\"\n  - “mene”\n  - “servis”\n  - “optins”\n\n- The user intent is to start a conversation, not to seek a specific answer.\n\n## 2️⃣ FAQ\nClassify the message as FAQ if ALL of the following are true:\n- The user is asking a specific, informational question\n- The question relates to:\n  - Pricing\n  - Services\n  - Process\n  - Timelines\n  - Policies\n  - Support\n  - Technical or business-related information\n\n- The intent is to get an answer, not just start a conversation\nExamples of FAQ messages:\n- “What is the price of your service?”\n- “How long does the setup take?”\n- “Do you support WhatsApp automation?”\n- “What are your working hours?”\n- “How does this system work?”\n- “Can you integrate with CRM?”\n\n## ⚠️ Important Edge-Case Rules\n- If the message contains both greeting + question, classify as:\nFAQ\nExample: “Hi, what is your pricing?”\n\n- If the message is ambiguous, default to FAQ\n- Emojis alone like 👋 🙂 👉 classify as GREETING\n- Do not ask clarification questions for classification\n\n## Output rules (STRICT — DO NOT BREAK):\n\n- Return ONLY a valid JSON object.\n- Do NOT use markdown.\n- Do NOT wrap the response in ```json.\n- Do NOT add explanations, text, or comments.\n- Do NOT return arrays.\n- Always return both keys.\n\n## Output format (EXACT):\n\n{\n  \"category\": \"GREETING\" or \"FAQ\"\n}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -1088,
        -704
      ],
      "id": "9dda354d-adf0-408f-a990-80b69190fe1b",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-nano",
          "mode": "list",
          "cachedResultName": "gpt-5-nano"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -1088,
        -496
      ],
      "id": "4f2397bb-ad60-42e7-aa13-10af2304c5ec",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "L3P9Ae81haTD2rYm",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get raw AI output (string)\nconst raw = $json.text || $json.output || $json.response;\n\n// Defensive parsing\nlet parsed;\n\ntry {\n  parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;\n} catch (e) {\n  // Fallback if parsing fails\n  parsed = {\n    category: \"FAQ\"\n  };\n}\n\n// Return normalized output\nreturn [\n  {\n    json: {\n      category: parsed.category || \"FAQ\"\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        -704
      ],
      "id": "69cd0e8f-d7b9-4a2c-8703-6885d1d467dd",
      "name": "Code in JavaScript9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3928bbfc-c8a1-4e13-8d26-0552beb96287",
              "leftValue": "={{ $json.category }}",
              "rightValue": "GREETING",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -528,
        -704
      ],
      "id": "1599f144-05f0-4bf8-b739-b17a2ec3a069",
      "name": "If Greeting"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Set Variable').item.json.msg }}",
        "options": {
          "systemMessage": "=You are a customer support assistant for BUTRUU, a WhatsApp-based ordering platform for baby diapers.\n\nYour job is to answer user questions ONLY using the information provided in the uploaded FAQ document.\n\nSTRICT RULES (DO NOT BREAK):\n- Use the FAQ document as the single source of truth.\n- Answer only questions related to ordering, payments, products, delivery, address, invoices, cancellations, returns, offers, privacy, or support as mentioned in the FAQ.\n- If the answer is NOT present in the FAQ, politely say that the information is currently unavailable and suggest contacting support.\n- Do NOT invent, assume, or guess any information.\n- Do NOT provide legal, medical, or unrelated advice.\n- Do NOT mention internal systems, PDFs, files, or that you are an AI.\n\nRESPONSE STYLE:\n- Keep responses short, clear, and WhatsApp-friendly.\n- Use simple language suitable for all users.\n- Be polite, helpful, and reassuring.\n- Use bullet points only when it improves clarity.\n- Avoid long paragraphs.\n\nWHATSAPP CONTEXT:\n- Assume the user is chatting on WhatsApp.\n- Do NOT use markdown formatting.\n- Do NOT use emojis excessively (0–1 max, only if natural).\n- Do NOT ask unnecessary follow-up questions unless required.\n\nFALLBACK HANDLING:\n- If a user asks something outside the FAQ scope, respond with:\n  “I don’t have this information right now. Please tap ‘Talk to Support’ from the menu for further assistance.”\n\nYour goal is to provide accurate, consistent, and trustworthy answers that match the BUTRUU WhatsApp FAQ exactly.\n\nOne question which is missing in docs which need to be answered is \nQ: Are you a distributor?\nA: Provide a clear option to share email ID – contact@alistersbharat.com and phone number-9875578080 for further contact. \n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -48,
        -624
      ],
      "id": "8d4e2294-91f3-4df0-bcd9-8a84cf10a8e3",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-nano",
          "mode": "list",
          "cachedResultName": "gpt-5-nano"
        },
        "builtInTools": {
          "fileSearch": {
            "vectorStoreIds": "[\"vs_695fef6308b48191ba94f1750b8d3746\"]",
            "filters": "={{ null }}",
            "maxResults": "={{ null }}"
          }
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -112,
        -400
      ],
      "id": "58a9f6cc-eded-41b8-80d1-e52c60af2d90",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "48jg0IN7QfVXoF59",
          "name": "OpenAi Freelance"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Set Variable').item.json.msg_to }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        48,
        -400
      ],
      "id": "d75fd83e-d162-43b4-9d9d-80a7f3adc450",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.output.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        304,
        -624
      ],
      "id": "1e206d68-a064-4351-9e6c-cff52594885b",
      "name": "Send msg6",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Set Variable').item.json.msg_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -272,
        -624
      ],
      "id": "4bc7ab11-2a4b-4b75-9f43-1b8b86650049",
      "name": "Typing Indicator",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "41b1d588-e381-4281-9aa0-f57489ade13a",
              "leftValue": "={{ $('Get row(s) in sheet4').item.json.keys() }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        48,
        -2160
      ],
      "id": "fd36f564-8482-4035-981a-8ade99a68266",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi 😊\\nIt looks like you don’t have any active orders at the moment.\\n\\nYou can place a new order by tapping Browse Products below and choosing the diapers you need.\\nIf you need any help, I’m right here 💚\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        336,
        -2176
      ],
      "id": "c7a3e116-9e00-4513-85f0-a1d1a4ea0ebb",
      "name": "No Order Msg",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi {{ $json.user_name }} 👋 \\nWelcome to Butruu! You can:\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"order_status\",\n            \"title\": \"Order Status\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ask_faq\",\n            \"title\": \"Ask FAQs\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -976,
        -1712
      ],
      "id": "713c8cc1-7a94-450d-a125-29be3a4b5835",
      "name": "Initial Btn Msg1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Load orders from sheet4\nconst order_list = $(\"Get row(s) in sheet4\").all().map(item => item.json);\n\n// If empty\nif (!order_list.length) {\n  return [{ json: { message: \"You have no orders at the moment.\" } }];\n}\n\n// Group by Order ID\nconst grouped = {};\n\nfor (const row of order_list) {\n  const orderId = row[\"Order ID\"];\n\n  if (!grouped[orderId]) {\n    grouped[orderId] = {\n      items: [],\n      status: row.Status,\n    };\n  }\n\n  grouped[orderId].items.push({\n    item: row.Item,\n    quantity: row.Quantity,\n  });\n}\n\n// Build the message\nlet msg = \"📦 *Your Order Summary*\\n\\nHere’s a quick overview of all your recent orders:\\n\\n\";\n\nfor (const [orderId, data] of Object.entries(grouped)) {\n  const totalQty = data.items.reduce((sum, i) => sum + Number(i.quantity), 0);\n\n  msg += `🧾 *Order ID:* ${orderId}\\n`;\n  msg += `📦 *Total Items:* ${totalQty}\\n`;\n  msg += `📌 *Status:* ${data.status}\\n`;\n  msg += `🛍️ *Items:*\\n`;\n\n  for (const item of data.items) {\n    msg += `   • ${item.item} × ${item.quantity}\\n`;\n  }\n\n  msg += `\\n`;\n}\n\n// msg += \"💬 If you'd like to *track*, *change*, or *cancel* any order, just reply with the Order ID (e.g., *ORD-1764326177122-8178*).\";\n\n// Return final message\nreturn [{ json: { message: msg } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        -1856
      ],
      "id": "208fb11b-82f2-4a30-b4c1-37418dca6021",
      "name": "Code in JavaScript10"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Set Variable').item.json.msg }}",
        "options": {
          "systemMessage": "=You are BUTRUU WhatsApp FAQ Assistant, a polite, friendly, and helpful text-based assistant for Butruu customers.\n\n🎯 Your Role\nYour job is to answer customer questions strictly using the official BUTRUU FAQ information provided below.\nYou respond only through plain text messages. There are no buttons, menus, or UI elements—only user-typed messages.\n\n🧠 Knowledge & Accuracy Rules\n- The FAQ content below is your only source of truth.\n- Do not assume, invent, or guess any information.\n- Do not promise features, timelines, refunds, or services not explicitly mentioned.\n- If a question is outside the FAQs, reply politely:\n  - “I’m sorry, I don’t have that information right now. Please contact our support team for further help.”\n\n🗣️ Tone & Style\n- Keep replies short, clear, and WhatsApp-friendly.\n- Be warm, calm, and respectful—suitable for parents and caregivers.\n- Use simple language; avoid technical or internal terms.\n- Do not mention AI, systems, workflows, or automation.\n- Emojis are allowed but must be minimal and friendly.\n\n🔁 Conversation Guidance\n- Answer only what the user asks.\n- If the user asks multiple questions, respond in a clear, structured way.\n- If the user seems unsure what to ask, gently encourage them to ask their question in plain words.\n- If the user wants to start over or see general options, inform them that they can type “hello” or “menu”.\n\n🚫 Hard Restrictions\n- No express or same-day delivery.\n- No order cancellation after dispatch.\n- No returns for opened diaper packs.\n- No delivery confirmation for non-serviceable pincodes.\n- No medical advice beyond the FAQs.\n\n📚 OFFICIAL BUTRUU FAQ KNOWLEDGE BASE\n\n(Use this content exactly as provided, without modification or expansion.)\n\n## Ordering\n- Orders can be placed directly on WhatsApp by selecting products and confirming delivery details.\n- Products can be edited before final confirmation only.\n- Order confirmation is sent after payment and address confirmation.\n- Order status includes: Order Placed, Order Dispatched, Order Delivered.\n\n## Payments\n- Payment options include UPI, online payments, and Cash on Delivery (if available).\n- If payment fails, users can retry or choose COD if available. No amount is deducted.\n\n## Product & Usage\n- Diaper sizes:\n  - Small (S): Up to 7 kg\n  - Medium (M): 7–12 kg\n  - Large (L): 9–14 kg\n- Diapers are dermatologically tested and baby-safe.\n- Regular diaper changes help prevent rashes.\n- Babies usually need 4–5 diapers per day on average.\n\n## Delivery\n- Delivery usually takes 1–2 working days.\n- Express delivery is not available.\n- Non-serviceable pincodes are informed politely.\n- Delivery depends on courier availability.\n\n## Address & Invoice\n- Addresses can be saved or updated before dispatch.\n- Invoice is sent on WhatsApp after order confirmation.\n- Prices include applicable taxes.\n\n## Cancellations & Issues\n- Orders can be cancelled only before dispatch.\n- Address changes are allowed only before dispatch.\n- Damaged or wrong products must be reported within 24 hours with photos.\n- Opened diaper packs are non-returnable.\n\n## Repeat, Bulk & Offers\n- Previous orders can be reordered.\n- Bulk and repeat orders are supported.\n- Offers are included in WhatsApp prices and may change.\n- Order updates are sent on WhatsApp.\n\n## Privacy & Support\n- Customer data is securely stored and used only for order processing.\n- Support is available during working hours.\n\n💚 Core Principle\nAlways prioritize clarity, honesty, and care.\nEvery response should make the customer feel supported and confident."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -352,
        -208
      ],
      "id": "0e2712b0-f1e5-458b-b468-4bd4fc52b5e2",
      "name": "Backup agent with all info without file"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "message_id",
              "value": "={{ $json.message_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -2672,
        -1872
      ],
      "id": "90c5f8f9-094a-4a6b-aae8-8dbb3d312bf5",
      "name": "Search by Message ID"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cfed853-fd48-4548-93f0-4331ef97a502",
              "name": "message_id",
              "value": "={{ $json.body.entry[0].changes[0].value.messages?.[0]?.id || $json.body.entry[0].changes[0].value.statuses?.[0]?.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2880,
        -1872
      ],
      "id": "96993af3-f70f-4ff0-a7c6-4b55b1e822aa",
      "name": "Common Variable"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "message_id",
              "value": "={{ $json.body.messages[0].id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -112,
        -832
      ],
      "id": "269cbb0c-52f6-4e90-a794-5c1e4aa0ed8b",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "respondWith": "noData",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1856,
        -1776
      ],
      "id": "043d57d0-5c4e-4498-ada7-573dd72b0e0e",
      "name": "Give meta 200 Success"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"🎉 Your order has been placed successfully!\\n\\nWe’re preparing it for delivery and will update you soon.\\n\\nWould you like to share quick feedback about your ordering experience?\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"main_menu\",\n            \"title\": \"🏠 Main Menu\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"share_feedback\",\n            \"title\": \"💬 Share Feedback\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        736,
        -2352
      ],
      "id": "26831b99-253a-4d91-bb01-8ff8dac0aa6c",
      "name": "Send Main Menu & Feedback",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/{{ $('Add this Variable').item.json.app_version }}/{{ $('Add this Variable').item.json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient_type\": \"individual\",\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"flow\",\n    \"body\": {\n      \"text\": \"Thanks for choosing to share your feedback 💙 \\n\\nPlease fill out the quick form below.\"\n    },\n    \"footer\": {\n      \"text\": \"It’ll take less than 30 seconds 😊\"\n    },\n    \"action\": {\n      \"name\": \"flow\",\n      \"parameters\": {\n        \"flow_message_version\": \"3\",\n        \"flow_id\": \"{{ $('Add this Variable').item.json.user_feedback_flow_id }}\",\n        \"flow_cta\": \"Start Feedback\",\n        \"flow_token\": \"user_feedback\"\n      }\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        48,
        -1728
      ],
      "id": "8d2471c1-c41d-4531-a2ae-d279c317b388",
      "name": "Share Feedback Flow ",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "1ecbf9a1-47ab-4e73-848f-51b0e9abfb44",
              "leftValue": "={{ $json.msg }}",
              "rightValue": "=/^(hi+|hey+|hello+|hola+|yo+|sup+|wassup+|what'?s\\s?up|greetings|good\\s?(morning|afternoon|evening)|menu|show\\s?menu|options|show\\s?options|help)[\\s!.,]*$/i",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1408,
        -704
      ],
      "id": "1d310002-23c7-4ea9-9734-b84774e4643b",
      "name": "Is Greeting Message"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst response_json = $('Whatsapp Bot Webhook').first().json.body.entry[0].changes[0].value.messages[0].interactive.nfm_reply.response_json;\nconsole.log(response_json)\n// Step 2: Parse response_json\nlet parsedResponseJson;\ntry {\n  parsedResponseJson = JSON.parse(response_json);\n} catch (error) {\n  throw new Error('Invalid JSON in response_json: ' + error.message);\n}\n\nconst status = parsedResponseJson.status\nconst flow_token = parsedResponseJson.flow_token\n\nreturn [\n  {\n    json: {\n      status,\n      flow_token,\n      parsed_json: parsedResponseJson\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        -1552
      ],
      "id": "a0769298-32da-4e73-acf3-6a4b36604ada",
      "name": "Parse Flow Response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "601047c8-ef22-41b1-8b84-6d1017a0b5e9",
              "leftValue": "={{ $('Parse Flow Response').item.json.flow_token }}",
              "rightValue": "user_feedback",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -816,
        -1552
      ],
      "id": "c395372d-d29a-4b45-a089-1b033adf96cd",
      "name": "Is User Response"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
          "mode": "list",
          "cachedResultName": "catalog_products",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2046972948,
          "mode": "list",
          "cachedResultName": "User Feedback",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=2046972948"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Phone Number": "={{ $('Add this Variable').item.json.msg_to }}",
            "Overall Exp": "={{ $('Parse Flow Response').item.json.parsed_json.overall_exp }}",
            "Issues": "={{ $('Parse Flow Response').item.json.parsed_json.issues }}",
            "Ease Use": "={{ $('Parse Flow Response').item.json.parsed_json.ease_use }}",
            "Clarity": "={{ $('Parse Flow Response').item.json.parsed_json.clarity }}",
            "Suggestions": "={{ $('Parse Flow Response').item.json.parsed_json.suggestions }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Overall Exp",
              "displayName": "Overall Exp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Issues",
              "displayName": "Issues",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Ease Use",
              "displayName": "Ease Use",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Clarity",
              "displayName": "Clarity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Suggestions",
              "displayName": "Suggestions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -624,
        -1648
      ],
      "id": "765a81fc-4346-49e4-9610-b2744585c770",
      "name": "Add User Feedback to Sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cZc9FZPSLRtIq9IL",
          "name": "Lakshit77 Account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Thank you for your feedback 💙\\n\\nWe truly appreciate you taking the time to share your experience with us.\\n\\nIf there’s anything else you’d like to explore, feel free to continue below 😊\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"main_menu\",\n            \"title\": \"🏠 Main Menu\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -416,
        -1648
      ],
      "id": "cb74dc2e-b986-4cc4-99cf-7025c275e5c4",
      "name": "Send Main Menu",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": {{ JSON.stringify($json.message) }}\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        816,
        -2000
      ],
      "id": "df8f3936-f6e8-4e3f-9cbd-df5170cf6918",
      "name": "Send Order Status",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        544,
        -2016
      ],
      "id": "3de64a26-ad06-4855-b2bd-6a1398c05d22",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        816,
        -2160
      ],
      "id": "d2242aa2-fd80-4ee1-b3cb-b328c6f91e89",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"That’s your complete order history.\\n\\nYou can continue from the main menu below.\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"main_menu\",\n            \"title\": \"Go back to Main Menu\"\n          }\n        }\n      ]\n    }\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1200,
        -2160
      ],
      "id": "08fc9b20-a062-4b6a-abd2-8c75198b7f75",
      "name": "Send Main Menu Message",
      "credentials": {
        "httpHeaderAuth": {
          "id": "iR5q4Pc809XWa04V",
          "name": "whatsapp wa-agent-alister app Lakshit"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        1024,
        -2160
      ],
      "id": "1783610e-f074-4a8e-b390-46e2a0808b13",
      "name": "Limit4"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Check if Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Template": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Initial Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "mapping_item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create List picker template OG": {
      "main": [
        [
          {
            "node": "Send Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mapping_item": {
      "main": [
        [
          {
            "node": "Create List picker template OG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Normal Message2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Normal Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Item ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "list_quantity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create List Quantity picker ": {
      "main": [
        [
          {
            "node": "Send Quantity Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "list_quantity": {
      "main": [
        [
          {
            "node": "Create List Quantity picker ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Item ID": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet1": {
      "main": [
        [
          {
            "node": "Confirmation Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmation Template": {
      "main": [
        [
          {
            "node": "Send Confirm Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Normal Message": {
      "main": [
        [
          {
            "node": "Send Initial Template1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet2": {
      "main": [
        [
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append row in sheet": {
      "main": [
        [
          {
            "node": "Send Normal Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp Bot Webhook": {
      "main": [
        [
          {
            "node": "Check webhook configure parameter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Common Variable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check webhook configure parameter": {
      "main": [
        [
          {
            "node": "Verify Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variable": {
      "main": [
        [
          {
            "node": "Is Greeting Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Initial Template": {
      "main": [
        []
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Add this Variable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Interative Type Route": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse Flow Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet3": {
      "main": [
        [
          {
            "node": "Code in JavaScript6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s) in sheet4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FAQ msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancel Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch User Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s) in sheet3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch User Info1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Initial Btn Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Share Feedback Flow ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "set_variable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compliance Info Post": {
      "main": [
        [
          {
            "node": "Compliance Info Get",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Routing": {
      "main": [
        [
          {
            "node": "Interative Type Route",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Variable2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Variable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Stock data": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "If Stock is not available",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error message": {
      "main": [
        [
          {
            "node": "Send msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variable2": {
      "main": [
        [
          {
            "node": "Get Stock data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send msg": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Succes Msg": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        []
      ]
    },
    "Insert row": {
      "main": [
        [
          {
            "node": "Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Append row in sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Insert row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append row in sheet2": {
      "main": [
        [
          {
            "node": "Limit1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit1": {
      "main": [
        [
          {
            "node": "Send Main Menu & Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet4": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add this Variable": {
      "main": [
        [
          {
            "node": "Is Flow Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Compliance Info Post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp Bot Webhook1": {
      "main": [
        [
          {
            "node": "Check webhook configure parameter1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Filter1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check webhook configure parameter1": {
      "main": [
        [
          {
            "node": "Verify Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variable1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter1": {
      "main": [
        [
          {
            "node": "Add this Variable1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s) in sheet6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FAQ msg1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancel Msg1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get row(s) in sheet5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Interative Type Route1": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet5": {
      "main": [
        [
          {
            "node": "mapping_item2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mapping_item2": {
      "main": [
        [
          {
            "node": "Send Multi Product Template1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type Routing1": {
      "main": [
        [
          {
            "node": "Interative Type Route1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Variable3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Variable1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Stock data1": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "If Stock is available1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error message1": {
      "main": [
        [
          {
            "node": "Send msg3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Succes Msg1": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send msg3": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variable3": {
      "main": [
        [
          {
            "node": "Get Stock data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert row1": {
      "main": [
        [
          {
            "node": "Limit2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Split Out1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out1": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "Get row(s)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append row in sheet3": {
      "main": [
        [
          {
            "node": "Limit3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)1": {
      "main": [
        [
          {
            "node": "Append row in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Stock is available1": {
      "main": [
        [
          {
            "node": "Error message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Succes Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit2": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "Insert row1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit3": {
      "main": [
        [
          {
            "node": "Send msg4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet6": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Send msg5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add this Variable1": {
      "main": [
        [
          {
            "node": "Message Type Routing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript6": {
      "main": [
        [
          {
            "node": "Send Multi Product Category",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_variable": {
      "main": [
        [
          {
            "node": "Code in JavaScript7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Normal Message3": {
      "main": [
        [
          {
            "node": "Set Public & Private Key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript7": {
      "main": [
        [
          {
            "node": "Send Normal Message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Private Key": {
      "main": [
        [
          {
            "node": "Decryption",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Encryption": {
      "main": [
        [
          {
            "node": "Response to Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Screen Routing": {
      "main": [
        [
          {
            "node": "Get Servicable Pincode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Add User Info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Health Check",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Init Screen &data",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Screen Routing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decryption": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Pincode": {
      "main": [
        [
          {
            "node": "Pincode Routing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Servicable Pincode": {
      "main": [
        [
          {
            "node": "Check Pincode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pincode Routing": {
      "main": [
        [
          {
            "node": "Add User Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Not deliverable Screen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Not deliverable Screen": {
      "main": [
        [
          {
            "node": "Common Meta vari",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Address Screen": {
      "main": [
        [
          {
            "node": "Common Meta vari",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add User Info": {
      "main": [
        [
          {
            "node": "Get address data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add User Info1": {
      "main": [
        [
          {
            "node": "Thank you Screen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Health Check": {
      "main": [
        [
          {
            "node": "Common Meta vari",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Init Screen &data": {
      "main": [
        [
          {
            "node": "Common Meta vari",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Flow Response": {
      "main": [
        [
          {
            "node": "Get Private Key",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Give meta 200 Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch User Info": {
      "main": [
        [
          {
            "node": "Is User First Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is User First Time": {
      "main": [
        [
          {
            "node": "Send User Info Flow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ask User to Update Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch User Info1": {
      "main": [
        [
          {
            "node": "Update User Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response to Meta": {
      "main": [
        []
      ]
    },
    "Common Meta vari": {
      "main": [
        [
          {
            "node": "Encryption",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Stock is not available": {
      "main": [
        [
          {
            "node": "Error message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Succes Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get address data": {
      "main": [
        [
          {
            "node": "Is address added",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is address added": {
      "main": [
        [
          {
            "node": "Address with Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Address Screen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Address with Payload": {
      "main": [
        [
          {
            "node": "Common Meta vari",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Thank you Screen": {
      "main": [
        [
          {
            "node": "Common Meta vari",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter2": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code in JavaScript9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript9": {
      "main": [
        [
          {
            "node": "If Greeting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Greeting": {
      "main": [
        [
          {
            "node": "Initial Btn Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Typing Indicator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Send msg6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Typing Indicator": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "No Order Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search by Message ID": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Common Variable": {
      "main": [
        [
          {
            "node": "Search by Message ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initial Btn Msg": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Give meta 200 Success": {
      "main": [
        [
          {
            "node": "Message Type Routing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Greeting Message": {
      "main": [
        [
          {
            "node": "Initial Btn Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Flow Response": {
      "main": [
        [
          {
            "node": "Is User Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is User Response": {
      "main": [
        [
          {
            "node": "Add User Feedback to Sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Filter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add User Feedback to Sheet": {
      "main": [
        [
          {
            "node": "Send Main Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Order Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Order Status": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing": {
      "main": [
        [
          {
            "node": "Limit4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit4": {
      "main": [
        [
          {
            "node": "Send Main Menu Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Whatsapp Bot Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n.srv894857.hstgr.cloud",
            "user-agent": "facebookexternalua",
            "content-length": "657",
            "accept": "*/*",
            "accept-encoding": "deflate, gzip",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n.srv894857.hstgr.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "e8df5d5866a7",
            "x-hub-signature": "sha1=a83b7e350c2165572ca61c444a5688f9b60a0351",
            "x-hub-signature-256": "sha256=2b05d685bddea8bc1122d4d71eb9952b9175f6bb468719810da2ba6ad297fd1e",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "object": "whatsapp_business_account",
            "entry": [
              {
                "id": "1513036893303968",
                "changes": [
                  {
                    "value": {
                      "messaging_product": "whatsapp",
                      "metadata": {
                        "display_phone_number": "918169228947",
                        "phone_number_id": "924412964080974"
                      },
                      "contacts": [
                        {
                          "profile": {
                            "name": "Lakshit"
                          },
                          "wa_id": "919987749950"
                        }
                      ],
                      "messages": [
                        {
                          "context": {
                            "from": "918169228947",
                            "id": "wamid.HBgMOTE5OTg3NzQ5OTUwFQIAERgSNkUzMjUxMzM3RENDODVGNjM5AA=="
                          },
                          "from": "919987749950",
                          "id": "wamid.HBgMOTE5OTg3NzQ5OTUwFQIAEhgUM0FGMjJEQUQ3RjMxN0Q2NTY4NzYA",
                          "timestamp": "1771596277",
                          "type": "interactive",
                          "interactive": {
                            "type": "button_reply",
                            "button_reply": {
                              "id": "order_status",
                              "title": "Order Status"
                            }
                          }
                        }
                      ]
                    },
                    "field": "messages"
                  }
                ]
              }
            ]
          },
          "webhookUrl": "https://n8n.srv894857.hstgr.cloud/webhook/butruu_bot",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0,
          "input": 1
        }
      }
    ]
  },
  "versionId": "085acb21-0201-4b48-b5e4-759523c085e9",
  "activeVersionId": "085acb21-0201-4b48-b5e4-759523c085e9",
  "triggerCount": 3,
  "shared": [
    {
      "updatedAt": "2025-11-13T11:34:53.842Z",
      "createdAt": "2025-11-13T11:34:53.842Z",
      "role": "workflow:owner",
      "workflowId": "V1GolwUDxcGbl6aY",
      "projectId": "iOyc3VpWKvgHH9fv"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-02-20T14:24:07.000Z",
    "createdAt": "2026-02-20T14:23:49.767Z",
    "versionId": "085acb21-0201-4b48-b5e4-759523c085e9",
    "workflowId": "V1GolwUDxcGbl6aY",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "a2ef0698-a3a2-4cca-954a-43a6ab0d7162",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          5872,
          -1488
        ],
        "id": "b40b9b51-7521-4d2b-826b-8874d1e730de",
        "name": "Webhook",
        "webhookId": "a2ef0698-a3a2-4cca-954a-43a6ab0d7162"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $json.body.To }}"
              },
              {
                "name": "ContentSid",
                "value": "HX67dec374c3290ba042afc2e69e75f8c1"
              },
              {
                "name": "ContentVariables",
                "value": "={\"1\":\"{{ $json.body.ProfileName }}\"}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          6320,
          -1360
        ],
        "id": "827f7c7e-60cd-4b31-b7c8-79b92825bfd7",
        "name": "Send Initial Template",
        "credentials": {
          "httpBasicAuth": {
            "id": "WsQzmrY4u3R3NvDi",
            "name": "Twillio cred 2"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "c285b704-a505-4d8a-a018-83f7cc0070f0",
                "leftValue": "={{ $json.body.MessageType }}",
                "rightValue": "interactive",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          6096,
          -1488
        ],
        "id": "1047b585-12d9-4f4d-94a6-fcea6537f400",
        "name": "Check if Template"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1401568257,
            "mode": "list",
            "cachedResultName": "demo sheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          6752,
          -2096
        ],
        "id": "94d72d0f-a105-4cad-8bdb-05f815312402",
        "name": "Get row(s) in sheet",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://content.twilio.com/v1/Content",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"friendly_name\": \"baby_product_template\",\n  \"language\": \"en\",\n  \"types\": {\n    \"twilio/list-picker\": {\n      \"body\": \"Choose a product to view the details\",\n      \"button\": \"Select Product\",\n      \"items\": {{$node[\"mapping_item\"].json[\"items_stringified\"]}}\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          7200,
          -2096
        ],
        "id": "355d4ec5-ffca-45bb-984a-b54b02327e38",
        "name": "Create List picker template OG",
        "credentials": {
          "httpHeaderAuth": {
            "id": "XbgCnjmIOf3tN8o7",
            "name": "Twillio cred 2"
          },
          "httpBasicAuth": {
            "id": "r3Hp5Vy6qya7XL5n",
            "name": "Twillio Credential"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Convert Excel rows → PROPER JSON array ready for Twilio\nconst MAX_ITEMS = 10;\n  const TITLE_MAX = 24;\nconst DESC_MAX = 72;\n\nconst rows = $input.all().map(i => i.json);\n\nfunction trunc(s,n){ \n  if (!s) return \"\"; \n  s = String(s); \n  return s.length<=n ? s : s.slice(0,n-1)+\"…\"; \n}\n\n// Order by in-stock first\nconst inStock = rows.filter(r => (r.availability || '').toLowerCase() === 'in stock');\nconst others   = rows.filter(r => !inStock.includes(r));\nconst ordered  = inStock.concat(others).slice(0, MAX_ITEMS);\n\n// Build Twilio List Picker items\nconst listItems = ordered.map(p => {\n  const id = String(p.id);\n  const title = trunc(p.title, TITLE_MAX);\n  const description = trunc(p.description ?? `₹${p.price} • ${p.availability}`, DESC_MAX);\n  return {\n    item: title,\n    description: description,\n    id: id\n  };\n});\n\n// Return BOTH versions:\n// 1. Normal JSON array\n// 2. Stringified JSON array (for display)\nreturn [{\n  json: {\n    items: listItems,\n    items_stringified: JSON.stringify(listItems, null, 2)\n  }\n}];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6976,
          -2096
        ],
        "id": "2a670e03-2f63-416f-a240-6772e5987ca4",
        "name": "mapping_item"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.body.ButtonPayload }}",
                      "rightValue": "browse_product",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "a7c6ca04-7747-406d-ab76-cd29c0e07c09"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Browse Product"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "b9ce7a61-a4ac-410d-a657-cc2043987041",
                      "leftValue": "={{ $json.body.ButtonPayload }}",
                      "rightValue": "confirm",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Confirm Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "fa8a5bb5-2908-4bee-b7f7-b7d6cd329182",
                      "leftValue": "={{ $json.body.ButtonPayload }}",
                      "rightValue": "ask_faqs",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Ask FAQs"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "1ac966a0-815a-4c1b-9c9c-2af2834b903f",
                      "leftValue": "={{ $json.body.ButtonPayload }}",
                      "rightValue": "cancel",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Cancel Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "a082f7c7-a09f-4524-8298-89fadaaf58c6",
                      "leftValue": "={{ $json.body.Body }}",
                      "rightValue": "_",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "No of Quantity"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "623c6501-41f9-456d-864f-72f89f0ec8a6",
                      "leftValue": "={{ $json.body.MessageType }}",
                      "rightValue": "interactive",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Ask Quantity"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          6320,
          -1680
        ],
        "id": "07b0d4a1-0940-4d90-9e55-0903d622edab",
        "name": "Switch"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $node['Webhook'].json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $node['Webhook'].json.body.To }}"
              },
              {
                "name": "ContentSid",
                "value": "={{ $json.sid }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          7424,
          -2096
        ],
        "id": "0900b854-6c30-4ae3-82db-7ab40be0f30c",
        "name": "Send Template",
        "credentials": {
          "httpBasicAuth": {
            "id": "WsQzmrY4u3R3NvDi",
            "name": "Twillio cred 2"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://content.twilio.com/v1/Content",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"friendly_name\": \"baby_product_template\",\n  \"language\": \"en\",\n  \"types\": {\n    \"twilio/list-picker\": {\n      \"body\": \"{{ $json.body }}\",\n      \"button\": \"{{ $json.button }}\",\n      \"items\": {{$node[\"list_quantity\"].json[\"items_stringified\"]}}\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          6768,
          -1136
        ],
        "id": "c2908f8e-371a-49a0-8708-f5f024e3d9a1",
        "name": "Create List Quantity picker ",
        "credentials": {
          "httpHeaderAuth": {
            "id": "XbgCnjmIOf3tN8o7",
            "name": "Twillio cred 2"
          },
          "httpBasicAuth": {
            "id": "r3Hp5Vy6qya7XL5n",
            "name": "Twillio Credential"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $node['Webhook'].json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $node['Webhook'].json.body.To }}"
              },
              {
                "name": "ContentSid",
                "value": "={{ $json.sid }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          6992,
          -1136
        ],
        "id": "799a7aba-091a-4d48-963c-c0dc1d2e539f",
        "name": "Send Quantity Template",
        "credentials": {
          "httpBasicAuth": {
            "id": "WsQzmrY4u3R3NvDi",
            "name": "Twillio cred 2"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Function node: Quantity List Builder\n// Input: previous node is your Twilio webhook (so product selection data is in $json)\n// Output: { body, button, items_stringified }\n\n// --- Config\nconst MAX_Q = 10;\nconst BUTTON_TEXT = 'Select Qty';     // <=20 chars\nconst BODY_PREFIX = 'You selected';   // used to build the message\n\n// --- Helpers\nfunction trunc(s, n=60){ if (s===undefined||s===null) return ''; s=String(s); return s.length<=n? s : s.slice(0,n-1)+'…'; }\n\n// --- Extract product identifier from common Twilio webhook fields\n// Try a few common locations: (adjust if your webhook stores elsewhere)\n\n// Common Twilio places seen in screenshots: payload.Body, payload.ListTitle, payload.body.ListTitle, payload.body.Body\nlet productIdentifier = $input.first().json.body.Body;\nlet productTitle = $input.first().json.body.ListTitle;\n\n\n// --- Build items array (1..MAX_Q). Use small 'item' titles and descriptions\nconst items = [];\nfor (let q = 1; q <= MAX_Q; q++) {\n  const idObj = `${q}_${productIdentifier}`;\n  items.push({\n    item: String(q),                    // label shown to the user\n    description: q === 1 ? '1 unit' : `${q} units`,\n    // id is a safe encoded JSON string (decode on webhook parse)\n    id: idObj\n  });\n}\n\n// Build output fields\nconst body = `${BODY_PREFIX} '${trunc(productTitle, 36)}'. How many units do you want?`;\nconst button = BUTTON_TEXT;\nconst items_stringified = JSON.stringify(items); // stringified JSON array as requested\n\nreturn [{\n  json: {\n    body,\n    button,\n    items_stringified\n  }\n}];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6544,
          -1136
        ],
        "id": "65d80e60-876b-482a-ae6d-26cf9ad8bb46",
        "name": "list_quantity"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "a0ea277a-b6fc-4818-8787-bae7b6768ddc",
                "name": "item_id",
                "value": "={{ $json.body.ListId.split('_')[1] }}",
                "type": "string"
              },
              {
                "id": "d331bf07-e522-4f03-8752-f7b332b1f648",
                "name": "quantity",
                "value": "={{ $json.body.ListTitle }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6544,
          -1328
        ],
        "id": "821ae4ab-89a3-40a7-a39f-6cc8cb2a923a",
        "name": "Get Item ID"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1401568257,
            "mode": "list",
            "cachedResultName": "demo sheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "id",
                "lookupValue": "={{ $json.item_id }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          6768,
          -1328
        ],
        "id": "456f52c3-22f4-4350-84a9-fb7381c49bcf",
        "name": "Get row(s) in sheet1",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://content.twilio.com/v1/Content",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"friendly_name\": \"confirm_order\",\n  \"language\": \"en\",\n  \"types\": {\n    \"twilio/quick-reply\": {\n      \"body\": \"Confirm your order: \\n • Product: {{ $json.title }} \\n • Quantity: {{ $('Get Item ID').item.json.quantity }}\",\n      \"actions\": [\n        {\n          \"title\": \"Confirm\",\n          \"id\": \"confirm_{{ $('Get Item ID').item.json.item_id }}_{{ $('Get Item ID').item.json.quantity }}\"\n        },\n        {\n          \"title\": \"Cancel\",\n          \"id\": \"cancel\"\n        }\n      ]\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          6992,
          -1328
        ],
        "id": "9d5a9e93-da3c-444f-9688-d3f2f5d11d30",
        "name": "Confirmation Template",
        "credentials": {
          "httpBasicAuth": {
            "id": "r3Hp5Vy6qya7XL5n",
            "name": "Twillio Credential"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $node['Webhook'].json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $node['Webhook'].json.body.To }}"
              },
              {
                "name": "ContentSid",
                "value": "={{ $json.sid }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          7216,
          -1328
        ],
        "id": "b794c898-6ebd-4a3b-bbe0-0fc81e1d7b15",
        "name": "Send Confirm Template",
        "credentials": {
          "httpBasicAuth": {
            "id": "WsQzmrY4u3R3NvDi",
            "name": "Twillio cred 2"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $('Webhook').item.json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $('Webhook').item.json.body.To }}"
              },
              {
                "name": "ContentSid",
                "value": "HX67dec374c3290ba042afc2e69e75f8c1"
              },
              {
                "name": "ContentVariables",
                "value": "={\"1\":\"{{ $('Webhook').item.json.body.ProfileName }}\"}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          6768,
          -1520
        ],
        "id": "e4636f0d-3d9b-45f6-97b3-aea38371dda5",
        "name": "Send Initial Template1",
        "credentials": {
          "httpBasicAuth": {
            "id": "WsQzmrY4u3R3NvDi",
            "name": "Twillio cred 2"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $('Check if Template').item.json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $('Check if Template').item.json.body.To }}"
              },
              {
                "name": "Body",
                "value": "=Your Order Has Been Cancel\nIf you want inital menu, type \"Menu\""
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          6544,
          -1520
        ],
        "id": "24d8d59c-5d24-4a4f-b3bf-29b9d67d305d",
        "name": "Send Normal Message",
        "credentials": {
          "httpBasicAuth": {
            "id": "r3Hp5Vy6qya7XL5n",
            "name": "Twillio Credential"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "00a9c062-dd4a-46e1-aca8-543cae3c6dca",
                "name": "item_id",
                "value": "={{ $json.body.ButtonPayload.split(\"_\")[1] }}",
                "type": "string"
              },
              {
                "id": "951c7c53-da08-4ec7-84f0-4bbc5433d52a",
                "name": "quantity",
                "value": "={{ $json.body.ButtonPayload.split(\"_\")[2] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6544,
          -1904
        ],
        "id": "802434ea-635f-4c2c-9ed7-fbc60ff18135",
        "name": "Edit Fields"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1401568257,
            "mode": "list",
            "cachedResultName": "demo sheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "id",
                "lookupValue": "={{ $json.item_id }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          6768,
          -1904
        ],
        "id": "831d592b-01b4-4ded-b349-7730aa3973f2",
        "name": "Get row(s) in sheet2",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "operation": "append",
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 38109468,
            "mode": "list",
            "cachedResultName": "Order List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Phone Number": "={{ $('Webhook').item.json.body.WaId }}",
              "User": "={{ $('Webhook').item.json.body.ProfileName }}",
              "Item_id": "={{ $('Edit Fields').item.json.item_id }}",
              "Item": "={{ $json.title }}",
              "Quantity": "={{ $('Edit Fields').item.json.quantity }}",
              "Date": "={{ $now.setZone('Asia/Kolkata').format('yyyy-MM-dd T') }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "Date",
                "displayName": "Date",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "User",
                "displayName": "User",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Item_id",
                "displayName": "Item_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Item",
                "displayName": "Item",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Quantity",
                "displayName": "Quantity",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          6992,
          -1904
        ],
        "id": "e63b5675-06e4-4c4e-a8e7-67c5190725cd",
        "name": "Append row in sheet",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $('Check if Template').item.json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $('Check if Template').item.json.body.To }}"
              },
              {
                "name": "Body",
                "value": "=Your Order Has Been Added in our Database\nIf you want inital menu, type \"Menu\""
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          7216,
          -1904
        ],
        "id": "85025d4d-0fe9-4a5e-b47d-41f4020ac3d2",
        "name": "Send Normal Message1",
        "credentials": {
          "httpBasicAuth": {
            "id": "r3Hp5Vy6qya7XL5n",
            "name": "Twillio Credential"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.twilio.com/2010-04-01/Accounts/AC512855366730e39b4a0857b16fb14f27/Messages.json",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "To",
                "value": "={{ $('Check if Template').item.json.body.From }}"
              },
              {
                "name": "From",
                "value": "={{ $('Check if Template').item.json.body.To }}"
              },
              {
                "name": "Body",
                "value": "=This Feature is under Development\nIf you want inital menu, type \"Menu\""
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          6544,
          -1712
        ],
        "id": "05d90907-b4dd-42b2-b517-7ba9771f87f4",
        "name": "Send Normal Message2",
        "credentials": {
          "httpBasicAuth": {
            "id": "r3Hp5Vy6qya7XL5n",
            "name": "Twillio Credential"
          }
        }
      },
      {
        "parameters": {
          "multipleMethods": true,
          "path": "butruu_bot",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -3152,
          -1968
        ],
        "id": "3b0080ac-4b54-41c0-9f56-b71be5213c58",
        "name": "Whatsapp Bot Webhook",
        "webhookId": "2b7f85b2-f581-46d9-8d22-172f7a9933c0"
      },
      {
        "parameters": {
          "respondWith": "text",
          "responseBody": "={{ $json.query[\"hub.challenge\"] }}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.4,
        "position": [
          -2272,
          -2064
        ],
        "id": "cbef7959-d640-4f0e-9853-d51daa0d3ae9",
        "name": "Verify Webhook"
      },
      {
        "parameters": {
          "content": "# Twillio Connection",
          "height": 1552,
          "width": 1760
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          5984,
          -2288
        ],
        "id": "87410b3c-eef4-46ce-8088-a9442cac5d53",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "51696ba9-54b9-4f8c-bd0c-4e11fcb50d45",
                "leftValue": "={{ $json.query['hub.mode'] }}",
                "rightValue": "subscribe",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              },
              {
                "id": "4b041959-0ee0-4db3-8465-d08554bdec80",
                "leftValue": "={{ $json.query['hub.verify_token'] }}",
                "rightValue": "hello",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.2,
        "position": [
          -2496,
          -2064
        ],
        "id": "25f8644c-99d4-4c89-b1c2-5f640181f41c",
        "name": "Check webhook configure parameter"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "24009ed9-9dd8-4b22-9e15-ef5b4e0b1587",
                "name": "msg_from",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.metadata.display_phone_number }}",
                "type": "string"
              },
              {
                "id": "2977f9b0-5df4-4d94-93a7-308724b31769",
                "name": "msg",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].text.body }}",
                "type": "string"
              },
              {
                "id": "14d7554a-9415-4478-b26c-59d88b63d498",
                "name": "user_name",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
                "type": "string"
              },
              {
                "id": "d6ec1f78-0ce8-492a-bba7-bf520f8f56c8",
                "name": "msg_to",
                "value": "={{ $json.msg_to }}",
                "type": "string"
              },
              {
                "id": "cac33ed1-69cc-4bb8-8b25-9990d994e1af",
                "name": "msg_id",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1600,
          -704
        ],
        "id": "a09b5fad-edb8-44f0-b4f7-b9fb39ead618",
        "name": "Set Variable"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "897fa65a-47b7-4e25-b472-6f72bfc1d1c5",
                "leftValue": "={{ $(\"Whatsapp Bot Webhook\").item.json.body.entry[0].changes[0].value.statuses[0].status }}",
                "rightValue": "read",
                "operator": {
                  "type": "string",
                  "operation": "notExists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.2,
        "position": [
          -2464,
          -1872
        ],
        "id": "854c4a0b-00d9-4bb9-a993-70a2e14f295b",
        "name": "Filter"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "b9ce7a61-a4ac-410d-a657-cc2043987041",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "confirm",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Confirm Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "fe1e27ee-c64f-4431-95f9-bc69d2b64f40",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "order_status",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Order Status"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "fa8a5bb5-2908-4bee-b7f7-b7d6cd329182",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "ask_faq",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Ask FAQs"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "1ac966a0-815a-4c1b-9c9c-2af2834b903f",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "cancel",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Cancel Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "browse_product",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "a7c6ca04-7747-406d-ab76-cd29c0e07c09"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Browse Product"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "1c46b4c8-8a38-4b12-aad3-eb424595cb3d",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "use_saved_details",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Send Catalog"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "53b11d5b-9b88-4786-881a-a58d9fa4b1c9",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "update_user_info",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Update Usere Info"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "f2f08703-c48e-4238-8f86-1a605c976230",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "main_menu",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Main Menu"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ff0b86f4-3c80-4bb6-a6dd-fb6e5241516b",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "share_feedback",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Share Feedback"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -608,
          -2064
        ],
        "id": "c70792a6-7041-4dea-ae7c-48c3f761d8b8",
        "name": "Switch1"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].interactive.type }}",
                      "rightValue": "button_reply",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "66f96ae4-4402-4323-8b49-2f569e97fbf3"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Button Reply"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ee46d084-6457-4ed6-a176-6069f41e401b",
                      "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].interactive.type }}",
                      "rightValue": "nfm_reply",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Flow Submit"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.3,
        "position": [
          -1232,
          -1856
        ],
        "id": "624d36cc-c55c-42fe-8460-17b6d6d18a4b",
        "name": "Interative Type Route"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 2059797163,
            "mode": "list",
            "cachedResultName": "Worksheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=2059797163"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          1168,
          -1264
        ],
        "id": "dc6a9564-09b1-4a65-92e8-54638755f599",
        "name": "Get row(s) in sheet3",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [
          -1824,
          -3872
        ],
        "id": "3920186d-98df-4c94-a70d-2dfe84046c18",
        "name": "When clicking ‘Execute workflow’"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $json.phone_number_id }}/business_compliance_info",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"entity_name\": \"Lakshit Ukani\",\n  \"entity_type\": \"SOLE_PROPRIETORSHIP\",\n  \"entity_registration_number\": \"AEEUU5907L\",\n  \"business_address\": {\n    \"street\": \"Mira road\",\n    \"city\": \"Thane\",\n    \"state\": \"Maharashtra\",\n    \"postal_code\": \"401107\",\n    \"country\": \"IN\"\n  },\n  \"customer_care_details\": {\n    \"email\": \"laksh77@gmail.com\",\n    \"mobile_number\": \"+918163328947\"\n  },\n  \"grievance_officer_details\": {\n    \"name\": \"Lakshit Ukani\",\n    \"email\": \"laksh77@gmail.com\",\n    \"mobile_number\": \"+918122228947\"\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -1392,
          -3536
        ],
        "id": "ebd5a909-1e79-4d65-95c7-7c065ef022ed",
        "name": "Compliance Info Post",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://graph.facebook.com/v24.0/{{ $('Edit Fields3').item.json.phone_number_id }}/business_compliance_info",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -1168,
          -3536
        ],
        "id": "bdcdd0f1-89d7-4ce2-96c6-4d5eb050b0d7",
        "name": "Compliance Info Get",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                      "rightValue": "interactive",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "38c2ee1e-5380-4c4c-906a-765cd35fff09"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Interactive"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "7bb670b9-8110-4d70-a382-9581cd025551",
                      "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                      "rightValue": "order",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "73114ba1-f1c6-4eb8-8f92-f9abf6d6cb29",
                      "leftValue": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                      "rightValue": "text",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Text"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.3,
        "position": [
          -1456,
          -1168
        ],
        "id": "90f57056-7240-4358-97bb-98ea291c9819",
        "name": "Message Type Routing"
      },
      {
        "parameters": {
          "content": "# Compliance Check for India",
          "height": 304,
          "width": 944
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1872,
          -3664
        ],
        "id": "f223e2b6-f285-458b-a300-a473b5a6840e",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 2059797163,
            "mode": "list",
            "cachedResultName": "Worksheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=2059797163"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -1008,
          -1152
        ],
        "id": "9e36b115-9bd8-40d0-8800-a546b2f7d9e1",
        "name": "Get Stock data",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Input 1 = WhatsApp webhook\n// Input 2 = Excel data\n\n// FIX 1: unwrap Excel rows from .all() → each item is { json: { ... } }\nconst excelData = $('Get Stock data').all().map(item => item.json);\n\n// Extract all product_items from WhatsApp order\nconst productItems = $('Whatsapp Bot Webhook').first().json.body.entry[0].changes[0].value.messages[0].order.product_items\n\n// Collect errors\nlet errors = [];\n\n// Collect success\nlet successLines = [];\n\n// NEW: collect selected item details\nlet selectedData = [];\n\nfor (const item of productItems) {\n  const selectedId = String(item.product_retailer_id).trim();\n  const selectedQty = Number(item.quantity);\n\n  // FIX 2: normalize Excel IDs to string\n  const match = excelData.find(p => String(p.id).trim() === selectedId);\n\n  if (!match) {\n    errors.push(`Product with ID ${selectedId} not found.`);\n    continue;\n  }\n\n  const available = Number(match.item_available);\n  const title = String(match.title)\n\n  // Store selected item info\n  selectedData.push({\n    product_id: selectedId,\n    quantity: selectedQty,\n    title: title\n  });\n\n  if (available < selectedQty) {\n    errors.push(\n      `Only ${available} item(s) of \"${match.title}\" are available, but you selected ${selectedQty}.`\n    );\n  } else {\n    // Build success line\n    successLines.push(`✅ ${match.title} — Qty: ${selectedQty}`);\n  }\n}\n\n// FINAL DECISION\nif (errors.length === 0) {\n\n  const successMessage = \n`Hey! 😊\nI checked the items you added to your cart.\n\n🛒 Here’s what you selected:\n${successLines.join('\\n')}\n\n🎉 Good news! Everything is in stock and ready to go.\nPlease confirm your order to continue.`;\n  return [\n    {\n      json: {\n        success: true,\n        message: successMessage\n      }\n    }\n  ];\n} else {\n  return [\n    {\n      json: {\n        success: false,\n        message: errors.join(\" | \")\n      }\n    }\n  ];\n}\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -784,
          -1152
        ],
        "id": "fadea261-f7b7-4a7a-a9a0-9945c48c2d3b",
        "name": "Code in JavaScript"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "bd52bbe8-7f92-4efe-8416-0d8d14246800",
                "name": "=msg_to_send",
                "value": "=Thanks for your order! 😄\nI checked the availability and here’s an update:\n\nSome items are currently not available in the quantity you selected:\n\n👉 {{$json.message.replace(/\\|/g, \"\\n👉 \")}}\n\nYou can update the quantities and let me know — I’ll place the order immediately for you!;",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -336,
          -1248
        ],
        "id": "a21bd904-3062-4a8e-b076-5459573efcab",
        "name": "Error message"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "018b7715-2bfd-48f9-b1da-63fb9b6209f0",
                "name": "msg_to_send_2",
                "value": "=Hey! 😊\nI checked the items you added to your cart.\n\n🛒 Here’s what you selected:\n\n🎉 Good news: Everything you selected is in stock and ready to go!\nPlease confirm your order to continue.",
                "type": "string"
              },
              {
                "id": "f595e15d-51a7-4e1d-9c28-d7b0f7475428",
                "name": "msg_to_send",
                "value": "={{ $('Code in JavaScript').item.json.message }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -336,
          -1056
        ],
        "id": "858526bc-1fd7-4fa8-9060-8f0736341436",
        "name": "Succes Msg"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -112,
          -1248
        ],
        "id": "709cbadb-6a1f-445e-9e57-dfb1d78e99fc",
        "name": "Send msg",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
                "name": "catalog_id",
                "value": "={{ $json.catalog_id }}",
                "type": "string"
              },
              {
                "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
                "name": "msg_to",
                "value": "={{ $json.msg_to }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1232,
          -1152
        ],
        "id": "19db4f36-eb24-4f79-8088-75ca4359b201",
        "name": "Set Variable2"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Succes Msg').item.json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields1').item.json.unique_id_of_order }}_confirm\",\n            \"title\": \"Confirm\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields1').item.json.unique_id_of_order }}_cancel\",\n            \"title\": \"Cancel\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1024,
          -1056
        ],
        "id": "f866cafb-23fd-4de5-adaf-7767a791dc7e",
        "name": "HTTP Request2",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "dataTableId": {
            "__rl": true,
            "value": "htaS8wafCR4Eh7v5",
            "mode": "list",
            "cachedResultName": "Alister Order Stage",
            "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "phone_no": "={{ $('Edit Fields1').item.json.user_phone_no }}",
              "unique_order_id": "={{ $('Edit Fields1').item.json.unique_id_of_order }}",
              "user_name": "={{ $('Edit Fields1').item.json.user_name }}",
              "product_id": "={{ $json.product_retailer_id }}",
              "product_quantity": "={{ $json.quantity }}",
              "product_title": "={{ $json.title }}",
              "sale_price": "={{ $json.sale_price }}",
              "no_of_pack": "={{ $json.no_of_pack }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "unique_order_id",
                "displayName": "unique_order_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "user_name",
                "displayName": "user_name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "phone_no",
                "displayName": "phone_no",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "product_id",
                "displayName": "product_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "product_title",
                "displayName": "product_title",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "product_quantity",
                "displayName": "product_quantity",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "sale_price",
                "displayName": "sale_price",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "no_of_pack",
                "displayName": "no_of_pack",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          560,
          -1056
        ],
        "id": "d9d4a636-5253-4e91-a6c5-5d58c5f78603",
        "name": "Insert row"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "c618dbc9-40d0-4cd6-b164-60a462ceb16e",
                "name": "user_selected_product",
                "value": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.messages[0].order.product_items }}",
                "type": "array"
              },
              {
                "id": "41163f52-519c-4a26-8f60-c5cbb759a21c",
                "name": "unique_id_of_order",
                "value": "={{ 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 10000) }}",
                "type": "string"
              },
              {
                "id": "21053b3f-1909-4bb3-9888-561355df41bc",
                "name": "user_name",
                "value": "={{ $node['Whatsapp Bot Webhook'].json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
                "type": "string"
              },
              {
                "id": "36d108e7-b62c-4145-822c-640f588557a9",
                "name": "user_phone_no",
                "value": "={{ $node['Add this Variable'].json.msg_to }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -112,
          -1056
        ],
        "id": "ce22c39a-584d-4009-9823-9e2c90b73042",
        "name": "Edit Fields1"
      },
      {
        "parameters": {
          "fieldToSplitOut": "user_selected_product",
          "options": {}
        },
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          112,
          -1056
        ],
        "id": "55feeac7-55bd-42e7-b37b-e644d5f82de8",
        "name": "Split Out"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b414d52e-386d-4c0e-8eac-d0aeb8135ad6",
                "name": "order_id",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id.split(\"_\")[0] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -160,
          -2352
        ],
        "id": "77391d16-7abe-44e2-861f-3b1245a6b7ca",
        "name": "Edit Fields2"
      },
      {
        "parameters": {
          "operation": "append",
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 38109468,
            "mode": "list",
            "cachedResultName": "Order List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Phone Number": "={{ $json.phone_no }}",
              "User": "={{ $json.user_name }}",
              "Item_id": "={{ $json.product_id }}",
              "Item": "={{ $json.product_title }}",
              "Quantity": "={{ $json.product_quantity }}",
              "Date": "={{ $now.setZone('Asia/Kolkata').format('yyyy-MM-dd T') }}",
              "Status": "Order Placed",
              "Order ID": "={{ $('Edit Fields2').item.json.order_id }}",
              "Sale Price": "={{ $json.sale_price }}",
              "No of Pack": "={{ $json.no_of_pack }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "Date",
                "displayName": "Date",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Order ID",
                "displayName": "Order ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "User",
                "displayName": "User",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Item_id",
                "displayName": "Item_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Item",
                "displayName": "Item",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Quantity",
                "displayName": "Quantity",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Sale Price",
                "displayName": "Sale Price",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "No of Pack",
                "displayName": "No of Pack",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Status",
                "displayName": "Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          288,
          -2352
        ],
        "id": "37935ec5-dd12-4f55-a396-fb06e19f56b8",
        "name": "Append row in sheet2",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "htaS8wafCR4Eh7v5",
            "mode": "list",
            "cachedResultName": "Alister Order Stage",
            "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
          },
          "matchType": "allConditions",
          "filters": {
            "conditions": [
              {
                "keyName": "unique_order_id",
                "keyValue": "={{ $('Edit Fields2').item.json.order_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          64,
          -2352
        ],
        "id": "da314ca5-c1d0-4d96-847d-2c08dc5135b6",
        "name": "Get row(s)"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.limit",
        "typeVersion": 1,
        "position": [
          784,
          -1056
        ],
        "id": "740ad203-809c-4465-819f-3c7acd6e5423",
        "name": "Limit"
      },
      {
        "parameters": {
          "jsCode": "// Load data from nodes\nconst product_data = $(\"Get Stock data\").all().map(item => item.json);\nconst user_selected_data = $(\"Split Out\").all().map(item => item.json);\n\n// Final output list\nlet matched = [];\n\n// Loop through user-selected items\nfor (const userItem of user_selected_data) {\n  \n  const selectedId = String(userItem.product_retailer_id).trim();\n  const salePrice = String(userItem.item_price).trim();\n\n  // Find matching product from stock data\n  const stockItem = product_data.find(\n    p => String(p.id).trim() === selectedId\n  );\n\n  // If matched → append combined data\n  if (stockItem) {\n    matched.push({\n      product_retailer_id: selectedId,\n      sale_price: salePrice,\n      title: stockItem.title,\n      quantity: userItem.quantity,\n      no_of_pack: stockItem.custom_label_0\n      \n    });\n  }\n}\n\n// Return result\nreturn matched.map(m => ({ json: m }));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          336,
          -1056
        ],
        "id": "23c6658a-0f49-44a5-818c-4f68d23f4dc6",
        "name": "Code in JavaScript1"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.limit",
        "typeVersion": 1,
        "position": [
          512,
          -2352
        ],
        "id": "e019d711-350a-4ef3-9289-777833978fea",
        "name": "Limit1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Your Order Has Been Cancel \\nIf you want inital menu, type 'Menu' or 'Hello'\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -160,
          -1872
        ],
        "id": "fce3578c-ad98-453a-9724-bffc0d0a557a",
        "name": "Cancel Msg",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Hi 😊\\n\\nYou can ask me anything about Butruu—orders, delivery, payments, diaper sizes, or anything else you’d like to know.\\n\\nJust type your question in your own words, and I’ll help you right away. 💚\\n\\nIf you want to see the menu again, simply type *Hello*\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -160,
          -2016
        ],
        "id": "8634bc0f-b143-483a-b612-3006fb7e0c7e",
        "name": "FAQ msg",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "content": "# Official Meta Connection via Catalog & Template (New Way)",
          "height": 3376,
          "width": 5584
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          1584,
          -6816
        ],
        "id": "04990b98-2e8f-4b62-96e5-079c07492537",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 38109468,
            "mode": "list",
            "cachedResultName": "Order List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "Phone Number",
                "lookupValue": "={{ $json.msg_to }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -160,
          -2160
        ],
        "id": "f4d4b147-8b53-4546-b541-a65c87900240",
        "name": "Get row(s) in sheet4",
        "alwaysOutputData": true,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Load orders\nconst order_list = $(\"Get row(s) in sheet4\").all().map(item => item.json);\n\nif (!order_list.length) {\n  return [{ json: { message: \"You have no orders at the moment.\" } }];\n}\n\n// Sort latest first\norder_list.sort((a, b) => new Date(b.Date) - new Date(a.Date));\n\n// Group by Order ID\nconst grouped = {};\n\nfor (const row of order_list) {\n  const orderId = row[\"Order ID\"];\n\n  if (!grouped[orderId]) {\n    grouped[orderId] = {\n      items: [],\n      status: row.Status,\n      orderDate: row[\"Date\"] ? row[\"Date\"].split(\" \")[0] : \"\",\n    };\n  }\n\n  grouped[orderId].items.push({\n    name: row.Item,\n    quantity: Number(row.Quantity || 1),\n    salePrice: row[\"Sale Price\"],\n    pack: row[\"No of Pack\"],\n  });\n}\n\n// Convert grouped orders to array\nconst orders = Object.entries(grouped);\n\n// Max safe limit (interactive = 1024)\nconst MAX_LENGTH = 950;\n\nlet messages = [];\nlet currentMessage = \"📦 *Your Order Summary*\\n\\n\";\n\nfor (const [orderId, data] of orders) {\n\n  let orderBlock = \"\";\n\n  const totalQty = data.items.reduce((sum, i) => sum + i.quantity, 0);\n\n  orderBlock += `🧾 *Order ID:* ${orderId}\\n`;\n\n  if (data.orderDate) {\n    orderBlock += `📅 *Order Date:* ${data.orderDate}\\n`;\n  }\n\n  orderBlock += `📌 *Status:* ${data.status}\\n`;\n  orderBlock += `📦 *Total Items:* ${totalQty}\\n\\n`;\n  orderBlock += `🛍️ *Items:*\\n`;\n\n  for (const item of data.items) {\n    orderBlock += `• ${item.name}\\n`;\n    orderBlock += `   Qty: ${item.quantity}\\n`;\n  }\n\n  orderBlock += \"\\n----------------------\\n\\n\";\n\n  // If adding this order exceeds limit → push previous message\n  if ((currentMessage + orderBlock).length > MAX_LENGTH) {\n    messages.push(currentMessage.trim());\n    currentMessage = orderBlock;\n  } else {\n    currentMessage += orderBlock;\n  }\n}\n\n// Push last message\nif (currentMessage.trim()) {\n  messages.push(currentMessage.trim());\n}\n\n// Return multiple messages\nreturn messages.map(m => ({ json: { message: m } }));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          336,
          -2016
        ],
        "id": "a805b8ff-a0ef-4152-8786-a58c63dde7e6",
        "name": "Code in JavaScript2"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://graph.facebook.com/v24.0/924412964080974/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\":\"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\":\"918655991300\",\n  \"type\":\"interactive\",\n  \"interactive\":{\n    \"type\":\"product\",\n    \"body\": {\n      \"text\":\"Check this item\" \n    },\n    \"footer\": { \n      \"text\":\"Tap to view details\" \n    },\n    \"action\": {\n      \"catalog_id\":\"896416602722897\",\n      \"product_retailer_id\":\"1\"\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          256,
          -4160
        ],
        "id": "e6602605-cca6-44ec-bbff-213ef4033fb6",
        "name": "HTTP Request5",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
                "name": "catalog_id",
                "value": "896416602722897",
                "type": "string"
              },
              {
                "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
                "name": "msg_to",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
                "type": "string"
              },
              {
                "id": "bafa1b69-5374-4c42-ac6c-766dab6487e3",
                "name": "phone_number_id",
                "value": "924412964080974",
                "type": "string"
              },
              {
                "id": "fcf32a01-362e-4a7a-a8ad-c2c06acc3195",
                "name": "encrypted_flow_data",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.encrypted_flow_data }}",
                "type": "string"
              },
              {
                "id": "22509540-7420-4a86-92a0-7e0d570c98ec",
                "name": "encrypted_aes_key",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.encrypted_aes_key }}",
                "type": "string"
              },
              {
                "id": "df098d39-9d22-4b90-b8b3-f4ba31b9f16d",
                "name": "initial_vector",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.initial_vector }}",
                "type": "string"
              },
              {
                "id": "1792b3b5-c8aa-4e9e-9277-30ad112ebc11",
                "name": "app_version",
                "value": "v24.0",
                "type": "string"
              },
              {
                "id": "dbf1e8d3-cdbe-4d1d-816c-5aa67612809c",
                "name": "user_flow_id",
                "value": "1447104173423173",
                "type": "string"
              },
              {
                "id": "d215db8e-5748-4cd0-ad3b-b99bfbf2bf06",
                "name": "user_name",
                "value": "={{ $('Whatsapp Bot Webhook').item.json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
                "type": "string"
              },
              {
                "id": "523f73ad-025d-4305-94e4-b9c75b5ad209",
                "name": "user_feedback_flow_id",
                "value": "1142271577874941",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -2272,
          -1872
        ],
        "id": "79a6392e-4a87-4d62-8c0c-fd61ce3b9768",
        "name": "Add this Variable"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "528835a6-bfc1-4ef6-88da-fab4dfda48df",
                "name": "phone_number_id",
                "value": "924412964080974",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1616,
          -3536
        ],
        "id": "993077bb-206f-4ef4-84c6-01aea9c78488",
        "name": "Edit Fields3"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"butruu_catalog\",\n    \"language\": {\n      \"code\": \"en\"\n    },\n    \"components\": [\n        {\n          \"type\": \"button\",\n          \"sub_type\": \"mpm\",\n          \"index\": 0,\n          \"parameters\": [\n            {\n              \"type\": \"action\",\n              \"action\": {\n                \"sections\": [\n        {\n          \"title\": \"Pack of 30\",\n          \"product_items\": [\n{\"product_retailer_id\":\"1\"},\n{\"product_retailer_id\":\"2\"}\n]\n        },\n        {\n          \"title\": \"Pack of 140\",\n          \"product_items\": [\n{\"product_retailer_id\":\"3\"},{\"product_retailer_id\":\"4\"},{\"product_retailer_id\":\"5\"}]\n        }\n      ]\n              }\n            }\n          ]\n        }\n    ]\n  }\n}\n    ",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          576,
          -3840
        ],
        "id": "29d1501e-0dcf-4e7b-bf08-27fbad6c6ae3",
        "name": "Send Multi Product Marketing template",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to || $node['Decryption'].json.decryptedBody.flow_token}}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"product_list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"Baby Care Products\"\n    },\n    \"body\": {\n      \"text\": \"Check out our premium baby care collection\"\n    },\n    \"footer\": {\n      \"text\": \"Best prices guaranteed\"\n    },\n    \"action\": {\n      \"catalog_id\": \"{{ $items('Add this Variable')[0].json.catalog_id}}\",\n      \"sections\": {{ $json.items_stringified }}\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1632,
          -1264
        ],
        "id": "8d83513c-7426-407f-b09a-588a87c4b334",
        "name": "Send Multi Product Category",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "multipleMethods": true,
          "path": "whatsapp_alisterrrrrrr",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          5744,
          672
        ],
        "id": "2fa0eaf2-712c-4ae1-bb2d-944c002b3c13",
        "name": "Whatsapp Bot Webhook1",
        "webhookId": "2b7f85b2-f581-46d9-8d22-172f7a9933c0"
      },
      {
        "parameters": {
          "respondWith": "text",
          "responseBody": "={{ $json.query[\"hub.challenge\"] }}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.4,
        "position": [
          6192,
          576
        ],
        "id": "94e5d9ab-e888-4758-b8e5-b8aa833f906a",
        "name": "Verify Webhook1"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "51696ba9-54b9-4f8c-bd0c-4e11fcb50d45",
                "leftValue": "={{ $json.query['hub.mode'] }}",
                "rightValue": "subscribe",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              },
              {
                "id": "4b041959-0ee0-4db3-8465-d08554bdec80",
                "leftValue": "={{ $json.query['hub.verify_token'] }}",
                "rightValue": "hello",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.2,
        "position": [
          5968,
          576
        ],
        "id": "85040eec-b93d-42f8-82e4-9995050473d8",
        "name": "Check webhook configure parameter1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "24009ed9-9dd8-4b22-9e15-ef5b4e0b1587",
                "name": "msg_from",
                "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.metadata.display_phone_number }}",
                "type": "string"
              },
              {
                "id": "2977f9b0-5df4-4d94-93a7-308724b31769",
                "name": "msg",
                "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].text.body }}",
                "type": "string"
              },
              {
                "id": "14d7554a-9415-4478-b26c-59d88b63d498",
                "name": "user_name",
                "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6640,
          960
        ],
        "id": "490dd59d-d5bd-4905-95d1-3bc09a25977b",
        "name": "Set Variable1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable1').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi {{ $json.user_name }} 👋 \\nWelcome to Butruu! You can:\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"order_status\",\n            \"title\": \"Order Status\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ask_faq\",\n            \"title\": \"Ask FAQs\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          6864,
          960
        ],
        "id": "afd28b81-4996-4866-9131-da021402b2b3",
        "name": "HTTP Request1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "897fa65a-47b7-4e25-b472-6f72bfc1d1c5",
                "leftValue": "={{ $json.body.entry[0].changes[0].value.statuses[0].status }}",
                "rightValue": "read",
                "operator": {
                  "type": "string",
                  "operation": "notExists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.2,
        "position": [
          5968,
          768
        ],
        "id": "dfec6345-2475-4be5-b79b-2d3c8428c4a9",
        "name": "Filter1"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "b9ce7a61-a4ac-410d-a657-cc2043987041",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "confirm",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Confirm Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "fe1e27ee-c64f-4431-95f9-bc69d2b64f40",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "order_status",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "fa8a5bb5-2908-4bee-b7f7-b7d6cd329182",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "ask_faq",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Ask FAQs"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "1ac966a0-815a-4c1b-9c9c-2af2834b903f",
                      "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "cancel",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Cancel Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id }}",
                      "rightValue": "browse_product",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "a7c6ca04-7747-406d-ab76-cd29c0e07c09"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Browse Product"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          6864,
          144
        ],
        "id": "b312638a-bd9a-48b9-8d50-85f10828b34c",
        "name": "Switch2"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].interactive.type }}",
                      "rightValue": "button_reply",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "66f96ae4-4402-4323-8b49-2f569e97fbf3"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Button Reply"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.3,
        "position": [
          6640,
          192
        ],
        "id": "406c1fdf-7a51-446f-bf28-9049e6affc14",
        "name": "Interative Type Route1"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1401568257,
            "mode": "list",
            "cachedResultName": "demo sheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          7984,
          592
        ],
        "id": "b5162c71-4811-4483-ae89-4ed084bbba9a",
        "name": "Get row(s) in sheet5",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Convert Excel rows → PROPER JSON array ready for Twilio\nconst MAX_ITEMS = 10;\n  const TITLE_MAX = 24;\nconst DESC_MAX = 72;\n\nconst rows = $input.all().map(i => i.json);\n\nfunction trunc(s,n){ \n  if (!s) return \"\"; \n  s = String(s); \n  return s.length<=n ? s : s.slice(0,n-1)+\"…\"; \n}\n\n// Order by in-stock first\nconst inStock = rows.filter(r => (r.availability || '').toLowerCase() === 'in stock');\nconst others   = rows.filter(r => !inStock.includes(r));\nconst ordered  = inStock.concat(others).slice(0, MAX_ITEMS);\n\n// Build Twilio List Picker items\nconst listItems = ordered.map(p => {\n  const id = String(p.id);\n  const title = trunc(p.title, TITLE_MAX);\n  const description = trunc(p.description ?? `₹${p.price} • ${p.availability}`, DESC_MAX);\n  return {\n    product_retailer_id: id\n  };\n});\n\n// Return BOTH versions:\n// 1. Normal JSON array\n// 2. Stringified JSON array (for display)\nreturn [{\n  json: {\n    items: listItems,\n    items_stringified: JSON.stringify(listItems, null, 2)\n  }\n}];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          8208,
          592
        ],
        "id": "7b08f0a2-bab9-4d36-b86e-e3518fbaf2b9",
        "name": "mapping_item2"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"product_list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"Baby Care Products\"\n    },\n    \"body\": {\n      \"text\": \"Check out our premium baby care collection\"\n    },\n    \"footer\": {\n      \"text\": \"Best prices guaranteed\"\n    },\n    \"action\": {\n      \"catalog_id\": \"896416602722897\",\n      \"sections\": [\n        {\n          \"title\": \"Diapers & Care\",\n          \"product_items\": \n            {{ JSON.stringify($json.items) }}\n        }\n      ]\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          8464,
          416
        ],
        "id": "b80e2a90-6478-4a99-a3a2-25040c00cb95",
        "name": "Send Multi Product Template1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                      "rightValue": "interactive",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "38c2ee1e-5380-4c4c-906a-765cd35fff09"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Interactive"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "7bb670b9-8110-4d70-a382-9581cd025551",
                      "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                      "rightValue": "order",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Order"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "73114ba1-f1c6-4eb8-8f92-f9abf6d6cb29",
                      "leftValue": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].type }}",
                      "rightValue": "text",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Text"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.3,
        "position": [
          6416,
          752
        ],
        "id": "99c059f8-ce93-4c48-a20b-278e4babce38",
        "name": "Message Type Routing1"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1401568257,
            "mode": "list",
            "cachedResultName": "demo sheet",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1401568257"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          6864,
          768
        ],
        "id": "516498e5-933f-4d28-9860-a3bfeef23aff",
        "name": "Get Stock data1",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Input 1 = WhatsApp webhook\n// Input 2 = Excel data\n\n// FIX 1: unwrap Excel rows from .all() → each item is { json: { ... } }\nconst excelData = $('Get Stock data1').all().map(item => item.json);\n\n// Extract all product_items from WhatsApp order\nconst productItems = $('Whatsapp Bot Webhook1').first().json.body.entry[0].changes[0].value.messages[0].order.product_items\n\n// Collect errors\nlet errors = [];\n\nfor (const item of productItems) {\n  const selectedId = String(item.product_retailer_id).trim();\n  const selectedQty = Number(item.quantity);\n\n  // FIX 2: normalize Excel IDs to string\n  const match = excelData.find(p => String(p.id).trim() === selectedId);\n\n  if (!match) {\n    errors.push(`Product with ID ${selectedId} not found.`);\n    continue;\n  }\n\n  const available = Number(match.item_available);\n\n  if (available < selectedQty) {\n    errors.push(\n      `Only ${available} item(s) of \"${match.title}\" are available, but you selected ${selectedQty}.`\n    );\n  }\n}\n\n// FINAL DECISION\nif (errors.length === 0) {\n  return [\n    {\n      json: {\n        success: true,\n        message: \"Stock available for all selected items.\"\n      }\n    }\n  ];\n} else {\n  return [\n    {\n      json: {\n        success: false,\n        message: errors.join(\" | \")\n      }\n    }\n  ];\n}\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          7088,
          768
        ],
        "id": "c94ba703-e35e-4d2a-a4b9-1f140cf6d3ba",
        "name": "Code in JavaScript3"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "bd52bbe8-7f92-4efe-8416-0d8d14246800",
                "name": "=msg_to_send",
                "value": "=Thanks for your order! 😄\nI checked the availability and here’s an update:\n\nSome items are currently not available in the quantity you selected:\n\n👉 {{$json.message.replace(/\\|/g, \"\\n👉 \")}}\n\nYou can update the quantities and let me know — I’ll place the order immediately for you!;",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          7536,
          672
        ],
        "id": "deac5331-cc15-4c70-a8fd-926d5fab34cb",
        "name": "Error message1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "018b7715-2bfd-48f9-b1da-63fb9b6209f0",
                "name": "msg_to_send",
                "value": "=Hey! 😊\nI checked the items you added to your cart.\n\nGood news: Everything you selected is in stock and ready to go!\nPlease confirm your order to continue.",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          7536,
          864
        ],
        "id": "1ed42db6-549e-4285-980b-4c815ff57299",
        "name": "Succes Msg1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable1'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          7760,
          672
        ],
        "id": "af578f79-b7e7-4468-a7e8-772a110c3920",
        "name": "Send msg3",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
                "name": "catalog_id",
                "value": "896416602722897",
                "type": "string"
              },
              {
                "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
                "name": "msg_to",
                "value": "={{ $json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6640,
          768
        ],
        "id": "ca094899-ebe2-4a2c-9dd4-1d5472f4c25c",
        "name": "Set Variable3"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"{{ $('Succes Msg1').item.json.msg_to_send.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields4').item.json.unique_id_of_order }}_confirm\",\n            \"title\": \"Confirm\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"{{ $('Edit Fields4').item.json.unique_id_of_order }}_cancel\",\n            \"title\": \"Cancel\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          8880,
          864
        ],
        "id": "d75fb3bb-5163-45dc-80a6-5421a65dcbd8",
        "name": "HTTP Request3",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "dataTableId": {
            "__rl": true,
            "value": "htaS8wafCR4Eh7v5",
            "mode": "list",
            "cachedResultName": "Alister Order Stage",
            "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "phone_no": "={{ $('Edit Fields4').item.json.user_phone_no }}",
              "unique_order_id": "={{ $('Edit Fields4').item.json.unique_id_of_order }}",
              "user_name": "={{ $('Edit Fields4').item.json.user_name }}",
              "product_id": "={{ $json.product_retailer_id }}",
              "product_quantity": "={{ $json.quantity }}",
              "product_title": "={{ $json.title }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "unique_order_id",
                "displayName": "unique_order_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "user_name",
                "displayName": "user_name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "phone_no",
                "displayName": "phone_no",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "product_id",
                "displayName": "product_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "product_title",
                "displayName": "product_title",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "product_quantity",
                "displayName": "product_quantity",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          8432,
          864
        ],
        "id": "c116f334-9091-4ea5-a660-637961138917",
        "name": "Insert row1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "c618dbc9-40d0-4cd6-b164-60a462ceb16e",
                "name": "user_selected_product",
                "value": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.messages[0].order.product_items }}",
                "type": "array"
              },
              {
                "id": "41163f52-519c-4a26-8f60-c5cbb759a21c",
                "name": "unique_id_of_order",
                "value": "={{ 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 10000) }}",
                "type": "string"
              },
              {
                "id": "21053b3f-1909-4bb3-9888-561355df41bc",
                "name": "user_name",
                "value": "={{ $node['Whatsapp Bot Webhook1'].json.body.entry[0].changes[0].value.contacts[0].profile.name }}",
                "type": "string"
              },
              {
                "id": "36d108e7-b62c-4145-822c-640f588557a9",
                "name": "user_phone_no",
                "value": "={{ $node['Add this Variable1'].json.msg_to }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          7760,
          864
        ],
        "id": "6682081e-274f-457a-9744-f869834b2bec",
        "name": "Edit Fields4"
      },
      {
        "parameters": {
          "fieldToSplitOut": "user_selected_product",
          "options": {}
        },
        "type": "n8n-nodes-base.splitOut",
        "typeVersion": 1,
        "position": [
          7984,
          864
        ],
        "id": "4ef84c57-31c7-409f-ae95-bac288089fd2",
        "name": "Split Out1"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b414d52e-386d-4c0e-8eac-d0aeb8135ad6",
                "name": "order_id",
                "value": "={{ $('Whatsapp Bot Webhook1').item.json.body.entry[0].changes[0].value.messages[0].interactive.button_reply.id.split(\"_\")[0] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          7088,
          -192
        ],
        "id": "2a594e44-4762-450f-8fe5-c334b2b46c8e",
        "name": "Edit Fields5"
      },
      {
        "parameters": {
          "operation": "append",
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 38109468,
            "mode": "list",
            "cachedResultName": "Order List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Phone Number": "={{ $json.phone_no }}",
              "User": "={{ $json.user_name }}",
              "Item_id": "={{ $json.product_id }}",
              "Item": "={{ $json.product_title }}",
              "Quantity": "={{ $json.product_quantity }}",
              "Date": "={{ $now.setZone('Asia/Kolkata').format('yyyy-MM-dd T') }}",
              "Status": "Order Placed",
              "Order ID": "={{ $('Edit Fields5').item.json.order_id }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "Date",
                "displayName": "Date",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Order ID",
                "displayName": "Order ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "User",
                "displayName": "User",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Item_id",
                "displayName": "Item_id",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Item",
                "displayName": "Item",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Quantity",
                "displayName": "Quantity",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Status",
                "displayName": "Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          7536,
          -192
        ],
        "id": "e31cc4fe-af7e-4315-b5f9-0ce73a0f325e",
        "name": "Append row in sheet3",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "htaS8wafCR4Eh7v5",
            "mode": "list",
            "cachedResultName": "Alister Order Stage",
            "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/htaS8wafCR4Eh7v5"
          },
          "matchType": "allConditions",
          "filters": {
            "conditions": [
              {
                "keyName": "unique_order_id",
                "keyValue": "={{ $('Edit Fields5').item.json.order_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1,
        "position": [
          7312,
          -192
        ],
        "id": "5f591512-f83e-458f-aa38-490a592efd42",
        "name": "Get row(s)1"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "263eb8a1-0b0b-4e98-bede-2ca52dc566ed",
                "leftValue": "={{ $json.success }}",
                "rightValue": "false",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          7312,
          768
        ],
        "id": "c6c05ead-10e0-4432-93e3-936ee1414947",
        "name": "If Stock is available1"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.limit",
        "typeVersion": 1,
        "position": [
          8656,
          864
        ],
        "id": "7defc8a5-18e5-4d8f-b1cc-0035e56dd45e",
        "name": "Limit2"
      },
      {
        "parameters": {
          "jsCode": "// Load data from nodes\nconst product_data = $(\"Get Stock data1\").all().map(item => item.json);\nconst user_selected_data = $(\"Split Out1\").all().map(item => item.json);\n\n// Final output list\nlet matched = [];\n\n// Loop through user-selected items\nfor (const userItem of user_selected_data) {\n  \n  const selectedId = String(userItem.product_retailer_id).trim();\n\n  // Find matching product from stock data\n  const stockItem = product_data.find(\n    p => String(p.id).trim() === selectedId\n  );\n\n  // If matched → append combined data\n  if (stockItem) {\n    matched.push({\n      product_retailer_id: selectedId,\n      title: stockItem.title,\n      quantity: userItem.quantity\n    });\n  }\n}\n\n// Return result\nreturn matched.map(m => ({ json: m }));\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          8208,
          864
        ],
        "id": "ab108230-0356-433b-80fd-6a92614d77df",
        "name": "Code in JavaScript4"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Your Order has been placed and we will deliver soon\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          7984,
          -192
        ],
        "id": "83515499-766c-4aff-8657-9f4c45ae2ccb",
        "name": "Send msg4",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.limit",
        "typeVersion": 1,
        "position": [
          7760,
          -192
        ],
        "id": "514bc4e1-74f1-4a7c-a3ac-5303e10bf704",
        "name": "Limit3"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"Your Order Has Been Cancel \\nIf you want inital menu, type 'Menu' or 'Hello'\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          7088,
          384
        ],
        "id": "793f5989-1690-41b7-81fb-266a75be34d4",
        "name": "Cancel Msg1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"This Feature is under Development \\nIf you want inital menu, type 'Menu' or 'Hello'\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          7088,
          192
        ],
        "id": "35d388c9-9397-42ad-9ee2-cf4a5f46fd7b",
        "name": "FAQ msg1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "content": "# Official Meta Connection via Catalog & Template (Old Way)",
          "height": 1392,
          "width": 3520
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          5568,
          -224
        ],
        "id": "9f0894db-6b28-473f-bac2-b6d0c38058c9",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 38109468,
            "mode": "list",
            "cachedResultName": "Order List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=38109468"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "Phone Number",
                "lookupValue": "={{ $json.msg_to }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          7088,
          0
        ],
        "id": "b39aa828-1740-432e-b093-4d42abde15ee",
        "name": "Get row(s) in sheet6",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Load orders from sheet4\nconst order_list = $(\"Get row(s) in sheet6\").all().map(item => item.json);\n\n// If empty\nif (!order_list.length) {\n  return [{ json: { message: \"You have no orders at the moment.\" } }];\n}\n\n// Group by Order ID\nconst grouped = {};\n\nfor (const row of order_list) {\n  const orderId = row[\"Order ID\"];\n\n  if (!grouped[orderId]) {\n    grouped[orderId] = {\n      items: [],\n      status: row.Status,\n    };\n  }\n\n  grouped[orderId].items.push({\n    item: row.Item,\n    quantity: row.Quantity,\n  });\n}\n\n// Build the message\nlet msg = \"📦 *Your Order Summary*\\n\\nHere’s a quick overview of all your recent orders:\\n\\n\";\n\nfor (const [orderId, data] of Object.entries(grouped)) {\n  const totalQty = data.items.reduce((sum, i) => sum + Number(i.quantity), 0);\n\n  msg += `🧾 *Order ID:* ${orderId}\\n`;\n  msg += `📦 *Total Items:* ${totalQty}\\n`;\n  msg += `📌 *Status:* ${data.status}\\n`;\n  msg += `🛍️ *Items:*\\n`;\n\n  for (const item of data.items) {\n    msg += `   • ${item.item} ×${item.quantity}\\n`;\n  }\n\n  msg += `\\n`;\n}\n\n// msg += \"💬 If you'd like to *track*, *change*, or *cancel* any order, just reply with the Order ID (e.g., *ORD-1764326177122-8178*).\";\n\n// Return final message\nreturn [{ json: { message: msg } }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          7312,
          0
        ],
        "id": "a25040dc-0e22-4fe3-baa4-f504f44cd36a",
        "name": "Code in JavaScript5"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": {{ JSON.stringify($json.message) }}\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          7536,
          0
        ],
        "id": "9c8c3bcc-f3c3-45a9-8018-cb60f2eff792",
        "name": "Send msg5",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "ba2ea282-f5f0-4215-8cfc-eb3d30f46dfd",
                "name": "catalog_id",
                "value": "896416602722897",
                "type": "string"
              },
              {
                "id": "374ced34-cfa5-4dd1-a21b-3e73d722d2d3",
                "name": "msg_to",
                "value": "={{ $json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
                "type": "string"
              },
              {
                "id": "bafa1b69-5374-4c42-ac6c-766dab6487e3",
                "name": "phone_number_id",
                "value": "924412964080974",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          6192,
          768
        ],
        "id": "7e683a33-542f-4d66-854e-a0247fab40af",
        "name": "Add this Variable1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable1')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable1')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"product_list\",\n    \"header\": {\n      \"type\": \"text\",\n      \"text\": \"Baby Care Products\"\n    },\n    \"body\": {\n      \"text\": \"Check out our premium baby care collection\"\n    },\n    \"footer\": {\n      \"text\": \"Best prices guaranteed\"\n    },\n    \"action\": {\n      \"catalog_id\": \"896416602722897\",\n      \"sections\": [\n        {\n          \"title\": \"Pack of 30\",\n          \"product_items\": [\n{\"product_retailer_id\":\"1\"},\n{\"product_retailer_id\":\"2\"},\n{\"product_retailer_id\":\"6\"},\n{\"product_retailer_id\":\"7\"},\n{\"product_retailer_id\":\"8\"},\n{\"product_retailer_id\":\"9\"}\n]\n        },\n        {\n          \"title\": \"Pack of 140\",\n          \"product_items\": [\n{\"product_retailer_id\":\"3\"},{\"product_retailer_id\":\"4\"},{\"product_retailer_id\":\"5\"}]\n        }\n      ]\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          8448,
          592
        ],
        "id": "8d1f7cd2-536f-4595-a009-667c1e49fc4e",
        "name": "Send Multi Product Category1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Read all incoming rows\nconst rows = $input.all().map(i => i.json);\n\n// Utility: normalize category title\nfunction normalizeCategory(cat) {\n  if (!cat) return \"Unknown Pack\";\n  return cat\n    .toLowerCase()\n    .replace(/\\bpack\\b/, \"Pack\")\n    .replace(/\\bof\\b/, \"of\")\n    .replace(/\\s+/g, \" \")\n    .replace(/^./, c => c.toUpperCase());\n}\n\n// Group by category\nconst grouped = {};\n\nfor (const row of rows) {\n  const category = normalizeCategory(row.custom_label_0);\n  const id = row.id;\n\n  if (!category || !id) continue;\n\n  if (!grouped[category]) {\n    grouped[category] = {\n      title: category,\n      product_items: []\n    };\n  }\n\n  grouped[category].product_items.push({\n    product_retailer_id: String(id)\n  });\n}\n\n// Convert grouped object → array\nconst result = Object.values(grouped);\n\n// Return both raw & stringified output\nreturn [\n  {\n    json: {\n      items: result,\n      items_stringified: JSON.stringify(result, null, 2)\n    }\n  }\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1376,
          -1264
        ],
        "id": "7ae0093b-8aac-4ff6-b0e5-5df529d08be7",
        "name": "Code in JavaScript6"
      },
      {
        "parameters": {
          "content": "## Due to payment this Marketing template for catalog is not working, otherwise price strike could have worked here ",
          "height": 384,
          "width": 560
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          384,
          -3984
        ],
        "id": "50bcde49-c97e-44f7-bf62-3774d627ff75",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "8adf164e-e24e-4693-ad9c-540031adbc66",
                "name": "phone_number_id",
                "value": "=924412964080974",
                "type": "string"
              },
              {
                "id": "e90a0536-0be2-43e2-9580-4fd111f19d57",
                "name": "passphrase",
                "value": "=lakshit",
                "type": "string"
              },
              {
                "id": "678e1e3f-c93a-4339-bd3a-77f3b6a2f832",
                "name": "WABA_id",
                "value": "=1513036893303968",
                "type": "string"
              },
              {
                "id": "1dfdb50b-aae0-4614-9923-d73c50aa9cc9",
                "name": "app_version",
                "value": "v24.0",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -1536,
          -3872
        ],
        "id": "38042ab4-07e5-4650-95d1-5260dff19649",
        "name": "set_variable"
      },
      {
        "parameters": {
          "operation": "update",
          "dataTableId": {
            "__rl": true,
            "value": "V6ljo9LKuMy4j8CI",
            "mode": "list",
            "cachedResultName": "Meta Sign in Keys",
            "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/V6ljo9LKuMy4j8CI"
          },
          "filters": {
            "conditions": [
              {
                "keyValue": "2"
              }
            ]
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "publicKey": "={{ $('Code in JavaScript7').item.json.publicKey }}",
              "privateKey": "={{ $('Code in JavaScript7').item.json.privateKey }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "publicKey",
                "displayName": "publicKey",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              },
              {
                "id": "privateKey",
                "displayName": "privateKey",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "readOnly": false,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -864,
          -3872
        ],
        "id": "301b4410-5e01-4fd5-8868-843cf131cccf",
        "name": "Set Public & Private Key"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/{{ $('set_variable').item.json.app_version }}/{{ $('set_variable').item.json.phone_number_id }}/whatsapp_business_encryption",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "contentType": "form-urlencoded",
          "bodyParameters": {
            "parameters": [
              {
                "name": "business_public_key",
                "value": "={{ $json.publicKey }}"
              }
            ]
          },
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -1088,
          -3872
        ],
        "id": "dbbdbf22-0386-49a4-af5e-28face5cadb7",
        "name": "Send Normal Message3",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// n8n Code Node - RSA Key Pair Generator for WhatsApp Flows (CORRECT)\nconst crypto = require('crypto');\n\n// Generate RSA key pair (UNENCRYPTED)\nconst keyPair = crypto.generateKeyPairSync(\"rsa\", {\n  modulusLength: 2048,\n  publicKeyEncoding: {\n    type: \"spki\",\n    format: \"pem\",\n  },\n  privateKeyEncoding: {\n    type: \"pkcs8\",\n    format: \"pem\"\n  },\n});\n\nreturn {\n  json: {\n    success: true,\n    message: \"Unencrypted RSA key pair generated for WhatsApp Flows\",\n    privateKey: keyPair.privateKey,\n    publicKey: keyPair.publicKey,\n    instructions: {\n      step1: \"Store PRIVATE_KEY securely (ENV / Secrets)\",\n      step2: \"Upload PUBLIC_KEY to Meta WhatsApp Flow Encryption\",\n      step3: \"Do NOT add passphrase or cipher\",\n    }\n  }\n};\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1312,
          -3872
        ],
        "id": "7a841f33-8011-4b27-b39f-38fc4f71930f",
        "name": "Code in JavaScript7"
      },
      {
        "parameters": {
          "content": "## Generate Private and Pubic Key and Register Sign Up Public Key",
          "height": 240,
          "width": 1200
        },
        "type": "n8n-nodes-base.stickyNote",
        "typeVersion": 1,
        "position": [
          -1872,
          -3952
        ],
        "id": "ba3bbddf-b4da-4297-a5b0-9923b0ffa5c2",
        "name": "Sticky Note5"
      },
      {
        "parameters": {
          "jsCode": "const crypto = require(\"crypto\");\n\n// ============================\n// INPUTS\n// ============================\n\n// Private key stored in previous node / credentials / set node\nconst PRIVATE_KEY = $input.first().json.privateKey\n  .replace(/\\\\n/g, \"\\n\")\n  .trim();\n\n// Encrypted payload from Meta\nconst encrypted_aes_key = $('Add this Variable').first().json.encrypted_aes_key;\nconst encrypted_flow_data = $('Add this Variable').first().json.encrypted_flow_data;\nconst initial_vector = $('Add this Variable').first().json.initial_vector;\n\n// ============================\n// 1. DECRYPT AES KEY (RSA)\n// ============================\nconst aesKeyBuffer = crypto.privateDecrypt(\n  {\n    key: crypto.createPrivateKey(PRIVATE_KEY),\n    padding: crypto.constants.RSA_PKCS1_OAEP_PADDING,\n    oaepHash: \"sha256\",\n  },\n  Buffer.from(encrypted_aes_key, \"base64\")\n);\n\n// ============================\n// 2. DECRYPT FLOW DATA (AES-128-GCM)\n// ============================\nconst flowDataBuffer = Buffer.from(encrypted_flow_data, \"base64\");\nconst ivBuffer = Buffer.from(initial_vector, \"base64\");\n\nconst TAG_LENGTH = 16;\nconst encryptedBody = flowDataBuffer.subarray(0, -TAG_LENGTH);\nconst authTag = flowDataBuffer.subarray(-TAG_LENGTH);\n\nconst decipher = crypto.createDecipheriv(\n  \"aes-128-gcm\",\n  aesKeyBuffer,\n  ivBuffer\n);\ndecipher.setAuthTag(authTag);\n\nconst decryptedBody = JSON.parse(\n  Buffer.concat([\n    decipher.update(encryptedBody),\n    decipher.final(),\n  ]).toString(\"utf-8\")\n);\n\n// ============================\n// OUTPUT FOR NEXT NODES\n// ============================\nreturn [\n  {\n    json: {\n      decryptedBody,      // Plain WhatsApp Flow JSON\n      aesKeyBuffer,       // Needed for encryption\n      ivBuffer,           // Needed for encryption\n    },\n  },\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1296,
          -2768
        ],
        "id": "e0dd6ba0-87bd-425c-a38b-02fc42da91c6",
        "name": "Decryption"
      },
      {
        "parameters": {
          "operation": "get",
          "dataTableId": {
            "__rl": true,
            "value": "V6ljo9LKuMy4j8CI",
            "mode": "list",
            "cachedResultName": "Meta Sign in Keys",
            "cachedResultUrl": "/projects/iOyc3VpWKvgHH9fv/datatables/V6ljo9LKuMy4j8CI"
          }
        },
        "type": "n8n-nodes-base.dataTable",
        "typeVersion": 1.1,
        "position": [
          -1488,
          -2768
        ],
        "id": "ed2e0fce-1ca1-44be-ad83-a28651639494",
        "name": "Get Private Key"
      },
      {
        "parameters": {
          "jsCode": "const crypto = require(\"crypto\");\n\n// ============================\n// 1. RESPONSE PAYLOAD\n// ============================\nconst responsePayload = $input.first().json.response_to_send;\n\n// ============================\n// 2. REBUILD BUFFERS (IMPORTANT)\n// ============================\nconst aesKeyBuffer = Buffer.from($('Decryption').first().json.aesKeyBuffer.data);\nconst ivBuffer = Buffer.from($('Decryption').first().json.ivBuffer.data);\n\n// ============================\n// 3. FLIP IV (MANDATORY)\n// ============================\nconst flippedIV = Buffer.from(ivBuffer.map(b => ~b));\n\n// ============================\n// 4. ENCRYPT RESPONSE\n// ============================\nconst cipher = crypto.createCipheriv(\n  \"aes-128-gcm\",\n  aesKeyBuffer,\n  flippedIV\n);\n\nconst encryptedResponse = Buffer.concat([\n  cipher.update(JSON.stringify(responsePayload), \"utf-8\"),\n  cipher.final(),\n  cipher.getAuthTag(),\n]);\n\n// ============================\n// 5. RETURN BASE64 STRING\n// ============================\nreturn [\n  {\n    json: {\n      response: encryptedResponse.toString(\"base64\"),\n    },\n  },\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1152,
          -2848
        ],
        "id": "0011a01a-09f4-49dd-9070-9bf14abae1fb",
        "name": "Encryption"
      },
      {
        "parameters": {
          "respondWith": "text",
          "responseBody": "={{ $json.response }}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          1328,
          -2848
        ],
        "id": "2ee9bf4b-2dff-4bd0-a242-6d7d1de1db5b",
        "name": "Response to Meta"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.decryptedBody.screen }}",
                      "rightValue": "USER_INFO",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "4e16a13c-f435-459e-b8b8-76626417efc6"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "User Info"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "9bb75abd-d2ed-4f8f-a87d-8a8a01b235ea",
                      "leftValue": "={{ $json.decryptedBody.screen }}",
                      "rightValue": "ADDRESS",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Address"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          -896,
          -2736
        ],
        "id": "96a54364-7187-4b22-bc9e-04849bd85d38",
        "name": "Screen Routing"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.decryptedBody.action }}",
                      "rightValue": "ping",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "f3c1114e-81b5-41c3-a80c-a986bf16c144"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Health Check"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "375b85ac-66d3-4e85-bf8d-acb7541d24b8",
                      "leftValue": "={{ $json.decryptedBody.action }}",
                      "rightValue": "INIT",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "INIT"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "a006f352-419c-41df-8b88-7e88c975f284",
                      "leftValue": "={{ $json.decryptedBody.action }}",
                      "rightValue": "submit",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Submit"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "726f66a0-2a40-4614-bafe-9d8fe8241388",
                      "leftValue": "={{ $json.decryptedBody.action }}",
                      "rightValue": "data_exchange",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Data Exchange"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          -1088,
          -2816
        ],
        "id": "206576c4-86a7-44b7-b274-8c368ce7cc16",
        "name": "Switch3"
      },
      {
        "parameters": {
          "jsCode": "// Pincode coming from Decryption node\nconst targetPincode = String($(\"Decryption\").item.json.decryptedBody.data.pincode);\n\n// All rows coming from Google Sheets node\nconst sheetItems = items;\n\n// Check if pincode exists in Google Sheet data\nconst exists = sheetItems.some(item => {\n  return String(item.json.pincode) === targetPincode;\n});\n\n// Return true / false\nreturn [\n  {\n    json: {\n      pincode: targetPincode,\n      exists: exists\n    }\n  }\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -480,
          -2752
        ],
        "id": "2ebcc4ae-4b98-4d12-945d-ec10e92b8838",
        "name": "Check Pincode"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 836450484,
            "mode": "list",
            "cachedResultName": "Pincode List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=836450484"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -656,
          -2752
        ],
        "id": "7b8e1ad0-1af9-46b5-ba74-0bd50a3966c9",
        "name": "Get Servicable Pincode",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "8cdaaee7-bbcc-4cb6-97ab-78b44d35a5c2",
                "leftValue": "={{ $json.exists }}",
                "rightValue": "",
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -304,
          -2752
        ],
        "id": "3fd6e732-67be-4fef-8f22-dfc6903a1533",
        "name": "Pincode Routing"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
                "name": "response_to_send",
                "value": "={\n  \"screen\": \"ADDRESS\",\n  \"data\": {}\n}\n",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          560,
          -2768
        ],
        "id": "247c205d-fb96-4fb4-8ba1-694ab5279e16",
        "name": "Address Screen"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
                "name": "response_to_send",
                "value": "={\n  \"screen\": \"NOT_DELIVERABLE\",\n  \"data\": {}\n}\n",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          384,
          -2640
        ],
        "id": "a2ed1348-3d75-4b26-a461-48dc16510ae8",
        "name": "Not deliverable Screen"
      },
      {
        "parameters": {
          "operation": "appendOrUpdate",
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1124433720,
            "mode": "list",
            "cachedResultName": "User Info",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Phone Number": "={{ $node['Decryption'].json.decryptedBody.flow_token }}",
              "Name from API": "=",
              "User Entered Name": "={{ $node['Decryption'].json.decryptedBody.data.name }}",
              "Pincode": "={{ $node['Decryption'].json.decryptedBody.data.pincode }}"
            },
            "matchingColumns": [
              "Phone Number"
            ],
            "schema": [
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name from API",
                "displayName": "Name from API",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "User Entered Name",
                "displayName": "User Entered Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Pincode",
                "displayName": "Pincode",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Address Line 1",
                "displayName": "Address Line 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Address Line 2",
                "displayName": "Address Line 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "City ",
                "displayName": "City ",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "State",
                "displayName": "State",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -112,
          -2784
        ],
        "id": "cbac414e-80ae-4e30-aa63-8750a4adce53",
        "name": "Add User Info",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "operation": "appendOrUpdate",
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1124433720,
            "mode": "list",
            "cachedResultName": "User Info",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Phone Number": "={{ $node['Decryption'].json.decryptedBody.flow_token }}",
              "Address Line 1": "={{ $json.decryptedBody.data.line1 }}",
              "Address Line 2": "={{ $json.decryptedBody.data.line2 }}",
              "City ": "={{ $json.decryptedBody.data.city }}",
              "State": "={{ $json.decryptedBody.data.state }}"
            },
            "matchingColumns": [
              "Phone Number"
            ],
            "schema": [
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name from API",
                "displayName": "Name from API",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "User Entered Name",
                "displayName": "User Entered Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Pincode",
                "displayName": "Pincode",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Address Line 1",
                "displayName": "Address Line 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Address Line 2",
                "displayName": "Address Line 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "City ",
                "displayName": "City ",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "State",
                "displayName": "State",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -64,
          -2512
        ],
        "id": "f705fbb9-2d70-4626-9bc5-58440e01d78e",
        "name": "Add User Info1",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
                "name": "response_to_send",
                "value": "={\n  data: {\n    status: \"active\",\n  },\n}",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          384,
          -3216
        ],
        "id": "56521ad5-5062-48e8-b8fd-5faaba2db2e0",
        "name": "Health Check"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
                "name": "response_to_send",
                "value": "={\n  \"screen\": \"USER_INFO\",\n  \"data\": {}\n}\n",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          384,
          -3024
        ],
        "id": "c9838b86-fec5-4581-abfb-ec343376f893",
        "name": "Init Screen &data"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "f8925f46-cb8a-4c44-bb2b-edfd2e69269b",
                "leftValue": "={{ $json.encrypted_flow_data }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              },
              {
                "id": "5e773f01-2501-43ab-b7a1-372349187f29",
                "leftValue": "={{ $json.encrypted_aes_key }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              },
              {
                "id": "b8351a34-36d5-4c95-9006-6f7f59910193",
                "leftValue": "={{ $json.initial_vector }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -2064,
          -1872
        ],
        "id": "a7322999-7a22-4232-8d81-b752f00e3c06",
        "name": "Is Flow Response"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/{{ $('Add this Variable').item.json.app_version }}/{{ $('Add this Variable').item.json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"recipient_type\": \"individual\",\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"flow\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.postimg.cc/c44WrvSB/Whats-App-Image-2026-01-18-at-19-52-45.jpg\"\n      }\n    },\n    \"body\": {\n      \"text\": \"We help parents get safe and comfortable diapers delivered to their doorstep.\\n\\nBefore you browse products, we just need your name and PIN code to check delivery availability in your area. It’ll only take a moment 😊\\n\"\n    },\n    \"footer\": {\n      \"text\": \"🔒 Your details are safe and used only for delivery\"\n    },\n    \"action\": {\n      \"name\": \"flow\",\n      \"parameters\": {\n        \"flow_message_version\": \"3\",\n        \"flow_id\": \"{{ $('Add this Variable').item.json.user_flow_id }}\",\n        \"flow_cta\": \"Get Started\",\n        \"flow_token\": \"{{ $('Add this Variable').item.json.msg_to }}\"\n      }\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          592,
          -1776
        ],
        "id": "919a372f-5a15-4777-b298-bb0648838261",
        "name": "Send User Info Flow",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1124433720,
            "mode": "list",
            "cachedResultName": "User Info",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "Phone Number",
                "lookupValue": "={{ $json.msg_to }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          48,
          -1600
        ],
        "id": "daae6355-88db-4e15-9d84-53996ef0198a",
        "name": "Fetch User Info",
        "alwaysOutputData": true,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "ecf1c08a-71e3-4540-9acf-acf52dc5c5a8",
                "leftValue": "={{ $(\"Fetch User Info\").item.json.keys() }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          256,
          -1600
        ],
        "id": "b7c3a9f0-f1c4-477e-9e09-045547f0431b",
        "name": "Is User First Time"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi {{ $('Add this Variable').item.json.user_name }} 👋 \\nWelcome to Butruu! You can:\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"order_status\",\n            \"title\": \"Order Status\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ask_faq\",\n            \"title\": \"Ask FAQs\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -320,
          -832
        ],
        "id": "f78086e0-6261-45f0-a49d-108cd49c024e",
        "name": "Initial Btn Msg",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Here’s the delivery information we have saved for you:\\n\\n👤 *Name:* {{ $json['User Entered Name'] }}\\n📍 *PIN Code:* {{ $json.Pincode }}\\n🏠 *Delivery Address:*\\n  - *Line 1:* {{ $json['Address Line 1'] }}\\n  - *Line 2:* {{ $json['Address Line 2'] }}\\n  - *City:* {{ $json['City '] }}\\n  - *State:* {{ $json.State }}\\n\\nIf everything looks correct, you can continue and browse products.\\nIf you’d like to change anything, you can update it now.\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"update_user_info\",\n            \"title\": \"Update Address\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"use_saved_details\",\n            \"title\": \"Continue\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          592,
          -1568
        ],
        "id": "3fc8fa4e-7335-484f-97a0-dc3b4e059da4",
        "name": "Ask User to Update Info",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/{{ $('Switch1').item.json.app_version }}/{{ $('Switch1').item.json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"recipient_type\": \"individual\",\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $(\"Switch1\").item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"flow\",\n    \"header\": {\n      \"type\": \"image\",\n      \"image\": {\n        \"link\": \"https://i.postimg.cc/c44WrvSB/Whats-App-Image-2026-01-18-at-19-52-45.jpg\"\n      }\n    },\n    \"body\": {\n      \"text\": \"No problem at all 👍\\n\\nYou can update your delivery details below to make sure everything is correct.\\n\\nPlease review and edit your name, PIN code, or address as needed.\"\n    },\n    \"footer\": {\n      \"text\": \"🔒 Your details are safe and used only for delivery\"\n    },\n    \"action\": {\n      \"name\": \"flow\",\n      \"parameters\": {\n        \"flow_message_version\": \"3\",\n        \"flow_id\": \"{{ $(\"Switch1\").item.json.user_flow_id }}\",\n        \"flow_cta\": \"Update Details\",\n        \"flow_token\": \"{{ $(\"Switch1\").item.json.msg_to }}\",\n        \"flow_action_payload\": {\n            \"screen\": \"USER_INFO\",\n            \"data\": {\n                \"name\": \"{{ $json['User Entered Name'] }}\",\n                \"pincode\": \"{{ $json.Pincode }}\"\n            }\n        }\n      }\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          48,
          -1408
        ],
        "id": "8aaa8bbc-d559-45e6-98d9-35c46f917f31",
        "name": "Update User Info",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1124433720,
            "mode": "list",
            "cachedResultName": "User Info",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "Phone Number",
                "lookupValue": "={{ $json.msg_to }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -128,
          -1408
        ],
        "id": "85c6352a-9013-4620-8b37-e5ed148c7631",
        "name": "Fetch User Info1",
        "alwaysOutputData": false,
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "b8083ca9-23de-45ca-8615-2b331277a312",
                "name": "response_to_send",
                "value": "={{ $json.response_to_send }}",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          992,
          -2848
        ],
        "id": "e74a8b21-b313-4d16-9d9c-99629524ae44",
        "name": "Common Meta vari"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "263eb8a1-0b0b-4e98-bede-2ca52dc566ed",
                "leftValue": "={{ $json.success }}",
                "rightValue": "false",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -560,
          -1152
        ],
        "id": "4939cfcd-6a1c-4eef-98c8-bf30a5a1cf64",
        "name": "If Stock is not available"
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1124433720,
            "mode": "list",
            "cachedResultName": "User Info",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=1124433720"
          },
          "filtersUI": {
            "values": [
              {
                "lookupColumn": "Phone Number",
                "lookupValue": "={{ $json['Phone Number'] }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          48,
          -2784
        ],
        "id": "d6c5c5d0-1dd4-4310-8339-7d7f3aabbc51",
        "name": "Get address data",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "4aaba323-7670-4dfc-968c-d964e5e1696b",
                "leftValue": "={{ String($json['Address Line 1']) }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          256,
          -2784
        ],
        "id": "25130f94-3b82-4363-a79e-ac26a5d1afc4",
        "name": "Is address added"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
                "name": "response_to_send",
                "value": "={\n  \"screen\": \"ADDRESS\",\n  \"data\": {\n    \"line1\": \"{{ $json['Address Line 1'] }}\",\n    \"line2\": \"{{ $json['Address Line 2'] }}\",\n    \"city\": \"{{ $json['City '] }}\",\n    \"state\": \"{{ $json.State }}\"\n  }\n}\n",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          560,
          -2912
        ],
        "id": "e057a3ce-bea2-4eda-9cb0-3d853265826b",
        "name": "Address with Payload"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "08128ca4-7c59-4a3a-b137-e5eed4fabd45",
                "name": "response_to_send",
                "value": "={\n  \"screen\": \"THANK_YOU\",\n  \"data\": {\n    \"message\": \"Address Added\"\n  }\n}\n",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          384,
          -2496
        ],
        "id": "fb519084-ce8c-4e79-bb70-03c7aed0a98e",
        "name": "Thank you Screen"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "a2b0f34c-009c-46d7-9957-a0d79ad21b5d",
                "leftValue": "={{ $('Parse Flow Response').item.json.status }}",
                "rightValue": "true",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2.3,
        "position": [
          -624,
          -1392
        ],
        "id": "ae20ebae-5a4c-4175-b7b7-bcad1556f165",
        "name": "Filter2"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $json.msg }}",
          "options": {
            "systemMessage": "=## Role:\n- You are an intent-classification AI used inside a WhatsApp automation system powered by the Meta WhatsApp Cloud API.\n- Your primary responsibility is to analyze the user’s incoming message and classify it into exactly one of the following two categories:\n\n## Allowed Categories (STRICT)\n- GREETING\n- FAQ\n\nNo other category is allowed.\nDo not invent or infer extra intent types.\n\n#🧠 Classification Rules\n\n## 1️⃣ GREETING\nClassify the message as GREETING if ANY of the following conditions are true:\n- The user sends a greeting or salutation, including but not limited to:\n  - “hi”, “hello”, “hey”, “hii”, “hiii”\n  - “good morning”, “good evening”, “gm”, “gn”\n  - “namaste”, “hola”, “yo”, “sup”\n\n- The user is asking for the menu, even indirectly:\n  - “menu”\n  - “show menu”\n  - “options”\n  - “list”\n\n- The user sends a very short or vague message that is conversational but not a question:\n  - “hi there”\n  - “anyone?”\n  - “help”\n\n- The user makes spelling mistakes or informal variants related to greetings or menu:\n  - “menue”\n  - \"manu\"\n  - “mene”\n  - “servis”\n  - “optins”\n\n- The user intent is to start a conversation, not to seek a specific answer.\n\n## 2️⃣ FAQ\nClassify the message as FAQ if ALL of the following are true:\n- The user is asking a specific, informational question\n- The question relates to:\n  - Pricing\n  - Services\n  - Process\n  - Timelines\n  - Policies\n  - Support\n  - Technical or business-related information\n\n- The intent is to get an answer, not just start a conversation\nExamples of FAQ messages:\n- “What is the price of your service?”\n- “How long does the setup take?”\n- “Do you support WhatsApp automation?”\n- “What are your working hours?”\n- “How does this system work?”\n- “Can you integrate with CRM?”\n\n## ⚠️ Important Edge-Case Rules\n- If the message contains both greeting + question, classify as:\nFAQ\nExample: “Hi, what is your pricing?”\n\n- If the message is ambiguous, default to FAQ\n- Emojis alone like 👋 🙂 👉 classify as GREETING\n- Do not ask clarification questions for classification\n\n## Output rules (STRICT — DO NOT BREAK):\n\n- Return ONLY a valid JSON object.\n- Do NOT use markdown.\n- Do NOT wrap the response in ```json.\n- Do NOT add explanations, text, or comments.\n- Do NOT return arrays.\n- Always return both keys.\n\n## Output format (EXACT):\n\n{\n  \"category\": \"GREETING\" or \"FAQ\"\n}\n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3.1,
        "position": [
          -1088,
          -704
        ],
        "id": "9dda354d-adf0-408f-a990-80b69190fe1b",
        "name": "AI Agent"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-5-nano",
            "mode": "list",
            "cachedResultName": "gpt-5-nano"
          },
          "builtInTools": {},
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.3,
        "position": [
          -1088,
          -496
        ],
        "id": "4f2397bb-ad60-42e7-aa13-10af2304c5ec",
        "name": "OpenAI Chat Model",
        "credentials": {
          "openAiApi": {
            "id": "L3P9Ae81haTD2rYm",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Get raw AI output (string)\nconst raw = $json.text || $json.output || $json.response;\n\n// Defensive parsing\nlet parsed;\n\ntry {\n  parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;\n} catch (e) {\n  // Fallback if parsing fails\n  parsed = {\n    category: \"FAQ\"\n  };\n}\n\n// Return normalized output\nreturn [\n  {\n    json: {\n      category: parsed.category || \"FAQ\"\n    }\n  }\n];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -736,
          -704
        ],
        "id": "69cd0e8f-d7b9-4a2c-8703-6885d1d467dd",
        "name": "Code in JavaScript9"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "3928bbfc-c8a1-4e13-8d26-0552beb96287",
                "leftValue": "={{ $json.category }}",
                "rightValue": "GREETING",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -528,
          -704
        ],
        "id": "1599f144-05f0-4bf8-b739-b17a2ec3a069",
        "name": "If Greeting"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Set Variable').item.json.msg }}",
          "options": {
            "systemMessage": "=You are a customer support assistant for BUTRUU, a WhatsApp-based ordering platform for baby diapers.\n\nYour job is to answer user questions ONLY using the information provided in the uploaded FAQ document.\n\nSTRICT RULES (DO NOT BREAK):\n- Use the FAQ document as the single source of truth.\n- Answer only questions related to ordering, payments, products, delivery, address, invoices, cancellations, returns, offers, privacy, or support as mentioned in the FAQ.\n- If the answer is NOT present in the FAQ, politely say that the information is currently unavailable and suggest contacting support.\n- Do NOT invent, assume, or guess any information.\n- Do NOT provide legal, medical, or unrelated advice.\n- Do NOT mention internal systems, PDFs, files, or that you are an AI.\n\nRESPONSE STYLE:\n- Keep responses short, clear, and WhatsApp-friendly.\n- Use simple language suitable for all users.\n- Be polite, helpful, and reassuring.\n- Use bullet points only when it improves clarity.\n- Avoid long paragraphs.\n\nWHATSAPP CONTEXT:\n- Assume the user is chatting on WhatsApp.\n- Do NOT use markdown formatting.\n- Do NOT use emojis excessively (0–1 max, only if natural).\n- Do NOT ask unnecessary follow-up questions unless required.\n\nFALLBACK HANDLING:\n- If a user asks something outside the FAQ scope, respond with:\n  “I don’t have this information right now. Please tap ‘Talk to Support’ from the menu for further assistance.”\n\nYour goal is to provide accurate, consistent, and trustworthy answers that match the BUTRUU WhatsApp FAQ exactly.\n\nOne question which is missing in docs which need to be answered is \nQ: Are you a distributor?\nA: Provide a clear option to share email ID – contact@alistersbharat.com and phone number-9875578080 for further contact. \n"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3.1,
        "position": [
          -48,
          -624
        ],
        "id": "8d4e2294-91f3-4df0-bcd9-8a84cf10a8e3",
        "name": "AI Agent1"
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "value": "gpt-5-nano",
            "mode": "list",
            "cachedResultName": "gpt-5-nano"
          },
          "builtInTools": {
            "fileSearch": {
              "vectorStoreIds": "[\"vs_695fef6308b48191ba94f1750b8d3746\"]",
              "filters": "={{ null }}",
              "maxResults": "={{ null }}"
            }
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.3,
        "position": [
          -112,
          -400
        ],
        "id": "58a9f6cc-eded-41b8-80d1-e52c60af2d90",
        "name": "OpenAI Chat Model1",
        "credentials": {
          "openAiApi": {
            "id": "48jg0IN7QfVXoF59",
            "name": "OpenAi Freelance"
          }
        }
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Set Variable').item.json.msg_to }}"
        },
        "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
        "typeVersion": 1.3,
        "position": [
          48,
          -400
        ],
        "id": "d75fd83e-d162-43b4-9d9d-80a7f3adc450",
        "name": "Simple Memory"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.output.replace(/\\n/g, '\\\\n').replace(/\"/g, \"'\") }}\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          304,
          -624
        ],
        "id": "1e206d68-a064-4351-9e6c-cff52594885b",
        "name": "Send msg6",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Set Variable').item.json.msg_id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -272,
          -624
        ],
        "id": "4bc7ab11-2a4b-4b75-9f43-1b8b86650049",
        "name": "Typing Indicator",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "41b1d588-e381-4281-9aa0-f57489ade13a",
                "leftValue": "={{ $('Get row(s) in sheet4').item.json.keys() }}",
                "rightValue": "",
                "operator": {
                  "type": "array",
                  "operation": "empty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          48,
          -2160
        ],
        "id": "fd36f564-8482-4035-981a-8ade99a68266",
        "name": "If"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi 😊\\nIt looks like you don’t have any active orders at the moment.\\n\\nYou can place a new order by tapping Browse Products below and choosing the diapers you need.\\nIf you need any help, I’m right here 💚\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          336,
          -2176
        ],
        "id": "c7a3e116-9e00-4513-85f0-a1d1a4ea0ebb",
        "name": "No Order Msg",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v24.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Hi {{ $json.user_name }} 👋 \\nWelcome to Butruu! You can:\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"browse_product\",\n            \"title\": \"Browse Product\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"order_status\",\n            \"title\": \"Order Status\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"ask_faq\",\n            \"title\": \"Ask FAQs\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -976,
          -1712
        ],
        "id": "713c8cc1-7a94-450d-a125-29be3a4b5835",
        "name": "Initial Btn Msg1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Load orders from sheet4\nconst order_list = $(\"Get row(s) in sheet4\").all().map(item => item.json);\n\n// If empty\nif (!order_list.length) {\n  return [{ json: { message: \"You have no orders at the moment.\" } }];\n}\n\n// Group by Order ID\nconst grouped = {};\n\nfor (const row of order_list) {\n  const orderId = row[\"Order ID\"];\n\n  if (!grouped[orderId]) {\n    grouped[orderId] = {\n      items: [],\n      status: row.Status,\n    };\n  }\n\n  grouped[orderId].items.push({\n    item: row.Item,\n    quantity: row.Quantity,\n  });\n}\n\n// Build the message\nlet msg = \"📦 *Your Order Summary*\\n\\nHere’s a quick overview of all your recent orders:\\n\\n\";\n\nfor (const [orderId, data] of Object.entries(grouped)) {\n  const totalQty = data.items.reduce((sum, i) => sum + Number(i.quantity), 0);\n\n  msg += `🧾 *Order ID:* ${orderId}\\n`;\n  msg += `📦 *Total Items:* ${totalQty}\\n`;\n  msg += `📌 *Status:* ${data.status}\\n`;\n  msg += `🛍️ *Items:*\\n`;\n\n  for (const item of data.items) {\n    msg += `   • ${item.item} × ${item.quantity}\\n`;\n  }\n\n  msg += `\\n`;\n}\n\n// msg += \"💬 If you'd like to *track*, *change*, or *cancel* any order, just reply with the Order ID (e.g., *ORD-1764326177122-8178*).\";\n\n// Return final message\nreturn [{ json: { message: msg } }];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          112,
          -1856
        ],
        "id": "208fb11b-82f2-4a30-b4c1-37418dca6021",
        "name": "Code in JavaScript10"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Set Variable').item.json.msg }}",
          "options": {
            "systemMessage": "=You are BUTRUU WhatsApp FAQ Assistant, a polite, friendly, and helpful text-based assistant for Butruu customers.\n\n🎯 Your Role\nYour job is to answer customer questions strictly using the official BUTRUU FAQ information provided below.\nYou respond only through plain text messages. There are no buttons, menus, or UI elements—only user-typed messages.\n\n🧠 Knowledge & Accuracy Rules\n- The FAQ content below is your only source of truth.\n- Do not assume, invent, or guess any information.\n- Do not promise features, timelines, refunds, or services not explicitly mentioned.\n- If a question is outside the FAQs, reply politely:\n  - “I’m sorry, I don’t have that information right now. Please contact our support team for further help.”\n\n🗣️ Tone & Style\n- Keep replies short, clear, and WhatsApp-friendly.\n- Be warm, calm, and respectful—suitable for parents and caregivers.\n- Use simple language; avoid technical or internal terms.\n- Do not mention AI, systems, workflows, or automation.\n- Emojis are allowed but must be minimal and friendly.\n\n🔁 Conversation Guidance\n- Answer only what the user asks.\n- If the user asks multiple questions, respond in a clear, structured way.\n- If the user seems unsure what to ask, gently encourage them to ask their question in plain words.\n- If the user wants to start over or see general options, inform them that they can type “hello” or “menu”.\n\n🚫 Hard Restrictions\n- No express or same-day delivery.\n- No order cancellation after dispatch.\n- No returns for opened diaper packs.\n- No delivery confirmation for non-serviceable pincodes.\n- No medical advice beyond the FAQs.\n\n📚 OFFICIAL BUTRUU FAQ KNOWLEDGE BASE\n\n(Use this content exactly as provided, without modification or expansion.)\n\n## Ordering\n- Orders can be placed directly on WhatsApp by selecting products and confirming delivery details.\n- Products can be edited before final confirmation only.\n- Order confirmation is sent after payment and address confirmation.\n- Order status includes: Order Placed, Order Dispatched, Order Delivered.\n\n## Payments\n- Payment options include UPI, online payments, and Cash on Delivery (if available).\n- If payment fails, users can retry or choose COD if available. No amount is deducted.\n\n## Product & Usage\n- Diaper sizes:\n  - Small (S): Up to 7 kg\n  - Medium (M): 7–12 kg\n  - Large (L): 9–14 kg\n- Diapers are dermatologically tested and baby-safe.\n- Regular diaper changes help prevent rashes.\n- Babies usually need 4–5 diapers per day on average.\n\n## Delivery\n- Delivery usually takes 1–2 working days.\n- Express delivery is not available.\n- Non-serviceable pincodes are informed politely.\n- Delivery depends on courier availability.\n\n## Address & Invoice\n- Addresses can be saved or updated before dispatch.\n- Invoice is sent on WhatsApp after order confirmation.\n- Prices include applicable taxes.\n\n## Cancellations & Issues\n- Orders can be cancelled only before dispatch.\n- Address changes are allowed only before dispatch.\n- Damaged or wrong products must be reported within 24 hours with photos.\n- Opened diaper packs are non-returnable.\n\n## Repeat, Bulk & Offers\n- Previous orders can be reordered.\n- Bulk and repeat orders are supported.\n- Offers are included in WhatsApp prices and may change.\n- Order updates are sent on WhatsApp.\n\n## Privacy & Support\n- Customer data is securely stored and used only for order processing.\n- Support is available during working hours.\n\n💚 Core Principle\nAlways prioritize clarity, honesty, and care.\nEvery response should make the customer feel supported and confident."
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 3.1,
        "position": [
          -352,
          -208
        ],
        "id": "0e2712b0-f1e5-458b-b468-4bd4fc52b5e2",
        "name": "Backup agent with all info without file"
      },
      {
        "parameters": {
          "dataToSave": {
            "values": [
              {
                "key": "message_id",
                "value": "={{ $json.message_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.executionData",
        "typeVersion": 1.1,
        "position": [
          -2672,
          -1872
        ],
        "id": "90c5f8f9-094a-4a6b-aae8-8dbb3d312bf5",
        "name": "Search by Message ID"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "9cfed853-fd48-4548-93f0-4331ef97a502",
                "name": "message_id",
                "value": "={{ $json.body.entry[0].changes[0].value.messages?.[0]?.id || $json.body.entry[0].changes[0].value.statuses?.[0]?.id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -2880,
          -1872
        ],
        "id": "96993af3-f70f-4ff0-a7c6-4b55b1e822aa",
        "name": "Common Variable"
      },
      {
        "parameters": {
          "dataToSave": {
            "values": [
              {
                "key": "message_id",
                "value": "={{ $json.body.messages[0].id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.executionData",
        "typeVersion": 1.1,
        "position": [
          -112,
          -832
        ],
        "id": "269cbb0c-52f6-4e90-a794-5c1e4aa0ed8b",
        "name": "Execution Data"
      },
      {
        "parameters": {
          "respondWith": "noData",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.5,
        "position": [
          -1856,
          -1776
        ],
        "id": "043d57d0-5c4e-4498-ada7-573dd72b0e0e",
        "name": "Give meta 200 Success"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"🎉 Your order has been placed successfully!\\n\\nWe’re preparing it for delivery and will update you soon.\\n\\nWould you like to share quick feedback about your ordering experience?\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"main_menu\",\n            \"title\": \"🏠 Main Menu\"\n          }\n        },\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"share_feedback\",\n            \"title\": \"💬 Share Feedback\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          736,
          -2352
        ],
        "id": "26831b99-253a-4d91-bb01-8ff8dac0aa6c",
        "name": "Send Main Menu & Feedback",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/{{ $('Add this Variable').item.json.app_version }}/{{ $('Add this Variable').item.json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"recipient_type\": \"individual\",\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Add this Variable').item.json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"flow\",\n    \"body\": {\n      \"text\": \"Thanks for choosing to share your feedback 💙 \\n\\nPlease fill out the quick form below.\"\n    },\n    \"footer\": {\n      \"text\": \"It’ll take less than 30 seconds 😊\"\n    },\n    \"action\": {\n      \"name\": \"flow\",\n      \"parameters\": {\n        \"flow_message_version\": \"3\",\n        \"flow_id\": \"{{ $('Add this Variable').item.json.user_feedback_flow_id }}\",\n        \"flow_cta\": \"Start Feedback\",\n        \"flow_token\": \"user_feedback\"\n      }\n    }\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          48,
          -1728
        ],
        "id": "8d2471c1-c41d-4531-a2ae-d279c317b388",
        "name": "Share Feedback Flow ",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "1ecbf9a1-47ab-4e73-848f-51b0e9abfb44",
                "leftValue": "={{ $json.msg }}",
                "rightValue": "=/^(hi+|hey+|hello+|hola+|yo+|sup+|wassup+|what'?s\\s?up|greetings|good\\s?(morning|afternoon|evening)|menu|show\\s?menu|options|show\\s?options|help)[\\s!.,]*$/i",
                "operator": {
                  "type": "string",
                  "operation": "regex"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -1408,
          -704
        ],
        "id": "1d310002-23c7-4ea9-9734-b84774e4643b",
        "name": "Is Greeting Message"
      },
      {
        "parameters": {
          "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst response_json = $('Whatsapp Bot Webhook').first().json.body.entry[0].changes[0].value.messages[0].interactive.nfm_reply.response_json;\nconsole.log(response_json)\n// Step 2: Parse response_json\nlet parsedResponseJson;\ntry {\n  parsedResponseJson = JSON.parse(response_json);\n} catch (error) {\n  throw new Error('Invalid JSON in response_json: ' + error.message);\n}\n\nconst status = parsedResponseJson.status\nconst flow_token = parsedResponseJson.flow_token\n\nreturn [\n  {\n    json: {\n      status,\n      flow_token,\n      parsed_json: parsedResponseJson\n    }\n  }\n];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1024,
          -1552
        ],
        "id": "a0769298-32da-4e73-acf3-6a4b36604ada",
        "name": "Parse Flow Response"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "601047c8-ef22-41b1-8b84-6d1017a0b5e9",
                "leftValue": "={{ $('Parse Flow Response').item.json.flow_token }}",
                "rightValue": "user_feedback",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          -816,
          -1552
        ],
        "id": "c395372d-d29a-4b45-a089-1b033adf96cd",
        "name": "Is User Response"
      },
      {
        "parameters": {
          "operation": "append",
          "documentId": {
            "__rl": true,
            "value": "1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU",
            "mode": "list",
            "cachedResultName": "catalog_products",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 2046972948,
            "mode": "list",
            "cachedResultName": "User Feedback",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qNcwhfZ3p9c6UdqmrroMieFeawXX_UND-OMsRnEjbSU/edit#gid=2046972948"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Phone Number": "={{ $('Add this Variable').item.json.msg_to }}",
              "Overall Exp": "={{ $('Parse Flow Response').item.json.parsed_json.overall_exp }}",
              "Issues": "={{ $('Parse Flow Response').item.json.parsed_json.issues }}",
              "Ease Use": "={{ $('Parse Flow Response').item.json.parsed_json.ease_use }}",
              "Clarity": "={{ $('Parse Flow Response').item.json.parsed_json.clarity }}",
              "Suggestions": "={{ $('Parse Flow Response').item.json.parsed_json.suggestions }}"
            },
            "matchingColumns": [],
            "schema": [
              {
                "id": "Phone Number",
                "displayName": "Phone Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Overall Exp",
                "displayName": "Overall Exp",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Issues",
                "displayName": "Issues",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Ease Use",
                "displayName": "Ease Use",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Clarity",
                "displayName": "Clarity",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Suggestions",
                "displayName": "Suggestions",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          -624,
          -1648
        ],
        "id": "765a81fc-4346-49e4-9610-b2744585c770",
        "name": "Add User Feedback to Sheet",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "cZc9FZPSLRtIq9IL",
            "name": "Lakshit77 Account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"Thank you for your feedback 💙\\n\\nWe truly appreciate you taking the time to share your experience with us.\\n\\nIf there’s anything else you’d like to explore, feel free to continue below 😊\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"main_menu\",\n            \"title\": \"🏠 Main Menu\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -416,
          -1648
        ],
        "id": "cb74dc2e-b986-4cc4-99cf-7025c275e5c4",
        "name": "Send Main Menu",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $node['Add this Variable'].json.msg_to }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": {{ JSON.stringify($json.message) }}\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          816,
          -2000
        ],
        "id": "df8f3936-f6e8-4e3f-9cbd-df5170cf6918",
        "name": "Send Order Status",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          544,
          -2016
        ],
        "id": "3de64a26-ad06-4855-b2bd-6a1398c05d22",
        "name": "Loop Over Items"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          816,
          -2160
        ],
        "id": "d2242aa2-fd80-4ee1-b3cb-b328c6f91e89",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/v22.0/{{ $items('Add this Variable')[0].json.phone_number_id }}/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\": \"{{ $items('Add this Variable')[0].json.msg_to }}\",\n  \"type\": \"interactive\",\n  \"interactive\": {\n    \"type\": \"button\",\n    \"body\": {\n      \"text\": \"That’s your complete order history.\\n\\nYou can continue from the main menu below.\"\n    },\n    \"action\": {\n      \"buttons\": [\n        {\n          \"type\": \"reply\",\n          \"reply\": {\n            \"id\": \"main_menu\",\n            \"title\": \"Go back to Main Menu\"\n          }\n        }\n      ]\n    }\n  }\n}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1200,
          -2160
        ],
        "id": "08fc9b20-a062-4b6a-abd2-8c75198b7f75",
        "name": "Send Main Menu Message",
        "credentials": {
          "httpHeaderAuth": {
            "id": "iR5q4Pc809XWa04V",
            "name": "whatsapp wa-agent-alister app Lakshit"
          }
        }
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.limit",
        "typeVersion": 1,
        "position": [
          1024,
          -2160
        ],
        "id": "1783610e-f074-4a8e-b390-46e2a0808b13",
        "name": "Limit4"
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Check if Template",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check if Template": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send Initial Template",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet": {
        "main": [
          [
            {
              "node": "mapping_item",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create List picker template OG": {
        "main": [
          [
            {
              "node": "Send Template",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "mapping_item": {
        "main": [
          [
            {
              "node": "Create List picker template OG",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Get row(s) in sheet",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send Normal Message2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send Normal Message",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get Item ID",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "list_quantity",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create List Quantity picker ": {
        "main": [
          [
            {
              "node": "Send Quantity Template",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "list_quantity": {
        "main": [
          [
            {
              "node": "Create List Quantity picker ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Item ID": {
        "main": [
          [
            {
              "node": "Get row(s) in sheet1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet1": {
        "main": [
          [
            {
              "node": "Confirmation Template",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Confirmation Template": {
        "main": [
          [
            {
              "node": "Send Confirm Template",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Normal Message": {
        "main": [
          [
            {
              "node": "Send Initial Template1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields": {
        "main": [
          [
            {
              "node": "Get row(s) in sheet2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet2": {
        "main": [
          [
            {
              "node": "Append row in sheet",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Append row in sheet": {
        "main": [
          [
            {
              "node": "Send Normal Message1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Whatsapp Bot Webhook": {
        "main": [
          [
            {
              "node": "Check webhook configure parameter",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Common Variable",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check webhook configure parameter": {
        "main": [
          [
            {
              "node": "Verify Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Variable": {
        "main": [
          [
            {
              "node": "Is Greeting Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Initial Template": {
        "main": [
          []
        ]
      },
      "Filter": {
        "main": [
          [
            {
              "node": "Add this Variable",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Interative Type Route": {
        "main": [
          [
            {
              "node": "Switch1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Parse Flow Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet3": {
        "main": [
          [
            {
              "node": "Code in JavaScript6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch1": {
        "main": [
          [
            {
              "node": "Edit Fields2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get row(s) in sheet4",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "FAQ msg",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Cancel Msg",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Fetch User Info",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get row(s) in sheet3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Fetch User Info1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Initial Btn Msg",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Share Feedback Flow ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "When clicking ‘Execute workflow’": {
        "main": [
          [
            {
              "node": "set_variable",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Compliance Info Post": {
        "main": [
          [
            {
              "node": "Compliance Info Get",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Message Type Routing": {
        "main": [
          [
            {
              "node": "Interative Type Route",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Set Variable2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Set Variable",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Stock data": {
        "main": [
          [
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "If Stock is not available",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Error message": {
        "main": [
          [
            {
              "node": "Send msg",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Variable2": {
        "main": [
          [
            {
              "node": "Get Stock data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send msg": {
        "main": [
          [
            {
              "node": "Get row(s) in sheet3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Succes Msg": {
        "main": [
          [
            {
              "node": "Edit Fields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request2": {
        "main": [
          []
        ]
      },
      "Insert row": {
        "main": [
          [
            {
              "node": "Limit",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields1": {
        "main": [
          [
            {
              "node": "Split Out",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Out": {
        "main": [
          [
            {
              "node": "Code in JavaScript1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields2": {
        "main": [
          [
            {
              "node": "Get row(s)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)": {
        "main": [
          [
            {
              "node": "Append row in sheet2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Limit": {
        "main": [
          [
            {
              "node": "HTTP Request2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript1": {
        "main": [
          [
            {
              "node": "Insert row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Append row in sheet2": {
        "main": [
          [
            {
              "node": "Limit1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Limit1": {
        "main": [
          [
            {
              "node": "Send Main Menu & Feedback",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet4": {
        "main": [
          [
            {
              "node": "If",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript2": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add this Variable": {
        "main": [
          [
            {
              "node": "Is Flow Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields3": {
        "main": [
          [
            {
              "node": "Compliance Info Post",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Whatsapp Bot Webhook1": {
        "main": [
          [
            {
              "node": "Check webhook configure parameter1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Filter1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check webhook configure parameter1": {
        "main": [
          [
            {
              "node": "Verify Webhook1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Variable1": {
        "main": [
          [
            {
              "node": "HTTP Request1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter1": {
        "main": [
          [
            {
              "node": "Add this Variable1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch2": {
        "main": [
          [
            {
              "node": "Edit Fields5",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get row(s) in sheet6",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "FAQ msg1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Cancel Msg1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get row(s) in sheet5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Interative Type Route1": {
        "main": [
          [
            {
              "node": "Switch2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet5": {
        "main": [
          [
            {
              "node": "mapping_item2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "mapping_item2": {
        "main": [
          [
            {
              "node": "Send Multi Product Template1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Message Type Routing1": {
        "main": [
          [
            {
              "node": "Interative Type Route1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Set Variable3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Set Variable1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Stock data1": {
        "main": [
          [
            {
              "node": "Code in JavaScript3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript3": {
        "main": [
          [
            {
              "node": "If Stock is available1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Error message1": {
        "main": [
          [
            {
              "node": "Send msg3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Succes Msg1": {
        "main": [
          [
            {
              "node": "Edit Fields4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send msg3": {
        "main": [
          [
            {
              "node": "Get row(s) in sheet5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Variable3": {
        "main": [
          [
            {
              "node": "Get Stock data1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert row1": {
        "main": [
          [
            {
              "node": "Limit2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields4": {
        "main": [
          [
            {
              "node": "Split Out1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Split Out1": {
        "main": [
          [
            {
              "node": "Code in JavaScript4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields5": {
        "main": [
          [
            {
              "node": "Get row(s)1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Append row in sheet3": {
        "main": [
          [
            {
              "node": "Limit3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s)1": {
        "main": [
          [
            {
              "node": "Append row in sheet3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If Stock is available1": {
        "main": [
          [
            {
              "node": "Error message1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Succes Msg1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Limit2": {
        "main": [
          [
            {
              "node": "HTTP Request3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript4": {
        "main": [
          [
            {
              "node": "Insert row1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Limit3": {
        "main": [
          [
            {
              "node": "Send msg4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get row(s) in sheet6": {
        "main": [
          [
            {
              "node": "Code in JavaScript5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript5": {
        "main": [
          [
            {
              "node": "Send msg5",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add this Variable1": {
        "main": [
          [
            {
              "node": "Message Type Routing1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript6": {
        "main": [
          [
            {
              "node": "Send Multi Product Category",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "set_variable": {
        "main": [
          [
            {
              "node": "Code in JavaScript7",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Normal Message3": {
        "main": [
          [
            {
              "node": "Set Public & Private Key",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript7": {
        "main": [
          [
            {
              "node": "Send Normal Message3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Private Key": {
        "main": [
          [
            {
              "node": "Decryption",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Encryption": {
        "main": [
          [
            {
              "node": "Response to Meta",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Screen Routing": {
        "main": [
          [
            {
              "node": "Get Servicable Pincode",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Add User Info1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch3": {
        "main": [
          [
            {
              "node": "Health Check",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Init Screen &data",
              "type": "main",
              "index": 0
            }
          ],
          [],
          [
            {
              "node": "Screen Routing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Decryption": {
        "main": [
          [
            {
              "node": "Switch3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Pincode": {
        "main": [
          [
            {
              "node": "Pincode Routing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Servicable Pincode": {
        "main": [
          [
            {
              "node": "Check Pincode",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pincode Routing": {
        "main": [
          [
            {
              "node": "Add User Info",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Not deliverable Screen",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Not deliverable Screen": {
        "main": [
          [
            {
              "node": "Common Meta vari",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Address Screen": {
        "main": [
          [
            {
              "node": "Common Meta vari",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add User Info": {
        "main": [
          [
            {
              "node": "Get address data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add User Info1": {
        "main": [
          [
            {
              "node": "Thank you Screen",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Health Check": {
        "main": [
          [
            {
              "node": "Common Meta vari",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Init Screen &data": {
        "main": [
          [
            {
              "node": "Common Meta vari",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is Flow Response": {
        "main": [
          [
            {
              "node": "Get Private Key",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Give meta 200 Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch User Info": {
        "main": [
          [
            {
              "node": "Is User First Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is User First Time": {
        "main": [
          [
            {
              "node": "Send User Info Flow",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Ask User to Update Info",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch User Info1": {
        "main": [
          [
            {
              "node": "Update User Info",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Response to Meta": {
        "main": [
          []
        ]
      },
      "Common Meta vari": {
        "main": [
          [
            {
              "node": "Encryption",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If Stock is not available": {
        "main": [
          [
            {
              "node": "Error message",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Succes Msg",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get address data": {
        "main": [
          [
            {
              "node": "Is address added",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is address added": {
        "main": [
          [
            {
              "node": "Address with Payload",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Address Screen",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Address with Payload": {
        "main": [
          [
            {
              "node": "Common Meta vari",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Thank you Screen": {
        "main": [
          [
            {
              "node": "Common Meta vari",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter2": {
        "main": [
          [
            {
              "node": "Get row(s) in sheet3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent": {
        "main": [
          [
            {
              "node": "Code in JavaScript9",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript9": {
        "main": [
          [
            {
              "node": "If Greeting",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If Greeting": {
        "main": [
          [
            {
              "node": "Initial Btn Msg",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Typing Indicator",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent1",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Simple Memory": {
        "ai_memory": [
          [
            {
              "node": "AI Agent1",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent1": {
        "main": [
          [
            {
              "node": "Send msg6",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Typing Indicator": {
        "main": [
          [
            {
              "node": "AI Agent1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If": {
        "main": [
          [
            {
              "node": "No Order Msg",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Code in JavaScript2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Search by Message ID": {
        "main": [
          [
            {
              "node": "Filter",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Common Variable": {
        "main": [
          [
            {
              "node": "Search by Message ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Initial Btn Msg": {
        "main": [
          [
            {
              "node": "Execution Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Give meta 200 Success": {
        "main": [
          [
            {
              "node": "Message Type Routing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is Greeting Message": {
        "main": [
          [
            {
              "node": "Initial Btn Msg",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "AI Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Flow Response": {
        "main": [
          [
            {
              "node": "Is User Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is User Response": {
        "main": [
          [
            {
              "node": "Add User Feedback to Sheet",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Filter2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Add User Feedback to Sheet": {
        "main": [
          [
            {
              "node": "Send Main Menu",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Loop Over Items": {
        "main": [
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send Order Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Order Status": {
        "main": [
          [
            {
              "node": "Loop Over Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "No Operation, do nothing": {
        "main": [
          [
            {
              "node": "Limit4",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Limit4": {
        "main": [
          [
            {
              "node": "Send Main Menu Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Lakshit Ukani",
    "name": "Version v4",
    "description": "",
    "autosaved": true
  },
  "tags": [
    {
      "updatedAt": "2025-11-14T10:19:51.673Z",
      "createdAt": "2025-11-14T10:19:51.673Z",
      "id": "ZeV32hHhoNphIlCK",
      "name": "mayank"
    }
  ]
}